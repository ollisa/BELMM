---
title: "BELMM R file; Results and summary"
output:
  html_notebook: default
  pdf_document: default
editor_options:
  chunk_output_type: inline
  keep_md: yes
---


```{r,eval=FALSE,include=TRUE}
####functions block
###  https://stackoverflow.com/questions/10296866/finding-the-column-number-and-value-the-of-second-highest-value-in-a-row
maxn <- function(n) function(x) order(x, decreasing = TRUE)[n]
max1 <- maxn(1)

###https://github.com/skgrange/threadr/blob/master/R/write_json.R
write_json <- function(x, file, pretty = TRUE, na = FALSE, auto_unbox = FALSE) {
  
  # Factor vector
  if ("factor" %in% class(x)) x <- as.character(x)
  
  # Factors within data frame
  if (any(grepl("data.frame", class(x)))) {
    
    # Make factors strings
    index_factor <- sapply(x, is.factor)
    x[index_factor] <- lapply(x[index_factor], as.character)
    
  }
  
  # Make JSON object
  if (na) {
    
    # Keep NAs, but make them null
    json <- jsonlite::toJSON(
      x, 
      pretty = pretty, 
      na = "null", 
      null = "null",
      auto_unbox = auto_unbox
    )
    
  } else {
    
    # Drop NAs
    json <- jsonlite::toJSON(x, pretty = pretty, auto_unbox = auto_unbox)
    
  }
  
  # Write JSON to disk
  write(json, file)
  
  return(invisible(x))
  
}

#function for calculating median squared error for the estimated centers
center_mse <- function(centers,estimates){
  X <- list()
  for (i in 1:ncol(centers)) {
    X[[i]] <- apply(estimates,2,function(x) median((x-centers[,i])^2) )
  }
  return(X)
}
```


```{r,eval=FALSE,include=TRUE}
library(rjson)
library(rstantools)
```

## 1.Simulated data sets
1.TMixClust toydata

```{r,eval=FALSE,include=TRUE}
data <- as.list(fromJSON(file="~/results/tmix_normal_order_15k/data/data.json"))
series <- t(matrix(unlist(data$z),ncol = 6, nrow = 91))
png(file ="./figures/figure1-0.png") #, width = 7, height = 5
ts.plot(series, main="TMixClust Toydata")
dev.off()
```
FIGURE 1.0:

1.1 Normal random walk smoothing model

```{r,eval=FALSE,include=TRUE}
data1 <- read.csv("~/results/tmix_normal_order_15k/goldStandardChains/2/2GSC1.csv")
data2 <- read.csv("~/results/tmix_normal_order_15k/goldStandardChains/3/3GSC1.csv")
data3 <- read.csv("~/results/tmix_normal_order_15k/goldStandardChains/4/4GSC1.csv")
```

```{r,eval=FALSE,include=TRUE}
fit1_means <- apply(data1,2,mean)
fit2_means <- apply(data2,2,mean)
fit3_means <- apply(data3,2,mean)

l1 <- paste('l.1.',1:6,sep='')
l2 <- paste('l.2.',1:6,sep='')
l3 <- paste('l.3.',1:6,sep='')
l4 <- paste('l.4.',1:6,sep='')
```

```{r,eval=FALSE,include=TRUE}
png(file ="./figures/figure1-1.png",width = 1440 )

par(mfrow=c(1,3),mar=c(5.1, 4.1, 4.1, 2.1))

L2_1 <- fit1_means[l1]
L2_2 <- fit1_means[l2]

ts.plot(series,col="gray",main = "2",xlab="Time")
lines(1:6,L2_1,"l",col="red")
lines(1:6,L2_2,"l",col="green")

L3_1 <- fit2_means[l1]
L3_2 <- fit2_means[l2]
L3_3 <- fit2_means[l3]

ts.plot(series,col="gray",main = "3")
lines(1:6,L3_1,"l",col="red")
lines(1:6,L3_2,"l",col="green")
lines(1:6,L3_3,"l",col="blue")

L4_1 <- fit3_means[l1]
L4_2 <- fit3_means[l2]
L4_3 <- fit3_means[l3]
L4_4 <- fit3_means[l4]

ts.plot(series,col="gray",main = "4")
lines(1:6,L4_1,"l",col="red")
lines(1:6,L4_2,"l",col="green")
lines(1:6,L4_3,"l",col="blue")
lines(1:6,L4_4,"l",col="purple")

dev.off()
```
FIGURE 1.1:

```{r,eval=FALSE,include=TRUE}
png(file ="./figures/figure1-2.png",width = 1440 )

par(mfrow=c(1,3))

dist_to_L2_1 <- c()
for (i in 1:ncol(series)) {
  dist_to_L2_1[i] <- fit1_means["theta.1"]/sqrt(fit1_means["epsilon.1"])*exp(-0.5*(sum((L2_1 - series[,i])^2))/fit1_means["epsilon.1"])
}
dist_to_L2_2 <- c()
for (i in 1:ncol(series)) {
  dist_to_L2_2[i] <- fit1_means["theta.2"]/sqrt(fit1_means["epsilon.2"])*exp(-0.5*(sum((L2_2 - series[,i])^2))/fit1_means["epsilon.2"])
}

Ldist2 <- data.frame(dist_to_L2_1,dist_to_L2_2)
assignments2 <- c(apply(Ldist2,1,max1))

plot(1:nrow(series),series[,1],type = "l",col=assignments2[1],xlab = "Time",ylab = "",ylim = c(-310,125),main = "2")
for (i in 1:ncol(series)) {
  lines(1:nrow(series),series[,i],type = "l",col=assignments2[i])}

dist_to_L3_1 <- c()
for (i in 1:ncol(series)) {
  dist_to_L3_1[i] <- fit2_means["theta.1"]/sqrt(fit2_means["epsilon.1"])*exp(-0.5*(sum((L3_1 - series[,i])^2))/fit2_means["epsilon.1"])
}
dist_to_L3_2 <- c()
for (i in 1:ncol(series)) {
  dist_to_L3_2[i] <- fit2_means["theta.2"]/sqrt(fit2_means["epsilon.2"])*exp(-0.5*(sum((L3_2 - series[,i])^2))/fit2_means["epsilon.2"])
}
dist_to_L3_3 <- c()
for (i in 1:ncol(series)) {
  dist_to_L3_3[i] <- fit2_means["theta.3"]/sqrt(fit2_means["epsilon.3"])*exp(-0.5*(sum((L3_3 - series[,i])^2))/fit2_means["epsilon.3"])
}

Ldist3 <- data.frame(dist_to_L3_1,dist_to_L3_2,dist_to_L3_3)
assignments3 <- c(apply(Ldist3,1,max1))

plot(1:nrow(series),series[,1],type = "l",col=assignments3[1],xlab = "Time",ylab = "",ylim = c(-310,125),main = "3")
for (i in 1:ncol(series)) {
  lines(1:nrow(series),series[,i],type = "l",col=assignments3[i])
}

dist_to_L4_1 <- c()
for (i in 1:ncol(series)) {
  dist_to_L4_1[i] <- fit3_means["theta.1"]/sqrt(fit3_means["epsilon.1"])*exp(-0.5*(sum((L4_1 - series[,i])^2))/fit3_means["epsilon.1"])
}
dist_to_L4_2 <- c()
for (i in 1:ncol(series)) {
  dist_to_L4_2[i] <- fit3_means["theta.2"]/sqrt(fit3_means["epsilon.2"])*exp(-0.5*(sum((L4_2 - series[,i])^2))/fit3_means["epsilon.2"])
}
dist_to_L4_3 <- c()
for (i in 1:ncol(series)) {
  dist_to_L4_3[i] <- fit3_means["theta.3"]/sqrt(fit3_means["epsilon.3"])*exp(-0.5*(sum((L4_3 - series[,i])^2))/fit3_means["epsilon.3"])
}
dist_to_L4_4 <- c()
for (i in 1:ncol(series)) {
  dist_to_L4_4[i] <- fit3_means["theta.4"]/sqrt(fit3_means["epsilon.4"])*exp(-0.5*(sum((L4_4 - series[,i])^2))/fit3_means["epsilon.4"])
}

Ldist4 <- data.frame(dist_to_L3_1,dist_to_L3_2,dist_to_L3_3,dist_to_L4_4)
assignments4 <- c(apply(Ldist4,1,max1))

plot(1:nrow(series),series[,1],type = "l",col=assignments4[1],xlab = "Time",ylab = "",ylim = c(-310,125),main = "4")
for (i in 1:ncol(series)) {
  lines(1:nrow(series),series[,i],type = "l",col=assignments4[i])
}

dev.off()
```
FIGURE 1.2:

```{r,echo=TRUE}
round(table(assignments2)/91,5);round(fit1_means[c("theta.1","theta.2")],5)
round(table(assignments3)/91,5);round(fit2_means[c("theta.1","theta.2","theta.3")],5)
round(table(assignments4)/91,5);round(fit3_means[c("theta.1","theta.2","theta.3","theta.4")],5)
```
|                  	| K 	| Theta.1 	| Theta.2 	| Theta.3 	| Theta.4 	|
|------------------	|:-:	|:-------:	|:-------:	|:-------:	|:-------:	|
| Estimates        	| 2 	| 0.65666 	| 0.34334 	|         	|         	|
|                  	| 3 	| 0.33003 	| 0.33995 	| 0.33002 	|         	|
|                  	| 4 	| 0.32760 	| 0.33570 	| 0.21371 	| 0.12299 	|
|                  	|   	|         	|         	|         	|         	|
| After assignment 	| 2 	| 0.65934 	| 0.34066 	|         	|         	|
|                  	| 3 	| 0.32967 	| 0.34066 	| 0.32967 	|         	|
|                  	| 4 	| 0.32967 	| 0.34066 	| 0.32967 	|    0    	|

```{r,eval=FALSE,include=TRUE}
png(file ="./figures/figure1-3.png",width = 960 )
par(mfrow=c(1,2))
modelindex1 <- read.csv("~/results/tmix_normal_order_15k/modelSelection/modelIndexChain1.csv")
rate <- table(modelindex1[15000:30000,1])/15000
r_model_posterior <- c(0.1482000,0.3354667+0.5163333,0)

barplot(rate, main = "Model posterior distribution",names.arg = c(2,3,4),xlab = "Model number" ,space = 0)
barplot(r_model_posterior, main = "Rectified model posterior distribution",names.arg = c(2,3,4),xlab = "Number clusters" ,space = 0)
dev.off()
```
FIGURE 1.3:

1.2. Smoothing distribution comparison

```{r,eval=FALSE,include=TRUE}
data1 <- read.csv("~/results/tmixclust_esim_rw_comparison_5k/goldStandardChains/Normal/NormalGSC1.csv")
data2 <- read.csv("~/results/tmixclust_esim_rw_comparison_5k/goldStandardChains/Cauchy/CauchyGSC1.csv")
data3 <- read.csv("~/results/tmixclust_esim_rw_comparison_5k/goldStandardChains/Laplace/LaplaceGSC1.csv")
data4 <- read.csv("~/results/tmixclust_esim_rw_comparison_5k/goldStandardChains/Student/StudentGSC1.csv")

```

```{r,eval=FALSE,include=TRUE}
fit1_means <- apply(data1,2,median)
fit2_means <- apply(data2,2,median)
fit3_means <- apply(data3,2,median)
fit4_means <- apply(data4,2,median)

l1 <- paste('l.1.',1:6,sep='')
l2 <- paste('l.2.',1:6,sep='')
l3 <- paste('l.3.',1:6,sep='')
l4 <- paste('l.4.',1:6,sep='')
```

```{r,eval=FALSE,include=TRUE}
LN_1 <- fit1_means[l1]
LN_2 <- fit1_means[l2]
LN_3 <- fit1_means[l3]

LC_1 <- fit2_means[l1]
LC_2 <- fit2_means[l2]
LC_3 <- fit2_means[l3]

LL_1 <- fit3_means[l1]
LL_2 <- fit3_means[l2]
LL_3 <- fit3_means[l3]

LS_1 <- fit4_means[l1]
LS_2 <- fit4_means[l2]
LS_3 <- fit4_means[l3]

png(file ="./figures/figure1-4.png",width = 480 )
ts.plot(series,col="gray",main = "Smoothing distribution comparison")
lines(1:6,LN_1,"b",col="red")
lines(1:6,LN_2,"b",col="red")
lines(1:6,LN_3,"b",col="red")
lines(1:6,LC_1,"b",col="blue")
lines(1:6,LC_2,"b",col="blue")
lines(1:6,LC_3,"b",col="blue")
lines(1:6,LL_1,"b",col="green")
lines(1:6,LL_2,"b",col="green")
lines(1:6,LL_3,"b",col="green")
lines(1:6,LS_1,"b",col="purple")
lines(1:6,LS_2,"b",col="purple")
lines(1:6,LS_3,"b",col="purple")
dev.off()
```

```{r,eval=FALSE,include=TRUE}

modelindex1 <- read.csv("~/results/tmixclust_esim_rw_comparison_5k/modelSelection/modelIndexChain1.csv")
rate <- table(modelindex1[5001:10000,1])/5000

png(file ="./figures/figure1-5.png",width = 480 )
barplot(rate, main = "Model posterior distribution",names.arg = c("Cauchy","Laplace","Normal","Student's t"),xlab = "Model" ,space = 0)
dev.off()
```

1.3. Smoothing distribution of AR1-based random walk

```{r,eval=FALSE,include=TRUE}
data1 <- read.csv("~/results/tmixclust_esim_ar_comparison_5k/goldStandardChains/Normal/NormalGSC1.csv")
data2 <- read.csv("~/results/tmixclust_esim_ar_comparison_5k/goldStandardChains/Cauchy/CauchyGSC1.csv")
data3 <- read.csv("~/results/tmixclust_esim_ar_comparison_5k/goldStandardChains/Laplace/LaplaceGSC1.csv")
data4 <- read.csv("~/results/tmixclust_esim_ar_comparison_5k/goldStandardChains/Student/StudentGSC1.csv")
```

```{r,eval=FALSE,include=TRUE}
fit1_means <- apply(data1,2,median)
fit2_means <- apply(data2,2,median)
fit3_means <- apply(data3,2,median)
fit4_means <- apply(data4,2,median)

phi0 <- paste('phi0.',1:3,sep='')
phi1 <- paste('phi1.',1:3,sep='')

LN_phi0 <- fit1_means[phi0]
LN_phi1 <- fit1_means[phi1]

LN_ar <- matrix(data=c(LN_phi0,rep(NA,15)),3,6)
for (i in 1:3) {
for (j in 2:6) {
  LN_ar[i,j] <- LN_ar[i,1] + LN_phi1[i] * LN_ar[i,j-1]
}
}  

LC_phi0 <- fit2_means[phi0]
LC_phi1 <- fit2_means[phi1]

LC_ar <- matrix(data=c(LC_phi0,rep(NA,15)),3,6)
for (i in 1:3) {
for (j in 2:6) {
  LC_ar[i,j] <- LC_ar[i,1] + LC_phi1[i] * LC_ar[i,j-1]
}
}  

LL_phi0 <- fit3_means[phi0]
LL_phi1 <- fit3_means[phi1]

LL_ar <- matrix(data=c(LL_phi0,rep(NA,15)),3,6)
for (i in 1:3) {
for (j in 2:6) {
  LL_ar[i,j] <- LL_ar[i,1] + LL_phi1[i] * LL_ar[i,j-1]
}
}  

LS_phi0 <- fit4_means[phi0]
LS_phi1 <- fit4_means[phi1]

LS_ar <- matrix(data=c(LS_phi0,rep(NA,15)),3,6)
for (i in 1:3) {
for (j in 2:6) {
  LS_ar[i,j] <- LS_ar[i,1] + LS_phi1[i] * LS_ar[i,j-1]
}
}  

png(file ="./figures/figure1-6.png",width = 480 )
ts.plot(series,col="gray",main = "Smoothing distribution comparison (AR1-mean)")
lines(1:6,LN_ar[1,],"b",col="red")
lines(1:6,LN_ar[2,],"b",col="red")
lines(1:6,LN_ar[3,],"b",col="red")
lines(1:6,LC_ar[1,],"b",col="blue")
lines(1:6,LC_ar[2,],"b",col="blue")
lines(1:6,LC_ar[3,],"b",col="blue")
lines(1:6,LL_ar[1,],"b",col="green")
lines(1:6,LL_ar[2,],"b",col="green")
lines(1:6,LL_ar[3,],"b",col="green")
lines(1:6,LS_ar[1,],"b",col="purple")
lines(1:6,LS_ar[2,],"b",col="purple")
lines(1:6,LS_ar[3,],"b",col="purple")
dev.off()
```

```{r,eval=FALSE,include=TRUE}

modelindex1 <- read.csv("~/results/tmixclust_esim_ar_comparison_5k/modelSelection/modelIndexChain1.csv")
rate <- table(modelindex1[5001:10000,1])/5000
png(file ="./figures/figure1-7.png",width = 480 )
barplot(rate, main = "Model posterior distribution",names.arg = c("Cauchy","Laplace","Normal","Student's t"),xlab = "Model" ,space = 0)
dev.off()
```

TMixclust (for comparison)

```{r,eval=FALSE,include=TRUE}
series_t <- t(series)
set.seed(12345)
samplingfunction<-function(x){
  if (x==1) res<-TMixClust::TMixClust(series_t, nb_clusters = 2)
  else if (x==2) TMixClust::TMixClust(series_t, nb_clusters = 3)
  else if (x==3) TMixClust::TMixClust(series_t, nb_clusters = 4)
  else if (x==4) TMixClust::TMixClust(series_t, nb_clusters = 5)
  else if (x==5) TMixClust::TMixClust(series_t, nb_clusters = 6)
}

cl <- parallel::makeCluster(3)
parallel::clusterExport(cl,c('series_t'))
out_tmix1 <- parallel::parLapply(cl, c(1:3),samplingfunction)

```

```{r,eval=FALSE,include=TRUE}

png(file ="./figures/figure1-8.png",width = 1440 )
par(mfrow=c(1,3))
ts.plot(series, col= out_tmix1[[1]]$em_cluster_assignment,main="2")
ts.plot(series, col= out_tmix1[[2]]$em_cluster_assignment,main="3")
ts.plot(series, col= out_tmix1[[3]]$em_cluster_assignment,main="4")

dev.off()

round(table(out_tmix1[[1]]$em_cluster_assignment)/91,5)
round(table(out_tmix1[[2]]$em_cluster_assignment)/91,5)
round(table(out_tmix1[[3]]$em_cluster_assignment)/91,5)

```
|                  	| K 	| Theta.1 	| Theta.2 	| Theta.3 	| Theta.4 	|
|------------------	|:-:	|:-------:	|:-------:	|:-------:	|:-------:	|
| Estimates        	| 2 	| 0.65934 	| 0.34066 	|         	|         	|
|                  	| 3 	| 0.34066 	| 0.32967 	| 0.32967 	|         	|
|                  	| 4 	| 0.16484 	| 0.32967 	| 0.17582 	| 0.32967 	|


2. Simulated data sets with varying number of components

```{r,eval=FALSE,include=TRUE}
set.seed(12345)
x <- seq(0,2*pi,0.1)

#1
Z1 <- matrix(NA,100,63)

n=1
while (n <=100) {
  Z1[n,] = 2*sin(x+rnorm(63,0,.25))+rnorm(63,0,.25)
  n=n+1
}

series1 <- t(Z1)

#2
Z2 <- matrix(NA,100,63)
Z2_true <- rep(NA,100)
n=1
while (n <=100) {
  U=runif(1)
  if(U<.33){
    Z2[n,] = 2*sin(x+rnorm(63,0,.25))+rnorm(63,0,.25)
    Z2_true[n] = 1
  }else{
    Z2[n,] = 2*cos(x+rnorm(63,0,.25))+rnorm(63,0,.5)
    Z2_true[n] = 2
  }  
  n=n+1
}

series2 <- t(Z2)

#3
Z3 <- matrix(NA,100,63)
Z3_true <- rep(NA,100)
n=1
while (n <=100) {
  U=runif(1)
  if(U<.33){
    Z3[n,] = 2*sin(x+rnorm(63,0,.25))+rnorm(63,0,.25)
    Z3_true[n] = 1
  }else if(U<.66){
    Z3[n,] = 2*cos(x+rnorm(63,0,.25))+rnorm(63,0,.5)
    Z3_true[n] = 2
  }else{
    Z3[n,] = sqrt(3+ 2*(x+rnorm(63,0,.1))) +rnorm(63,0,0.5)
    Z3_true[n] = 3
  }  
  n=n+1
}

series3 <- t(Z3)

#4
Z4 <- matrix(NA,100,63)
Z4_true <- rep(NA,100)
n=1
while (n <=100) {
  U=runif(1)
  if(U<.33){
    Z4[n,] = 2*sin(x+rnorm(63,0,.25))+rnorm(63,0,.25)
    Z4_true[n] = 1
  }else if(U<.66){
    Z4[n,] = 2*cos(x+rnorm(63,0,.25))+rnorm(63,0,.5)
    Z4_true[n] = 2
  }else if(U<.85){
    Z4[n,] = sqrt(3+ 2*(x+rnorm(63,0,.1))) +rnorm(63,0,0.5)
    Z4_true[n] = 3
  }else{
    Z4[n,] = -0.5-x*sin(x) +rnorm(63,0,0.25)
    Z4_true[n] = 4
  }  
  n=n+1
}

series4 <- t(Z4)

#5
Z5 <- matrix(NA,100,63)
Z5_true <- rep(NA,100)
n=1
while (n <=100) {
  U=runif(1)
  if(U<.33){
    Z5[n,] = 2*sin(x+rnorm(63,0,.25))+rnorm(63,0,.25)
    Z5_true[n] = 1
  }else if(U<.66){
    Z5[n,] = 2*cos(x+rnorm(63,0,.25))+rnorm(63,0,.5)
    Z5_true[n] = 2
  }else if(U<.85){
    Z5[n,] = sqrt(3+ 2*(x+rnorm(63,0,.1))) +rnorm(63,0,0.5)
    Z5_true[n] = 3
  }else if(U<.95){
    Z5[n,] = -0.5-x*sin(x) +rnorm(63,0,0.25)
    Z5_true[n] = 4
  }else{
    Z5[n,] = rep(8,63)+rnorm(63,0,0.5)
    Z5_true[n] = 5
  }  
  n=n+1
}

series5 <- t(Z5)
```


2.1 Single component
```{r,eval=FALSE,include=TRUE}

data <- as.list(fromJSON(file="~/results/8_mallia_1_10k/data/data.json"))
series <- t(matrix(unlist(data$z),ncol = 63, nrow = 100))
png(file ="./figures/figure2-0.png",width = 480 )
ts.plot(series,ylim=c(-5,8),main="Simulated data, 1 component")
dev.off()
```

```{r,eval=FALSE,include=TRUE}
data1 <- read.csv("~/results/8_mallia_1_10k/goldStandardChains/1/1GSC1.csv")
data2 <- read.csv("~/results/8_mallia_1_10k/goldStandardChains/2/2GSC1.csv")
data3 <- read.csv("~/results/8_mallia_1_10k/goldStandardChains/3/3GSC1.csv")
data4 <- read.csv("~/results/8_mallia_1_10k/goldStandardChains/4/4GSC1.csv")
data5 <- read.csv("~/results/8_mallia_1_10k/goldStandardChains/5/5GSC1.csv")
data6 <- read.csv("~/results/8_mallia_1_10k/goldStandardChains/6/6GSC1.csv")
data7 <- read.csv("~/results/8_mallia_1_10k/goldStandardChains/7/7GSC1.csv")
data8 <- read.csv("~/results/8_mallia_1_10k/goldStandardChains/8/8GSC1.csv")

fit1_means <- apply(data1,2,median)
fit2_means <- apply(data2,2,median)
fit3_means <- apply(data3,2,median)
fit4_means <- apply(data4,2,median)
fit5_means <- apply(data5,2,median)
fit6_means <- apply(data6,2,median)
fit7_means <- apply(data7,2,median)
fit8_means <- apply(data8,2,median)

l1_1 <- paste('l.',1:63,sep='')
l1 <- paste('l.1.',1:63,sep='')
l2 <- paste('l.2.',1:63,sep='')
l3 <- paste('l.3.',1:63,sep='')
l4 <- paste('l.4.',1:63,sep='')
l5 <- paste('l.5.',1:63,sep='')
l6 <- paste('l.6.',1:63,sep='')
l7 <- paste('l.7.',1:63,sep='')
l8 <- paste('l.8.',1:63,sep='')
```

```{r,eval=FALSE,include=TRUE}

png(file ="./figures/figure2-1.png",width = 1440,height = 960 )
par(mfrow=c(2,4))

#1
L1_1 <-fit1_means[l1_1]

ts.plot(series, col="gray",ylim=c(-8,10),main="1")


lines(1:63,L1_1,"l",col="red", lwd=2 ,lty=4)

#2
L2_1 <- fit2_means[l1]
L2_2 <- fit2_means[l2]

ts.plot(series, col="gray",ylim=c(-8,10),main="2")
lines(1:63,L2_1,"l",col="red", lwd=2 ,lty=4)
lines(1:63,L2_2,"l",col="blue", lwd=2 ,lty=4)

#3
L3_1 <- fit3_means[l1]
L3_2 <- fit3_means[l2]
L3_3 <- fit3_means[l3]

ts.plot(series, col="gray",ylim=c(-8,10),main="3")
lines(1:63,L3_1,"l",col="red", lwd=2 ,lty=4)
lines(1:63,L3_2,"l",col="blue", lwd=2 ,lty=4)
lines(1:63,L3_3,"l",col="black", lwd=2 ,lty=4)

#4
L4_1 <- fit4_means[l1]
L4_2 <- fit4_means[l2]
L4_3 <- fit4_means[l3]
L4_4 <- fit4_means[l4]

ts.plot(series, col="gray",ylim=c(-8,10),main="4")
lines(1:63,L4_1,"l",col="red", lwd=2 ,lty=4)
lines(1:63,L4_2,"l",col="blue", lwd=2 ,lty=4)
lines(1:63,L4_3,"l",col="black", lwd=2 ,lty=4)
lines(1:63,L4_4,"l",col="purple", lwd=2 ,lty=4)

#5
L5_1 <- fit5_means[l1]
L5_2 <- fit5_means[l2]
L5_3 <- fit5_means[l3]
L5_4 <- fit5_means[l4]
L5_5 <- fit5_means[l5]

ts.plot(series, col="gray",ylim=c(-8,10),main="5")
lines(1:63,L5_1,"l",col="red", lwd=2 ,lty=4)
lines(1:63,L5_2,"l",col="blue", lwd=2 ,lty=4)
lines(1:63,L5_3,"l",col="black", lwd=2 ,lty=4)
lines(1:63,L5_4,"l",col="purple", lwd=2 ,lty=4)
lines(1:63,L5_5,"l",col="green", lwd=2 ,lty=4)

#6
L6_1 <- fit6_means[l1]
L6_2 <- fit6_means[l2]
L6_3 <- fit6_means[l3]
L6_4 <- fit6_means[l4]
L6_5 <- fit6_means[l5]
L6_6 <- fit6_means[l6]

ts.plot(series, col="gray",ylim=c(-8,10),main="6")
lines(1:63,L6_1,"l",col="red", lwd=2 ,lty=4)
lines(1:63,L6_2,"l",col="blue", lwd=2 ,lty=4)
lines(1:63,L6_3,"l",col="black", lwd=2 ,lty=4)
lines(1:63,L6_4,"l",col="purple", lwd=2 ,lty=4)
lines(1:63,L6_5,"l",col="green", lwd=2 ,lty=4)
lines(1:63,L6_6,"l",col="cyan", lwd=2 ,lty=4)

#7
L7_1 <- fit7_means[l1]
L7_2 <- fit7_means[l2]
L7_3 <- fit7_means[l3]
L7_4 <- fit7_means[l4]
L7_5 <- fit7_means[l5]
L7_6 <- fit7_means[l6]
L7_7 <- fit7_means[l7]

ts.plot(series, col="gray",ylim=c(-8,10),main="7")
lines(1:63,L7_1,"l",col="red", lwd=2 ,lty=4)
lines(1:63,L7_2,"l",col="blue", lwd=2 ,lty=4)
lines(1:63,L7_3,"l",col="black", lwd=2 ,lty=4)
lines(1:63,L7_4,"l",col="purple", lwd=2 ,lty=4)
lines(1:63,L7_5,"l",col="green", lwd=2 ,lty=4)
lines(1:63,L7_6,"l",col="cyan", lwd=2 ,lty=4)
lines(1:63,L7_7,"l",col="brown4", lwd=2 ,lty=4)

#8
L8_1 <- fit8_means[l1]
L8_2 <- fit8_means[l2]
L8_3 <- fit8_means[l3]
L8_4 <- fit8_means[l4]
L8_5 <- fit8_means[l5]
L8_6 <- fit8_means[l6]
L8_7 <- fit8_means[l7]
L8_8 <- fit8_means[l8]

ts.plot(series, col="gray",ylim=c(-8,10),main="8")
lines(1:63,L8_1,"l",col="red", lwd=2 ,lty=4)
lines(1:63,L8_2,"l",col="blue", lwd=2 ,lty=4)
lines(1:63,L8_3,"l",col="black", lwd=2 ,lty=4)
lines(1:63,L8_4,"l",col="purple", lwd=2 ,lty=4)
lines(1:63,L8_5,"l",col="green", lwd=2 ,lty=4)
lines(1:63,L8_6,"l",col="cyan", lwd=2 ,lty=4)
lines(1:63,L8_7,"l",col="brown4", lwd=2 ,lty=4)
lines(1:63,L8_8,"l",col="cornflowerblue", lwd=2 ,lty=4)

dev.off()
```

```{r,eval=FALSE,include=TRUE}
centers1 <- data.frame(L1 = 2*sin(x))
estimates1.1 <- data.frame(L1_1)
estimates1.2 <- data.frame(L2_1,L2_2)
estimates1.3 <- data.frame(L3_1,L3_2,L3_3)
estimates1.4 <- data.frame(L4_1,L4_2,L4_3,L4_4)
estimates1.5 <- data.frame(L5_1,L5_2,L5_3,L5_4,L5_5)
estimates1.6 <- data.frame(L6_1,L6_2,L6_3,L6_4,L6_5,L6_6)
estimates1.7 <- data.frame(L7_1,L7_2,L7_3,L7_4,L7_5,L7_6,L7_7)
estimates1.8 <- data.frame(L8_1,L8_2,L8_3,L8_4,L8_5,L8_6,L8_7,L8_8)

center_mse(centers1,estimates1.1)
center_mse(centers1,estimates1.2)
center_mse(centers1,estimates1.3)
center_mse(centers1,estimates1.4)
center_mse(centers1,estimates1.5)
center_mse(centers1,estimates1.6)
center_mse(centers1,estimates1.7)
center_mse(centers1,estimates1.8)

```


```{r,eval=FALSE,include=TRUE}
png(file ="./figures/figure2-2.png",width = 1440,height = 960 )
par(mfrow=c(2,4))

ts.plot(series,main="1",ylim = c(-8,10))

dist_to_L2_1 <- c()
for (i in 1:ncol(series)) {
  dist_to_L2_1[i] <- fit2_means["theta.1"]/sqrt(fit2_means["epsilon.1"])*exp(-0.5*(sum((L2_1 - series[,i])^2))/fit2_means["epsilon.1"])
}
dist_to_L2_2 <- c()
for (i in 1:ncol(series)) {
  dist_to_L2_2[i] <- fit2_means["theta.2"]/sqrt(fit2_means["epsilon.2"])*exp(-0.5*(sum((L2_2 - series[,i])^2))/fit2_means["epsilon.2"])
}

Ldist2 <- data.frame(dist_to_L2_1,dist_to_L2_2)
assignments2 <- c(apply(Ldist2,1,max1))

plot(1:nrow(series),series[,1],type = "l",col=assignments2[1],xlab = "Time",ylab = "",ylim = c(-8,10),main="2")
for (i in 1:ncol(series)) {
  lines(1:nrow(series),series[,i],type = "l",col=assignments2[i])
}

dist_to_L3_1 <- c()
for (i in 1:ncol(series)) {
  dist_to_L3_1[i] <- fit3_means["theta.1"]/sqrt(fit3_means["epsilon.1"])*exp(-0.5*(sum((L3_1 - series[,i])^2))/fit3_means["epsilon.1"])
}
dist_to_L3_2 <- c()
for (i in 1:ncol(series)) {
  dist_to_L3_2[i] <- fit3_means["theta.2"]/sqrt(fit3_means["epsilon.2"])*exp(-0.5*(sum((L3_2 - series[,i])^2))/fit3_means["epsilon.2"])
}
dist_to_L3_3 <- c()
for (i in 1:ncol(series)) {
  dist_to_L3_3[i] <- fit3_means["theta.3"]/sqrt(fit3_means["epsilon.3"])*exp(-0.5*(sum((L3_3 - series[,i])^2))/fit3_means["epsilon.3"])
}

Ldist3 <- data.frame(dist_to_L3_1,dist_to_L3_2,dist_to_L3_3)
assignments3 <- c(apply(Ldist3,1,max1))

plot(1:nrow(series),series[,1],type = "l",col=assignments3[1],xlab = "Time",ylab = "",ylim = c(-8,10),main="3")
for (i in 1:ncol(series)) {
  lines(1:nrow(series),series[,i],type = "l",col=assignments3[i])
}

dist_to_L4_1 <- c()
for (i in 1:ncol(series)) {
  dist_to_L4_1[i] <- fit4_means["theta.1"]/sqrt(fit4_means["epsilon.1"])*exp(-0.5*(sum((L4_1 - series[,i])^2))/fit4_means["epsilon.1"])
}
dist_to_L4_2 <- c()
for (i in 1:ncol(series)) {
  dist_to_L4_2[i] <- fit4_means["theta.2"]/sqrt(fit4_means["epsilon.2"])*exp(-0.5*(sum((L4_2 - series[,i])^2))/fit4_means["epsilon.2"])
}
dist_to_L4_3 <- c()
for (i in 1:ncol(series)) {
  dist_to_L4_3[i] <- fit4_means["theta.3"]/sqrt(fit4_means["epsilon.3"])*exp(-0.5*(sum((L4_3 - series[,i])^2))/fit4_means["epsilon.3"])
}
dist_to_L4_4 <- c()
for (i in 1:ncol(series)) {
  dist_to_L4_4[i] <- fit4_means["theta.4"]/sqrt(fit4_means["epsilon.4"])*exp(-0.5*(sum((L4_4 - series[,i])^2))/fit4_means["epsilon.4"])
}

Ldist4 <- data.frame(dist_to_L4_1,dist_to_L4_2,dist_to_L4_3,dist_to_L4_4)
assignments4 <- c(apply(Ldist4,1,max1))

plot(1:nrow(series),series[,1],type = "l",col=assignments4[1],xlab = "Time",ylab = "",ylim = c(-8,10),main="4")
for (i in 1:ncol(series)) {
  lines(1:nrow(series),series[,i],type = "l",col=assignments4[i])
}

dist_to_L5_1 <- c()
for (i in 1:ncol(series)) {
  dist_to_L5_1[i] <- fit5_means["theta.1"]/sqrt(fit5_means["epsilon.1"])*exp(-0.5*(sum((L5_1 - series[,i])^2))/fit5_means["epsilon.1"])
}
dist_to_L5_2 <- c()
for (i in 1:ncol(series)) {
  dist_to_L5_2[i] <- fit5_means["theta.2"]/sqrt(fit5_means["epsilon.2"])*exp(-0.5*(sum((L5_2 - series[,i])^2))/fit5_means["epsilon.2"])
}
dist_to_L5_3 <- c()
for (i in 1:ncol(series)) {
  dist_to_L5_3[i] <- fit5_means["theta.3"]/sqrt(fit5_means["epsilon.3"])*exp(-0.5*(sum((L5_3 - series[,i])^2))/fit5_means["epsilon.3"])
}
dist_to_L5_4 <- c()
for (i in 1:ncol(series)) {
  dist_to_L5_4[i] <- fit5_means["theta.4"]/sqrt(fit5_means["epsilon.4"])*exp(-0.5*(sum((L5_4 - series[,i])^2))/fit5_means["epsilon.4"])
}
dist_to_L5_5 <- c()
for (i in 1:ncol(series)) {
  dist_to_L5_5[i] <- fit5_means["theta.5"]/sqrt(fit5_means["epsilon.5"])*exp(-0.5*(sum((L5_5 - series[,i])^2))/fit5_means["epsilon.5"])
}

Ldist5 <- data.frame(dist_to_L5_1,dist_to_L5_2,dist_to_L5_3,dist_to_L5_4,dist_to_L5_5)
assignments5 <- c(apply(Ldist5,1,max1))

plot(1:nrow(series),series[,1],type = "l",col=assignments5[1],xlab = "Time",ylab = "",ylim = c(-8,10),main=5)
for (i in 1:ncol(series)) {
  lines(1:nrow(series),series[,i],type = "l",col=assignments5[i])
}

dist_to_L6_1 <- c()
for (i in 1:ncol(series)) {
  dist_to_L6_1[i] <- fit6_means["theta.1"]/sqrt(fit6_means["epsilon.1"])*exp(-0.5*(sum((L6_1 - series[,i])^2))/fit6_means["epsilon.1"])
}
dist_to_L6_2 <- c()
for (i in 1:ncol(series)) {
  dist_to_L6_2[i] <- fit6_means["theta.2"]/sqrt(fit6_means["epsilon.2"])*exp(-0.5*(sum((L6_2 - series[,i])^2))/fit6_means["epsilon.2"])
}
dist_to_L6_3 <- c()
for (i in 1:ncol(series)) {
  dist_to_L6_3[i] <- fit6_means["theta.3"]/sqrt(fit6_means["epsilon.3"])*exp(-0.5*(sum((L6_3 - series[,i])^2))/fit6_means["epsilon.3"])
}
dist_to_L6_4 <- c()
for (i in 1:ncol(series)) {
  dist_to_L6_4[i] <- fit6_means["theta.4"]/sqrt(fit6_means["epsilon.4"])*exp(-0.5*(sum((L6_4 - series[,i])^2))/fit6_means["epsilon.4"])
}
dist_to_L6_5 <- c()
for (i in 1:ncol(series)) {
  dist_to_L6_5[i] <- fit6_means["theta.5"]/sqrt(fit6_means["epsilon.5"])*exp(-0.5*(sum((L6_5 - series[,i])^2))/fit6_means["epsilon.5"])
}
dist_to_L6_6 <- c()
for (i in 1:ncol(series)) {
  dist_to_L6_6[i] <- fit6_means["theta.6"]/sqrt(fit6_means["epsilon.6"])*exp(-0.5*(sum((L6_6 - series[,i])^2))/fit6_means["epsilon.6"])
}

Ldist6 <- data.frame(dist_to_L6_1,dist_to_L6_2,dist_to_L6_3,dist_to_L6_4,dist_to_L6_5,dist_to_L6_6)
assignments6 <- c(apply(Ldist6,1,max1))

plot(1:nrow(series),series[,1],type = "l",col=assignments6[1],xlab = "Time",ylab = "",ylim = c(-8,10),main="6")
for (i in 1:ncol(series)) {
  lines(1:nrow(series),series[,i],type = "l",col=assignments6[i])
}

dist_to_L7_1 <- c()
for (i in 1:ncol(series)) {
  dist_to_L7_1[i] <- fit7_means["theta.1"]/sqrt(fit7_means["epsilon.1"])*exp(-0.5*(sum((L7_1 - series[,i])^2))/fit7_means["epsilon.1"])
}
dist_to_L7_2 <- c()
for (i in 1:ncol(series)) {
  dist_to_L7_2[i] <- fit7_means["theta.2"]/sqrt(fit7_means["epsilon.2"])*exp(-0.5*(sum((L7_2 - series[,i])^2))/fit7_means["epsilon.2"])
}
dist_to_L7_3 <- c()
for (i in 1:ncol(series)) {
  dist_to_L7_3[i] <- fit7_means["theta.3"]/sqrt(fit7_means["epsilon.3"])*exp(-0.5*(sum((L7_3 - series[,i])^2))/fit7_means["epsilon.3"])
}
dist_to_L7_4 <- c()
for (i in 1:ncol(series)) {
  dist_to_L7_4[i] <- fit7_means["theta.4"]/sqrt(fit7_means["epsilon.4"])*exp(-0.5*(sum((L7_4 - series[,i])^2))/fit7_means["epsilon.4"])
}
dist_to_L7_5 <- c()
for (i in 1:ncol(series)) {
  dist_to_L7_5[i] <- fit7_means["theta.5"]/sqrt(fit7_means["epsilon.5"])*exp(-0.5*(sum((L7_5 - series[,i])^2))/fit7_means["epsilon.5"])
}
dist_to_L7_6 <- c()
for (i in 1:ncol(series)) {
  dist_to_L7_6[i] <- fit7_means["theta.6"]/sqrt(fit7_means["epsilon.6"])*exp(-0.5*(sum((L7_6 - series[,i])^2))/fit7_means["epsilon.6"])
}
dist_to_L7_7 <- c()
for (i in 1:ncol(series)) {
  dist_to_L7_7[i] <- fit7_means["theta.7"]/sqrt(fit7_means["epsilon.7"])*exp(-0.5*(sum((L7_7 - series[,i])^2))/fit7_means["epsilon.7"])
}

Ldist7 <- data.frame(dist_to_L7_1,dist_to_L7_2,dist_to_L7_3,dist_to_L7_4,dist_to_L7_5,dist_to_L7_6,dist_to_L7_7)
assignments7 <- c(apply(Ldist7,1,max1))

plot(1:nrow(series),series[,1],type = "l",col=assignments7[1],xlab = "Time",ylab = "",ylim = c(-8,10),main="7")
for (i in 1:ncol(series)) {
  lines(1:nrow(series),series[,i],type = "l",col=assignments7[i])
}

dist_to_L8_1 <- c()
for (i in 1:ncol(series)) {
  dist_to_L8_1[i] <- fit8_means["theta.1"]/sqrt(fit8_means["epsilon.1"])*exp(-0.5*(sum((L8_1 - series[,i])^2))/fit8_means["epsilon.1"])
}
dist_to_L8_2 <- c()
for (i in 1:ncol(series)) {
  dist_to_L8_2[i] <- fit8_means["theta.2"]/sqrt(fit8_means["epsilon.2"])*exp(-0.5*(sum((L8_2 - series[,i])^2))/fit8_means["epsilon.2"])
}
dist_to_L8_3 <- c()
for (i in 1:ncol(series)) {
  dist_to_L8_3[i] <- fit8_means["theta.3"]/sqrt(fit8_means["epsilon.3"])*exp(-0.5*(sum((L8_3 - series[,i])^2))/fit8_means["epsilon.3"])
}
dist_to_L8_4 <- c()
for (i in 1:ncol(series)) {
  dist_to_L8_4[i] <- fit8_means["theta.4"]/sqrt(fit8_means["epsilon.4"])*exp(-0.5*(sum((L8_4 - series[,i])^2))/fit8_means["epsilon.4"])
}
dist_to_L8_5 <- c()
for (i in 1:ncol(series)) {
  dist_to_L8_5[i] <- fit8_means["theta.5"]/sqrt(fit8_means["epsilon.5"])*exp(-0.5*(sum((L8_5 - series[,i])^2))/fit8_means["epsilon.5"])
}
dist_to_L8_6 <- c()
for (i in 1:ncol(series)) {
  dist_to_L8_6[i] <- fit8_means["theta.6"]/sqrt(fit8_means["epsilon.6"])*exp(-0.5*(sum((L8_6 - series[,i])^2))/fit8_means["epsilon.6"])
}
dist_to_L8_7 <- c()
for (i in 1:ncol(series)) {
  dist_to_L8_7[i] <- fit8_means["theta.7"]/sqrt(fit8_means["epsilon.7"])*exp(-0.5*(sum((L8_7 - series[,i])^2))/fit8_means["epsilon.7"])
}
dist_to_L8_8 <- c()
for (i in 1:ncol(series)) {
  dist_to_L8_8[i] <- fit8_means["theta.8"]/sqrt(fit8_means["epsilon.8"])*exp(-0.5*(sum((L8_8 - series[,i])^2))/fit8_means["epsilon.8"])
}

Ldist8 <- data.frame(dist_to_L8_1,dist_to_L8_2,dist_to_L8_3,dist_to_L8_4,dist_to_L8_5,dist_to_L8_6,dist_to_L8_7,dist_to_L8_8)
assignments8 <- c(apply(Ldist8,1,max1))

plot(1:nrow(series),series[,1],type = "l",col=assignments8[1],xlab = "Time",ylab = "",ylim = c(-8,10),main="8")
for (i in 1:ncol(series)) {
  lines(1:nrow(series),series[,i],type = "l",col=assignments8[i])
}

dev.off()
```

2.2 Two components
```{r,eval=FALSE,include=TRUE}

data <- as.list(fromJSON(file="~/results/8_mallia_2_10k/data/data.json"))
series <- t(matrix(unlist(data$z),ncol = 63, nrow = 100))
png(file ="./figures/figure2-4.png",width = 480)
ts.plot(series,ylim=c(-5,8),main="Simulated data, 2 components")
dev.off()
```
```{r,eval=FALSE,include=TRUE}
data1 <- read.csv("~/results/8_mallia_2_10k/goldStandardChains/1/1GSC1.csv")
data2 <- read.csv("~/results/8_mallia_2_10k/goldStandardChains/2/2GSC1.csv")
data3 <- read.csv("~/results/8_mallia_2_10k/goldStandardChains/3/3GSC1.csv")
data4 <- read.csv("~/results/8_mallia_2_10k/goldStandardChains/4/4GSC1.csv")
data5 <- read.csv("~/results/8_mallia_2_10k/goldStandardChains/5/5GSC1.csv")
data6 <- read.csv("~/results/8_mallia_2_10k/goldStandardChains/6/6GSC1.csv")
data7 <- read.csv("~/results/8_mallia_2_10k/goldStandardChains/7/7GSC1.csv")
data8 <- read.csv("~/results/8_mallia_2_10k/goldStandardChains/8/8GSC1.csv")

fit1_means <- apply(data1,2,median)
fit2_means <- apply(data2,2,median)
fit3_means <- apply(data3,2,median)
fit4_means <- apply(data4,2,median)
fit5_means <- apply(data5,2,median)
fit6_means <- apply(data6,2,median)
fit7_means <- apply(data7,2,median)
fit8_means <- apply(data8,2,median)

l1_1 <- paste('l.',1:63,sep='')
l1 <- paste('l.1.',1:63,sep='')
l2 <- paste('l.2.',1:63,sep='')
l3 <- paste('l.3.',1:63,sep='')
l4 <- paste('l.4.',1:63,sep='')
l5 <- paste('l.5.',1:63,sep='')
l6 <- paste('l.6.',1:63,sep='')
l7 <- paste('l.7.',1:63,sep='')
l8 <- paste('l.8.',1:63,sep='')
```

```{r,eval=FALSE,include=TRUE}
png(file ="./figures/figure2-5.png",width = 1440,height = 960 )
par(mfrow=c(2,4))

#1
L1_1 <-fit1_means[l1_1]

ts.plot(series, col="gray",ylim=c(-8,10),main="1")


lines(1:63,L1_1,"l",col="red", lwd=2 ,lty=4)

#2
L2_1 <- fit2_means[l1]
L2_2 <- fit2_means[l2]

ts.plot(series, col="gray",ylim=c(-8,10),main="2")
lines(1:63,L2_1,"l",col="red", lwd=2 ,lty=4)
lines(1:63,L2_2,"l",col="blue", lwd=2 ,lty=4)

#3
L3_1 <- fit3_means[l1]
L3_2 <- fit3_means[l2]
L3_3 <- fit3_means[l3]

ts.plot(series, col="gray",ylim=c(-8,10),main="3")
lines(1:63,L3_1,"l",col="red", lwd=2 ,lty=4)
lines(1:63,L3_2,"l",col="blue", lwd=2 ,lty=4)
lines(1:63,L3_3,"l",col="black", lwd=2 ,lty=4)

#4
L4_1 <- fit4_means[l1]
L4_2 <- fit4_means[l2]
L4_3 <- fit4_means[l3]
L4_4 <- fit4_means[l4]

ts.plot(series, col="gray",ylim=c(-8,10),main="4")
lines(1:63,L4_1,"l",col="red", lwd=2 ,lty=4)
lines(1:63,L4_2,"l",col="blue", lwd=2 ,lty=4)
lines(1:63,L4_3,"l",col="black", lwd=2 ,lty=4)
lines(1:63,L4_4,"l",col="purple", lwd=2 ,lty=4)

#5
L5_1 <- fit5_means[l1]
L5_2 <- fit5_means[l2]
L5_3 <- fit5_means[l3]
L5_4 <- fit5_means[l4]
L5_5 <- fit5_means[l5]

ts.plot(series, col="gray",ylim=c(-8,10),main="5")
lines(1:63,L5_1,"l",col="red", lwd=2 ,lty=4)
lines(1:63,L5_2,"l",col="blue", lwd=2 ,lty=4)
lines(1:63,L5_3,"l",col="black", lwd=2 ,lty=4)
lines(1:63,L5_4,"l",col="purple", lwd=2 ,lty=4)
lines(1:63,L5_5,"l",col="green", lwd=2 ,lty=4)

#6
L6_1 <- fit6_means[l1]
L6_2 <- fit6_means[l2]
L6_3 <- fit6_means[l3]
L6_4 <- fit6_means[l4]
L6_5 <- fit6_means[l5]
L6_6 <- fit6_means[l6]

ts.plot(series, col="gray",ylim=c(-8,10),main="6")
lines(1:63,L6_1,"l",col="red", lwd=2 ,lty=4)
lines(1:63,L6_2,"l",col="blue", lwd=2 ,lty=4)
lines(1:63,L6_3,"l",col="black", lwd=2 ,lty=4)
lines(1:63,L6_4,"l",col="purple", lwd=2 ,lty=4)
lines(1:63,L6_5,"l",col="green", lwd=2 ,lty=4)
lines(1:63,L6_6,"l",col="cyan", lwd=2 ,lty=4)

#7
L7_1 <- fit7_means[l1]
L7_2 <- fit7_means[l2]
L7_3 <- fit7_means[l3]
L7_4 <- fit7_means[l4]
L7_5 <- fit7_means[l5]
L7_6 <- fit7_means[l6]
L7_7 <- fit7_means[l7]

ts.plot(series, col="gray",ylim=c(-8,10),main="7")
lines(1:63,L7_1,"l",col="red", lwd=2 ,lty=4)
lines(1:63,L7_2,"l",col="blue", lwd=2 ,lty=4)
lines(1:63,L7_3,"l",col="black", lwd=2 ,lty=4)
lines(1:63,L7_4,"l",col="purple", lwd=2 ,lty=4)
lines(1:63,L7_5,"l",col="green", lwd=2 ,lty=4)
lines(1:63,L7_6,"l",col="cyan", lwd=2 ,lty=4)
lines(1:63,L7_7,"l",col="brown4", lwd=2 ,lty=4)

#8
L8_1 <- fit8_means[l1]
L8_2 <- fit8_means[l2]
L8_3 <- fit8_means[l3]
L8_4 <- fit8_means[l4]
L8_5 <- fit8_means[l5]
L8_6 <- fit8_means[l6]
L8_7 <- fit8_means[l7]
L8_8 <- fit8_means[l8]

ts.plot(series, col="gray",ylim=c(-8,10),main="8")
lines(1:63,L8_1,"l",col="red", lwd=2 ,lty=4)
lines(1:63,L8_2,"l",col="blue", lwd=2 ,lty=4)
lines(1:63,L8_3,"l",col="black", lwd=2 ,lty=4)
lines(1:63,L8_4,"l",col="purple", lwd=2 ,lty=4)
lines(1:63,L8_5,"l",col="green", lwd=2 ,lty=4)
lines(1:63,L8_6,"l",col="cyan", lwd=2 ,lty=4)
lines(1:63,L8_7,"l",col="brown4", lwd=2 ,lty=4)
lines(1:63,L8_8,"l",col="cornflowerblue", lwd=2 ,lty=4)
dev.off()
```

```{r,echo=FALSE}
centers2 <- data.frame(L1 = 2*sin(x),L2 = 2*cos(x))
estimates2.1 <- data.frame(L1_1)
estimates2.2 <- data.frame(L2_1,L2_2)
estimates2.3 <- data.frame(L3_1,L3_2,L3_3)
estimates2.4 <- data.frame(L4_1,L4_2,L4_3,L4_4)
estimates2.5 <- data.frame(L5_1,L5_2,L5_3,L5_4,L5_5)
estimates2.6 <- data.frame(L6_1,L6_2,L6_3,L6_4,L6_5,L6_6)
estimates2.7 <- data.frame(L7_1,L7_2,L7_3,L7_4,L7_5,L7_6,L7_7)
estimates2.8 <- data.frame(L8_1,L8_2,L8_3,L8_4,L8_5,L8_6,L8_7,L8_8)

center_mse(centers2,estimates2.1)
center_mse(centers2,estimates2.2)
center_mse(centers2,estimates2.3)
center_mse(centers2,estimates2.4)
center_mse(centers2,estimates2.5)
center_mse(centers2,estimates2.6)
center_mse(centers2,estimates2.7)
center_mse(centers2,estimates2.8)

```

```{r,eval=FALSE,include=TRUE}
png(file ="./figures/figure2-6.png",width = 1440,height = 960 )
par(mfrow=c(2,4))

ts.plot(series,main="1",ylim = c(-8,10))

dist_to_L2_1 <- c()
for (i in 1:ncol(series)) {
  dist_to_L2_1[i] <- fit2_means["theta.1"]/sqrt(fit2_means["epsilon.1"])*exp(-0.5*(sum((L2_1 - series[,i])^2))/fit2_means["epsilon.1"])
}
dist_to_L2_2 <- c()
for (i in 1:ncol(series)) {
  dist_to_L2_2[i] <- fit2_means["theta.2"]/sqrt(fit2_means["epsilon.2"])*exp(-0.5*(sum((L2_2 - series[,i])^2))/fit2_means["epsilon.2"])
}

Ldist2 <- data.frame(dist_to_L2_1,dist_to_L2_2)
assignments2 <- c(apply(Ldist2,1,max1))

plot(1:nrow(series),series[,1],type = "l",col=assignments2[1],xlab = "Time",ylab = "",ylim = c(-8,10),main="2")
for (i in 1:ncol(series)) {
  lines(1:nrow(series),series[,i],type = "l",col=assignments2[i])
}

dist_to_L3_1 <- c()
for (i in 1:ncol(series)) {
  dist_to_L3_1[i] <- fit3_means["theta.1"]/sqrt(fit3_means["epsilon.1"])*exp(-0.5*(sum((L3_1 - series[,i])^2))/fit3_means["epsilon.1"])
}
dist_to_L3_2 <- c()
for (i in 1:ncol(series)) {
  dist_to_L3_2[i] <- fit3_means["theta.2"]/sqrt(fit3_means["epsilon.2"])*exp(-0.5*(sum((L3_2 - series[,i])^2))/fit3_means["epsilon.2"])
}
dist_to_L3_3 <- c()
for (i in 1:ncol(series)) {
  dist_to_L3_3[i] <- fit3_means["theta.3"]/sqrt(fit3_means["epsilon.3"])*exp(-0.5*(sum((L3_3 - series[,i])^2))/fit3_means["epsilon.3"])
}

Ldist3 <- data.frame(dist_to_L3_1,dist_to_L3_2,dist_to_L3_3)
assignments3 <- c(apply(Ldist3,1,max1))

plot(1:nrow(series),series[,1],type = "l",col=assignments3[1],xlab = "Time",ylab = "",ylim = c(-8,10),main="3")
for (i in 1:ncol(series)) {
  lines(1:nrow(series),series[,i],type = "l",col=assignments3[i])
}

dist_to_L4_1 <- c()
for (i in 1:ncol(series)) {
  dist_to_L4_1[i] <- fit4_means["theta.1"]/sqrt(fit4_means["epsilon.1"])*exp(-0.5*(sum((L4_1 - series[,i])^2))/fit4_means["epsilon.1"])
}
dist_to_L4_2 <- c()
for (i in 1:ncol(series)) {
  dist_to_L4_2[i] <- fit4_means["theta.2"]/sqrt(fit4_means["epsilon.2"])*exp(-0.5*(sum((L4_2 - series[,i])^2))/fit4_means["epsilon.2"])
}
dist_to_L4_3 <- c()
for (i in 1:ncol(series)) {
  dist_to_L4_3[i] <- fit4_means["theta.3"]/sqrt(fit4_means["epsilon.3"])*exp(-0.5*(sum((L4_3 - series[,i])^2))/fit4_means["epsilon.3"])
}
dist_to_L4_4 <- c()
for (i in 1:ncol(series)) {
  dist_to_L4_4[i] <- fit4_means["theta.4"]/sqrt(fit4_means["epsilon.4"])*exp(-0.5*(sum((L4_4 - series[,i])^2))/fit4_means["epsilon.4"])
}

Ldist4 <- data.frame(dist_to_L4_1,dist_to_L4_2,dist_to_L4_3,dist_to_L4_4)
assignments4 <- c(apply(Ldist4,1,max1))

plot(1:nrow(series),series[,1],type = "l",col=assignments4[1],xlab = "Time",ylab = "",ylim = c(-8,10),main="4")
for (i in 1:ncol(series)) {
  lines(1:nrow(series),series[,i],type = "l",col=assignments4[i])
}

dist_to_L5_1 <- c()
for (i in 1:ncol(series)) {
  dist_to_L5_1[i] <- fit5_means["theta.1"]/sqrt(fit5_means["epsilon.1"])*exp(-0.5*(sum((L5_1 - series[,i])^2))/fit5_means["epsilon.1"])
}
dist_to_L5_2 <- c()
for (i in 1:ncol(series)) {
  dist_to_L5_2[i] <- fit5_means["theta.2"]/sqrt(fit5_means["epsilon.2"])*exp(-0.5*(sum((L5_2 - series[,i])^2))/fit5_means["epsilon.2"])
}
dist_to_L5_3 <- c()
for (i in 1:ncol(series)) {
  dist_to_L5_3[i] <- fit5_means["theta.3"]/sqrt(fit5_means["epsilon.3"])*exp(-0.5*(sum((L5_3 - series[,i])^2))/fit5_means["epsilon.3"])
}
dist_to_L5_4 <- c()
for (i in 1:ncol(series)) {
  dist_to_L5_4[i] <- fit5_means["theta.4"]/sqrt(fit5_means["epsilon.4"])*exp(-0.5*(sum((L5_4 - series[,i])^2))/fit5_means["epsilon.4"])
}
dist_to_L5_5 <- c()
for (i in 1:ncol(series)) {
  dist_to_L5_5[i] <- fit5_means["theta.5"]/sqrt(fit5_means["epsilon.5"])*exp(-0.5*(sum((L5_5 - series[,i])^2))/fit5_means["epsilon.5"])
}

Ldist5 <- data.frame(dist_to_L5_1,dist_to_L5_2,dist_to_L5_3,dist_to_L5_4,dist_to_L5_5)
assignments5 <- c(apply(Ldist5,1,max1))

plot(1:nrow(series),series[,1],type = "l",col=assignments5[1],xlab = "Time",ylab = "",ylim = c(-8,10),main=5)
for (i in 1:ncol(series)) {
  lines(1:nrow(series),series[,i],type = "l",col=assignments5[i])
}

dist_to_L6_1 <- c()
for (i in 1:ncol(series)) {
  dist_to_L6_1[i] <- fit6_means["theta.1"]/sqrt(fit6_means["epsilon.1"])*exp(-0.5*(sum((L6_1 - series[,i])^2))/fit6_means["epsilon.1"])
}
dist_to_L6_2 <- c()
for (i in 1:ncol(series)) {
  dist_to_L6_2[i] <- fit6_means["theta.2"]/sqrt(fit6_means["epsilon.2"])*exp(-0.5*(sum((L6_2 - series[,i])^2))/fit6_means["epsilon.2"])
}
dist_to_L6_3 <- c()
for (i in 1:ncol(series)) {
  dist_to_L6_3[i] <- fit6_means["theta.3"]/sqrt(fit6_means["epsilon.3"])*exp(-0.5*(sum((L6_3 - series[,i])^2))/fit6_means["epsilon.3"])
}
dist_to_L6_4 <- c()
for (i in 1:ncol(series)) {
  dist_to_L6_4[i] <- fit6_means["theta.4"]/sqrt(fit6_means["epsilon.4"])*exp(-0.5*(sum((L6_4 - series[,i])^2))/fit6_means["epsilon.4"])
}
dist_to_L6_5 <- c()
for (i in 1:ncol(series)) {
  dist_to_L6_5[i] <- fit6_means["theta.5"]/sqrt(fit6_means["epsilon.5"])*exp(-0.5*(sum((L6_5 - series[,i])^2))/fit6_means["epsilon.5"])
}
dist_to_L6_6 <- c()
for (i in 1:ncol(series)) {
  dist_to_L6_6[i] <- fit6_means["theta.6"]/sqrt(fit6_means["epsilon.6"])*exp(-0.5*(sum((L6_6 - series[,i])^2))/fit6_means["epsilon.6"])
}

Ldist6 <- data.frame(dist_to_L6_1,dist_to_L6_2,dist_to_L6_3,dist_to_L6_4,dist_to_L6_5,dist_to_L6_6)
assignments6 <- c(apply(Ldist6,1,max1))

plot(1:nrow(series),series[,1],type = "l",col=assignments6[1],xlab = "Time",ylab = "",ylim = c(-8,10),main="6")
for (i in 1:ncol(series)) {
  lines(1:nrow(series),series[,i],type = "l",col=assignments6[i])
}

dist_to_L7_1 <- c()
for (i in 1:ncol(series)) {
  dist_to_L7_1[i] <- fit7_means["theta.1"]/sqrt(fit7_means["epsilon.1"])*exp(-0.5*(sum((L7_1 - series[,i])^2))/fit7_means["epsilon.1"])
}
dist_to_L7_2 <- c()
for (i in 1:ncol(series)) {
  dist_to_L7_2[i] <- fit7_means["theta.2"]/sqrt(fit7_means["epsilon.2"])*exp(-0.5*(sum((L7_2 - series[,i])^2))/fit7_means["epsilon.2"])
}
dist_to_L7_3 <- c()
for (i in 1:ncol(series)) {
  dist_to_L7_3[i] <- fit7_means["theta.3"]/sqrt(fit7_means["epsilon.3"])*exp(-0.5*(sum((L7_3 - series[,i])^2))/fit7_means["epsilon.3"])
}
dist_to_L7_4 <- c()
for (i in 1:ncol(series)) {
  dist_to_L7_4[i] <- fit7_means["theta.4"]/sqrt(fit7_means["epsilon.4"])*exp(-0.5*(sum((L7_4 - series[,i])^2))/fit7_means["epsilon.4"])
}
dist_to_L7_5 <- c()
for (i in 1:ncol(series)) {
  dist_to_L7_5[i] <- fit7_means["theta.5"]/sqrt(fit7_means["epsilon.5"])*exp(-0.5*(sum((L7_5 - series[,i])^2))/fit7_means["epsilon.5"])
}
dist_to_L7_6 <- c()
for (i in 1:ncol(series)) {
  dist_to_L7_6[i] <- fit7_means["theta.6"]/sqrt(fit7_means["epsilon.6"])*exp(-0.5*(sum((L7_6 - series[,i])^2))/fit7_means["epsilon.6"])
}
dist_to_L7_7 <- c()
for (i in 1:ncol(series)) {
  dist_to_L7_7[i] <- fit7_means["theta.7"]/sqrt(fit7_means["epsilon.7"])*exp(-0.5*(sum((L7_7 - series[,i])^2))/fit7_means["epsilon.7"])
}

Ldist7 <- data.frame(dist_to_L7_1,dist_to_L7_2,dist_to_L7_3,dist_to_L7_4,dist_to_L7_5,dist_to_L7_6,dist_to_L7_7)
assignments7 <- c(apply(Ldist7,1,max1))

plot(1:nrow(series),series[,1],type = "l",col=assignments7[1],xlab = "Time",ylab = "",ylim = c(-8,10),main="7")
for (i in 1:ncol(series)) {
  lines(1:nrow(series),series[,i],type = "l",col=assignments7[i])
}

dist_to_L8_1 <- c()
for (i in 1:ncol(series)) {
  dist_to_L8_1[i] <- fit8_means["theta.1"]/sqrt(fit8_means["epsilon.1"])*exp(-0.5*(sum((L8_1 - series[,i])^2))/fit8_means["epsilon.1"])
}
dist_to_L8_2 <- c()
for (i in 1:ncol(series)) {
  dist_to_L8_2[i] <- fit8_means["theta.2"]/sqrt(fit8_means["epsilon.2"])*exp(-0.5*(sum((L8_2 - series[,i])^2))/fit8_means["epsilon.2"])
}
dist_to_L8_3 <- c()
for (i in 1:ncol(series)) {
  dist_to_L8_3[i] <- fit8_means["theta.3"]/sqrt(fit8_means["epsilon.3"])*exp(-0.5*(sum((L8_3 - series[,i])^2))/fit8_means["epsilon.3"])
}
dist_to_L8_4 <- c()
for (i in 1:ncol(series)) {
  dist_to_L8_4[i] <- fit8_means["theta.4"]/sqrt(fit8_means["epsilon.4"])*exp(-0.5*(sum((L8_4 - series[,i])^2))/fit8_means["epsilon.4"])
}
dist_to_L8_5 <- c()
for (i in 1:ncol(series)) {
  dist_to_L8_5[i] <- fit8_means["theta.5"]/sqrt(fit8_means["epsilon.5"])*exp(-0.5*(sum((L8_5 - series[,i])^2))/fit8_means["epsilon.5"])
}
dist_to_L8_6 <- c()
for (i in 1:ncol(series)) {
  dist_to_L8_6[i] <- fit8_means["theta.6"]/sqrt(fit8_means["epsilon.6"])*exp(-0.5*(sum((L8_6 - series[,i])^2))/fit8_means["epsilon.6"])
}
dist_to_L8_7 <- c()
for (i in 1:ncol(series)) {
  dist_to_L8_7[i] <- fit8_means["theta.7"]/sqrt(fit8_means["epsilon.7"])*exp(-0.5*(sum((L8_7 - series[,i])^2))/fit8_means["epsilon.7"])
}
dist_to_L8_8 <- c()
for (i in 1:ncol(series)) {
  dist_to_L8_8[i] <- fit8_means["theta.8"]/sqrt(fit8_means["epsilon.8"])*exp(-0.5*(sum((L8_8 - series[,i])^2))/fit8_means["epsilon.8"])
}

Ldist8 <- data.frame(dist_to_L8_1,dist_to_L8_2,dist_to_L8_3,dist_to_L8_4,dist_to_L8_5,dist_to_L8_6,dist_to_L8_7,dist_to_L8_8)
assignments8 <- c(apply(Ldist8,1,max1))

plot(1:nrow(series),series[,1],type = "l",col=assignments8[1],xlab = "Time",ylab = "",ylim = c(-8,10),main="8")
for (i in 1:ncol(series)) {
  lines(1:nrow(series),series[,i],type = "l",col=assignments8[i])
}

dev.off()
```


2.3 Three components
```{r,eval=FALSE,include=TRUE}
png(file ="./figures/figure2-8.png",width = 480 )
data <- as.list(fromJSON(file="~/results/8_mallia_3_10k/data/data.json"))
series <- t(matrix(unlist(data$z),ncol = 63, nrow = 100))
ts.plot(series,ylim=c(-5,8),main="Simulated data, 3 components")
dev.off()
```

```{r,eval=FALSE,include=TRUE}
data1 <- read.csv("~/results/8_mallia_3_10k/goldStandardChains/1/1GSC1.csv")
data2 <- read.csv("~/results/8_mallia_3_10k/goldStandardChains/2/2GSC1.csv")
data3 <- read.csv("~/results/8_mallia_3_10k/goldStandardChains/3/3GSC1.csv")
data4 <- read.csv("~/results/8_mallia_3_10k/goldStandardChains/4/4GSC1.csv")
data5 <- read.csv("~/results/8_mallia_3_10k/goldStandardChains/5/5GSC1.csv")
data6 <- read.csv("~/results/8_mallia_3_10k/goldStandardChains/6/6GSC1.csv")
data7 <- read.csv("~/results/8_mallia_3_10k/goldStandardChains/7/7GSC1.csv")
data8 <- read.csv("~/results/8_mallia_3_10k/goldStandardChains/8/8GSC1.csv")

fit1_means <- apply(data1,2,median)
fit2_means <- apply(data2,2,median)
fit3_means <- apply(data3,2,median)
fit4_means <- apply(data4,2,median)
fit5_means <- apply(data5,2,median)
fit6_means <- apply(data6,2,median)
fit7_means <- apply(data7,2,median)
fit8_means <- apply(data8,2,median)

l1_1 <- paste('l.',1:63,sep='')
l1 <- paste('l.1.',1:63,sep='')
l2 <- paste('l.2.',1:63,sep='')
l3 <- paste('l.3.',1:63,sep='')
l4 <- paste('l.4.',1:63,sep='')
l5 <- paste('l.5.',1:63,sep='')
l6 <- paste('l.6.',1:63,sep='')
l7 <- paste('l.7.',1:63,sep='')
l8 <- paste('l.8.',1:63,sep='')
```

```{r,eval=FALSE,include=TRUE}
png(file ="./figures/figure2-9.png",width = 1440,height = 960 )

par(mfrow=c(2,4))

#1
L1_1 <-fit1_means[l1_1]

ts.plot(series, col="gray",ylim=c(-8,10),main="1")


lines(1:63,L1_1,"l",col="red", lwd=2 ,lty=4)

#2
L2_1 <- fit2_means[l1]
L2_2 <- fit2_means[l2]

ts.plot(series, col="gray",ylim=c(-8,10),main="2")
lines(1:63,L2_1,"l",col="red", lwd=2 ,lty=4)
lines(1:63,L2_2,"l",col="blue", lwd=2 ,lty=4)

#3
L3_1 <- fit3_means[l1]
L3_2 <- fit3_means[l2]
L3_3 <- fit3_means[l3]

ts.plot(series, col="gray",ylim=c(-8,10),main="3")
lines(1:63,L3_1,"l",col="red", lwd=2 ,lty=4)
lines(1:63,L3_2,"l",col="blue", lwd=2 ,lty=4)
lines(1:63,L3_3,"l",col="black", lwd=2 ,lty=4)

#4
L4_1 <- fit4_means[l1]
L4_2 <- fit4_means[l2]
L4_3 <- fit4_means[l3]
L4_4 <- fit4_means[l4]

ts.plot(series, col="gray",ylim=c(-8,10),main="4")
lines(1:63,L4_1,"l",col="red", lwd=2 ,lty=4)
lines(1:63,L4_2,"l",col="blue", lwd=2 ,lty=4)
lines(1:63,L4_3,"l",col="black", lwd=2 ,lty=4)
lines(1:63,L4_4,"l",col="purple", lwd=2 ,lty=4)

#5
L5_1 <- fit5_means[l1]
L5_2 <- fit5_means[l2]
L5_3 <- fit5_means[l3]
L5_4 <- fit5_means[l4]
L5_5 <- fit5_means[l5]

ts.plot(series, col="gray",ylim=c(-8,10),main="5")
lines(1:63,L5_1,"l",col="red", lwd=2 ,lty=4)
lines(1:63,L5_2,"l",col="blue", lwd=2 ,lty=4)
lines(1:63,L5_3,"l",col="black", lwd=2 ,lty=4)
lines(1:63,L5_4,"l",col="purple", lwd=2 ,lty=4)
lines(1:63,L5_5,"l",col="green", lwd=2 ,lty=4)

#6
L6_1 <- fit6_means[l1]
L6_2 <- fit6_means[l2]
L6_3 <- fit6_means[l3]
L6_4 <- fit6_means[l4]
L6_5 <- fit6_means[l5]
L6_6 <- fit6_means[l6]

ts.plot(series, col="gray",ylim=c(-8,10),main="6")
lines(1:63,L6_1,"l",col="red", lwd=2 ,lty=4)
lines(1:63,L6_2,"l",col="blue", lwd=2 ,lty=4)
lines(1:63,L6_3,"l",col="black", lwd=2 ,lty=4)
lines(1:63,L6_4,"l",col="purple", lwd=2 ,lty=4)
lines(1:63,L6_5,"l",col="green", lwd=2 ,lty=4)
lines(1:63,L6_6,"l",col="cyan", lwd=2 ,lty=4)

#7
L7_1 <- fit7_means[l1]
L7_2 <- fit7_means[l2]
L7_3 <- fit7_means[l3]
L7_4 <- fit7_means[l4]
L7_5 <- fit7_means[l5]
L7_6 <- fit7_means[l6]
L7_7 <- fit7_means[l7]

ts.plot(series, col="gray",ylim=c(-8,10),main="7")
lines(1:63,L7_1,"l",col="red", lwd=2 ,lty=4)
lines(1:63,L7_2,"l",col="blue", lwd=2 ,lty=4)
lines(1:63,L7_3,"l",col="black", lwd=2 ,lty=4)
lines(1:63,L7_4,"l",col="purple", lwd=2 ,lty=4)
lines(1:63,L7_5,"l",col="green", lwd=2 ,lty=4)
lines(1:63,L7_6,"l",col="cyan", lwd=2 ,lty=4)
lines(1:63,L7_7,"l",col="brown4", lwd=2 ,lty=4)

#8
L8_1 <- fit8_means[l1]
L8_2 <- fit8_means[l2]
L8_3 <- fit8_means[l3]
L8_4 <- fit8_means[l4]
L8_5 <- fit8_means[l5]
L8_6 <- fit8_means[l6]
L8_7 <- fit8_means[l7]
L8_8 <- fit8_means[l8]

ts.plot(series, col="gray",ylim=c(-8,10),main="8")
lines(1:63,L8_1,"l",col="red", lwd=2 ,lty=4)
lines(1:63,L8_2,"l",col="blue", lwd=2 ,lty=4)
lines(1:63,L8_3,"l",col="black", lwd=2 ,lty=4)
lines(1:63,L8_4,"l",col="purple", lwd=2 ,lty=4)
lines(1:63,L8_5,"l",col="green", lwd=2 ,lty=4)
lines(1:63,L8_6,"l",col="cyan", lwd=2 ,lty=4)
lines(1:63,L8_7,"l",col="brown4", lwd=2 ,lty=4)
lines(1:63,L8_8,"l",col="cornflowerblue", lwd=2 ,lty=4)

dev.off()
```


```{r,echo=FALSE}
centers3 <- data.frame(L1 = 2*sin(x),L2 = 2*cos(x),L3 = sqrt(3+2*x))
estimates3.1 <- data.frame(L1_1)
estimates3.2 <- data.frame(L2_1,L2_2)
estimates3.3 <- data.frame(L3_1,L3_2,L3_3)
estimates3.4 <- data.frame(L4_1,L4_2,L4_3,L4_4)
estimates3.5 <- data.frame(L5_1,L5_2,L5_3,L5_4,L5_5)
estimates3.6 <- data.frame(L6_1,L6_2,L6_3,L6_4,L6_5,L6_6)
estimates3.7 <- data.frame(L7_1,L7_2,L7_3,L7_4,L7_5,L7_6,L7_7)
estimates3.8 <- data.frame(L8_1,L8_2,L8_3,L8_4,L8_5,L8_6,L8_7,L8_8)

center_mse(centers3,estimates3.1)
center_mse(centers3,estimates3.2)
center_mse(centers3,estimates3.3)
center_mse(centers3,estimates3.4)
center_mse(centers3,estimates3.5)
center_mse(centers3,estimates3.6)
center_mse(centers3,estimates3.7)
center_mse(centers3,estimates3.8)

```

```{r,eval=FALSE,include=TRUE}
png(file ="./figures/figure2-10.png",width = 1440,height = 960 )
par(mfrow=c(2,4))

ts.plot(series,main="1",ylim = c(-8,10))

dist_to_L2_1 <- c()
for (i in 1:ncol(series)) {
  dist_to_L2_1[i] <- fit2_means["theta.1"]/sqrt(fit2_means["epsilon.1"])*exp(-0.5*(sum((L2_1 - series[,i])^2))/fit2_means["epsilon.1"])
}
dist_to_L2_2 <- c()
for (i in 1:ncol(series)) {
  dist_to_L2_2[i] <- fit2_means["theta.2"]/sqrt(fit2_means["epsilon.2"])*exp(-0.5*(sum((L2_2 - series[,i])^2))/fit2_means["epsilon.2"])
}

Ldist2 <- data.frame(dist_to_L2_1,dist_to_L2_2)
assignments2 <- c(apply(Ldist2,1,max1))

plot(1:nrow(series),series[,1],type = "l",col=assignments2[1],xlab = "Time",ylab = "",ylim = c(-8,10),main="2")
for (i in 1:ncol(series)) {
  lines(1:nrow(series),series[,i],type = "l",col=assignments2[i])
}

dist_to_L3_1 <- c()
for (i in 1:ncol(series)) {
  dist_to_L3_1[i] <- fit3_means["theta.1"]/sqrt(fit3_means["epsilon.1"])*exp(-0.5*(sum((L3_1 - series[,i])^2))/fit3_means["epsilon.1"])
}
dist_to_L3_2 <- c()
for (i in 1:ncol(series)) {
  dist_to_L3_2[i] <- fit3_means["theta.2"]/sqrt(fit3_means["epsilon.2"])*exp(-0.5*(sum((L3_2 - series[,i])^2))/fit3_means["epsilon.2"])
}
dist_to_L3_3 <- c()
for (i in 1:ncol(series)) {
  dist_to_L3_3[i] <- fit3_means["theta.3"]/sqrt(fit3_means["epsilon.3"])*exp(-0.5*(sum((L3_3 - series[,i])^2))/fit3_means["epsilon.3"])
}

Ldist3 <- data.frame(dist_to_L3_1,dist_to_L3_2,dist_to_L3_3)
assignments3 <- c(apply(Ldist3,1,max1))

plot(1:nrow(series),series[,1],type = "l",col=assignments3[1],xlab = "Time",ylab = "",ylim = c(-8,10),main="3")
for (i in 1:ncol(series)) {
  lines(1:nrow(series),series[,i],type = "l",col=assignments3[i])
}

dist_to_L4_1 <- c()
for (i in 1:ncol(series)) {
  dist_to_L4_1[i] <- fit4_means["theta.1"]/sqrt(fit4_means["epsilon.1"])*exp(-0.5*(sum((L4_1 - series[,i])^2))/fit4_means["epsilon.1"])
}
dist_to_L4_2 <- c()
for (i in 1:ncol(series)) {
  dist_to_L4_2[i] <- fit4_means["theta.2"]/sqrt(fit4_means["epsilon.2"])*exp(-0.5*(sum((L4_2 - series[,i])^2))/fit4_means["epsilon.2"])
}
dist_to_L4_3 <- c()
for (i in 1:ncol(series)) {
  dist_to_L4_3[i] <- fit4_means["theta.3"]/sqrt(fit4_means["epsilon.3"])*exp(-0.5*(sum((L4_3 - series[,i])^2))/fit4_means["epsilon.3"])
}
dist_to_L4_4 <- c()
for (i in 1:ncol(series)) {
  dist_to_L4_4[i] <- fit4_means["theta.4"]/sqrt(fit4_means["epsilon.4"])*exp(-0.5*(sum((L4_4 - series[,i])^2))/fit4_means["epsilon.4"])
}

Ldist4 <- data.frame(dist_to_L4_1,dist_to_L4_2,dist_to_L4_3,dist_to_L4_4)
assignments4 <- c(apply(Ldist4,1,max1))

plot(1:nrow(series),series[,1],type = "l",col=assignments4[1],xlab = "Time",ylab = "",ylim = c(-8,10),main="4")
for (i in 1:ncol(series)) {
  lines(1:nrow(series),series[,i],type = "l",col=assignments4[i])
}

dist_to_L5_1 <- c()
for (i in 1:ncol(series)) {
  dist_to_L5_1[i] <- fit5_means["theta.1"]/sqrt(fit5_means["epsilon.1"])*exp(-0.5*(sum((L5_1 - series[,i])^2))/fit5_means["epsilon.1"])
}
dist_to_L5_2 <- c()
for (i in 1:ncol(series)) {
  dist_to_L5_2[i] <- fit5_means["theta.2"]/sqrt(fit5_means["epsilon.2"])*exp(-0.5*(sum((L5_2 - series[,i])^2))/fit5_means["epsilon.2"])
}
dist_to_L5_3 <- c()
for (i in 1:ncol(series)) {
  dist_to_L5_3[i] <- fit5_means["theta.3"]/sqrt(fit5_means["epsilon.3"])*exp(-0.5*(sum((L5_3 - series[,i])^2))/fit5_means["epsilon.3"])
}
dist_to_L5_4 <- c()
for (i in 1:ncol(series)) {
  dist_to_L5_4[i] <- fit5_means["theta.4"]/sqrt(fit5_means["epsilon.4"])*exp(-0.5*(sum((L5_4 - series[,i])^2))/fit5_means["epsilon.4"])
}
dist_to_L5_5 <- c()
for (i in 1:ncol(series)) {
  dist_to_L5_5[i] <- fit5_means["theta.5"]/sqrt(fit5_means["epsilon.5"])*exp(-0.5*(sum((L5_5 - series[,i])^2))/fit5_means["epsilon.5"])
}

Ldist5 <- data.frame(dist_to_L5_1,dist_to_L5_2,dist_to_L5_3,dist_to_L5_4,dist_to_L5_5)
assignments5 <- c(apply(Ldist5,1,max1))

plot(1:nrow(series),series[,1],type = "l",col=assignments5[1],xlab = "Time",ylab = "",ylim = c(-8,10),main=5)
for (i in 1:ncol(series)) {
  lines(1:nrow(series),series[,i],type = "l",col=assignments5[i])
}

dist_to_L6_1 <- c()
for (i in 1:ncol(series)) {
  dist_to_L6_1[i] <- fit6_means["theta.1"]/sqrt(fit6_means["epsilon.1"])*exp(-0.5*(sum((L6_1 - series[,i])^2))/fit6_means["epsilon.1"])
}
dist_to_L6_2 <- c()
for (i in 1:ncol(series)) {
  dist_to_L6_2[i] <- fit6_means["theta.2"]/sqrt(fit6_means["epsilon.2"])*exp(-0.5*(sum((L6_2 - series[,i])^2))/fit6_means["epsilon.2"])
}
dist_to_L6_3 <- c()
for (i in 1:ncol(series)) {
  dist_to_L6_3[i] <- fit6_means["theta.3"]/sqrt(fit6_means["epsilon.3"])*exp(-0.5*(sum((L6_3 - series[,i])^2))/fit6_means["epsilon.3"])
}
dist_to_L6_4 <- c()
for (i in 1:ncol(series)) {
  dist_to_L6_4[i] <- fit6_means["theta.4"]/sqrt(fit6_means["epsilon.4"])*exp(-0.5*(sum((L6_4 - series[,i])^2))/fit6_means["epsilon.4"])
}
dist_to_L6_5 <- c()
for (i in 1:ncol(series)) {
  dist_to_L6_5[i] <- fit6_means["theta.5"]/sqrt(fit6_means["epsilon.5"])*exp(-0.5*(sum((L6_5 - series[,i])^2))/fit6_means["epsilon.5"])
}
dist_to_L6_6 <- c()
for (i in 1:ncol(series)) {
  dist_to_L6_6[i] <- fit6_means["theta.6"]/sqrt(fit6_means["epsilon.6"])*exp(-0.5*(sum((L6_6 - series[,i])^2))/fit6_means["epsilon.6"])
}

Ldist6 <- data.frame(dist_to_L6_1,dist_to_L6_2,dist_to_L6_3,dist_to_L6_4,dist_to_L6_5,dist_to_L6_6)
assignments6 <- c(apply(Ldist6,1,max1))

plot(1:nrow(series),series[,1],type = "l",col=assignments6[1],xlab = "Time",ylab = "",ylim = c(-8,10),main="6")
for (i in 1:ncol(series)) {
  lines(1:nrow(series),series[,i],type = "l",col=assignments6[i])
}

dist_to_L7_1 <- c()
for (i in 1:ncol(series)) {
  dist_to_L7_1[i] <- fit7_means["theta.1"]/sqrt(fit7_means["epsilon.1"])*exp(-0.5*(sum((L7_1 - series[,i])^2))/fit7_means["epsilon.1"])
}
dist_to_L7_2 <- c()
for (i in 1:ncol(series)) {
  dist_to_L7_2[i] <- fit7_means["theta.2"]/sqrt(fit7_means["epsilon.2"])*exp(-0.5*(sum((L7_2 - series[,i])^2))/fit7_means["epsilon.2"])
}
dist_to_L7_3 <- c()
for (i in 1:ncol(series)) {
  dist_to_L7_3[i] <- fit7_means["theta.3"]/sqrt(fit7_means["epsilon.3"])*exp(-0.5*(sum((L7_3 - series[,i])^2))/fit7_means["epsilon.3"])
}
dist_to_L7_4 <- c()
for (i in 1:ncol(series)) {
  dist_to_L7_4[i] <- fit7_means["theta.4"]/sqrt(fit7_means["epsilon.4"])*exp(-0.5*(sum((L7_4 - series[,i])^2))/fit7_means["epsilon.4"])
}
dist_to_L7_5 <- c()
for (i in 1:ncol(series)) {
  dist_to_L7_5[i] <- fit7_means["theta.5"]/sqrt(fit7_means["epsilon.5"])*exp(-0.5*(sum((L7_5 - series[,i])^2))/fit7_means["epsilon.5"])
}
dist_to_L7_6 <- c()
for (i in 1:ncol(series)) {
  dist_to_L7_6[i] <- fit7_means["theta.6"]/sqrt(fit7_means["epsilon.6"])*exp(-0.5*(sum((L7_6 - series[,i])^2))/fit7_means["epsilon.6"])
}
dist_to_L7_7 <- c()
for (i in 1:ncol(series)) {
  dist_to_L7_7[i] <- fit7_means["theta.7"]/sqrt(fit7_means["epsilon.7"])*exp(-0.5*(sum((L7_7 - series[,i])^2))/fit7_means["epsilon.7"])
}

Ldist7 <- data.frame(dist_to_L7_1,dist_to_L7_2,dist_to_L7_3,dist_to_L7_4,dist_to_L7_5,dist_to_L7_6,dist_to_L7_7)
assignments7 <- c(apply(Ldist7,1,max1))

plot(1:nrow(series),series[,1],type = "l",col=assignments7[1],xlab = "Time",ylab = "",ylim = c(-8,10),main="7")
for (i in 1:ncol(series)) {
  lines(1:nrow(series),series[,i],type = "l",col=assignments7[i])
}

dist_to_L8_1 <- c()
for (i in 1:ncol(series)) {
  dist_to_L8_1[i] <- fit8_means["theta.1"]/sqrt(fit8_means["epsilon.1"])*exp(-0.5*(sum((L8_1 - series[,i])^2))/fit8_means["epsilon.1"])
}
dist_to_L8_2 <- c()
for (i in 1:ncol(series)) {
  dist_to_L8_2[i] <- fit8_means["theta.2"]/sqrt(fit8_means["epsilon.2"])*exp(-0.5*(sum((L8_2 - series[,i])^2))/fit8_means["epsilon.2"])
}
dist_to_L8_3 <- c()
for (i in 1:ncol(series)) {
  dist_to_L8_3[i] <- fit8_means["theta.3"]/sqrt(fit8_means["epsilon.3"])*exp(-0.5*(sum((L8_3 - series[,i])^2))/fit8_means["epsilon.3"])
}
dist_to_L8_4 <- c()
for (i in 1:ncol(series)) {
  dist_to_L8_4[i] <- fit8_means["theta.4"]/sqrt(fit8_means["epsilon.4"])*exp(-0.5*(sum((L8_4 - series[,i])^2))/fit8_means["epsilon.4"])
}
dist_to_L8_5 <- c()
for (i in 1:ncol(series)) {
  dist_to_L8_5[i] <- fit8_means["theta.5"]/sqrt(fit8_means["epsilon.5"])*exp(-0.5*(sum((L8_5 - series[,i])^2))/fit8_means["epsilon.5"])
}
dist_to_L8_6 <- c()
for (i in 1:ncol(series)) {
  dist_to_L8_6[i] <- fit8_means["theta.6"]/sqrt(fit8_means["epsilon.6"])*exp(-0.5*(sum((L8_6 - series[,i])^2))/fit8_means["epsilon.6"])
}
dist_to_L8_7 <- c()
for (i in 1:ncol(series)) {
  dist_to_L8_7[i] <- fit8_means["theta.7"]/sqrt(fit8_means["epsilon.7"])*exp(-0.5*(sum((L8_7 - series[,i])^2))/fit8_means["epsilon.7"])
}
dist_to_L8_8 <- c()
for (i in 1:ncol(series)) {
  dist_to_L8_8[i] <- fit8_means["theta.8"]/sqrt(fit8_means["epsilon.8"])*exp(-0.5*(sum((L8_8 - series[,i])^2))/fit8_means["epsilon.8"])
}

Ldist8 <- data.frame(dist_to_L8_1,dist_to_L8_2,dist_to_L8_3,dist_to_L8_4,dist_to_L8_5,dist_to_L8_6,dist_to_L8_7,dist_to_L8_8)
assignments8 <- c(apply(Ldist8,1,max1))

plot(1:nrow(series),series[,1],type = "l",col=assignments8[1],xlab = "Time",ylab = "",ylim = c(-8,10),main="8")
for (i in 1:ncol(series)) {
  lines(1:nrow(series),series[,i],type = "l",col=assignments8[i])
}

dev.off()
```

2.4 Four components
```{r,eval=FALSE,include=TRUE}
png(file ="./figures/figure2-12.png",width = 480 )
data <- as.list(fromJSON(file="~/results/8_mallia_4_10k/data/data.json"))
series <- t(matrix(unlist(data$z),ncol = 63, nrow = 100))
ts.plot(series,ylim=c(-5,8),main="Simulated data, 4 components")
dev.off()
```

```{r,eval=FALSE,include=TRUE}
data1 <- read.csv("~/results/8_mallia_4_10k/goldStandardChains/1/1GSC1.csv")
data2 <- read.csv("~/results/8_mallia_4_10k/goldStandardChains/2/2GSC1.csv")
data3 <- read.csv("~/results/8_mallia_4_10k/goldStandardChains/3/3GSC1.csv")
data4 <- read.csv("~/results/8_mallia_4_10k/goldStandardChains/4/4GSC1.csv")
data5 <- read.csv("~/results/8_mallia_4_10k/goldStandardChains/5/5GSC1.csv")
data6 <- read.csv("~/results/8_mallia_4_10k/goldStandardChains/6/6GSC1.csv")
data7 <- read.csv("~/results/8_mallia_4_10k/goldStandardChains/7/7GSC1.csv")
data8 <- read.csv("~/results/8_mallia_4_10k/goldStandardChains/8/8GSC1.csv")

fit1_means <- apply(data1,2,median)
fit2_means <- apply(data2,2,median)
fit3_means <- apply(data3,2,median)
fit4_means <- apply(data4,2,median)
fit5_means <- apply(data5,2,median)
fit6_means <- apply(data6,2,median)
fit7_means <- apply(data7,2,median)
fit8_means <- apply(data8,2,median)

l1_1 <- paste('l.',1:63,sep='')
l1 <- paste('l.1.',1:63,sep='')
l2 <- paste('l.2.',1:63,sep='')
l3 <- paste('l.3.',1:63,sep='')
l4 <- paste('l.4.',1:63,sep='')
l5 <- paste('l.5.',1:63,sep='')
l6 <- paste('l.6.',1:63,sep='')
l7 <- paste('l.7.',1:63,sep='')
l8 <- paste('l.8.',1:63,sep='')
```

```{r,eval=FALSE,include=TRUE}
png(file ="./figures/figure2-13.png",width = 1440,height = 960 )

par(mfrow=c(2,4))

#1
L1_1 <-fit1_means[l1_1]

ts.plot(series, col="gray",ylim=c(-8,10),main="1")


lines(1:63,L1_1,"l",col="red", lwd=2 ,lty=4)

#2
L2_1 <- fit2_means[l1]
L2_2 <- fit2_means[l2]

ts.plot(series, col="gray",ylim=c(-8,10),main="2")
lines(1:63,L2_1,"l",col="red", lwd=2 ,lty=4)
lines(1:63,L2_2,"l",col="blue", lwd=2 ,lty=4)

#3
L3_1 <- fit3_means[l1]
L3_2 <- fit3_means[l2]
L3_3 <- fit3_means[l3]

ts.plot(series, col="gray",ylim=c(-8,10),main="3")
lines(1:63,L3_1,"l",col="red", lwd=2 ,lty=4)
lines(1:63,L3_2,"l",col="blue", lwd=2 ,lty=4)
lines(1:63,L3_3,"l",col="black", lwd=2 ,lty=4)

#4
L4_1 <- fit4_means[l1]
L4_2 <- fit4_means[l2]
L4_3 <- fit4_means[l3]
L4_4 <- fit4_means[l4]

ts.plot(series, col="gray",ylim=c(-8,10),main="4")
lines(1:63,L4_1,"l",col="red", lwd=2 ,lty=4)
lines(1:63,L4_2,"l",col="blue", lwd=2 ,lty=4)
lines(1:63,L4_3,"l",col="black", lwd=2 ,lty=4)
lines(1:63,L4_4,"l",col="purple", lwd=2 ,lty=4)

#5
L5_1 <- fit5_means[l1]
L5_2 <- fit5_means[l2]
L5_3 <- fit5_means[l3]
L5_4 <- fit5_means[l4]
L5_5 <- fit5_means[l5]

ts.plot(series, col="gray",ylim=c(-8,10),main="5")
lines(1:63,L5_1,"l",col="red", lwd=2 ,lty=4)
lines(1:63,L5_2,"l",col="blue", lwd=2 ,lty=4)
lines(1:63,L5_3,"l",col="black", lwd=2 ,lty=4)
lines(1:63,L5_4,"l",col="purple", lwd=2 ,lty=4)
lines(1:63,L5_5,"l",col="green", lwd=2 ,lty=4)

#6
L6_1 <- fit6_means[l1]
L6_2 <- fit6_means[l2]
L6_3 <- fit6_means[l3]
L6_4 <- fit6_means[l4]
L6_5 <- fit6_means[l5]
L6_6 <- fit6_means[l6]

ts.plot(series, col="gray",ylim=c(-8,10),main="6")
lines(1:63,L6_1,"l",col="red", lwd=2 ,lty=4)
lines(1:63,L6_2,"l",col="blue", lwd=2 ,lty=4)
lines(1:63,L6_3,"l",col="black", lwd=2 ,lty=4)
lines(1:63,L6_4,"l",col="purple", lwd=2 ,lty=4)
lines(1:63,L6_5,"l",col="green", lwd=2 ,lty=4)
lines(1:63,L6_6,"l",col="cyan", lwd=2 ,lty=4)

#7
L7_1 <- fit7_means[l1]
L7_2 <- fit7_means[l2]
L7_3 <- fit7_means[l3]
L7_4 <- fit7_means[l4]
L7_5 <- fit7_means[l5]
L7_6 <- fit7_means[l6]
L7_7 <- fit7_means[l7]

ts.plot(series, col="gray",ylim=c(-8,10),main="7")
lines(1:63,L7_1,"l",col="red", lwd=2 ,lty=4)
lines(1:63,L7_2,"l",col="blue", lwd=2 ,lty=4)
lines(1:63,L7_3,"l",col="black", lwd=2 ,lty=4)
lines(1:63,L7_4,"l",col="purple", lwd=2 ,lty=4)
lines(1:63,L7_5,"l",col="green", lwd=2 ,lty=4)
lines(1:63,L7_6,"l",col="cyan", lwd=2 ,lty=4)
lines(1:63,L7_7,"l",col="brown4", lwd=2 ,lty=4)

#8
L8_1 <- fit8_means[l1]
L8_2 <- fit8_means[l2]
L8_3 <- fit8_means[l3]
L8_4 <- fit8_means[l4]
L8_5 <- fit8_means[l5]
L8_6 <- fit8_means[l6]
L8_7 <- fit8_means[l7]
L8_8 <- fit8_means[l8]

ts.plot(series, col="gray",ylim=c(-8,10),main="8")
lines(1:63,L8_1,"l",col="red", lwd=2 ,lty=4)
lines(1:63,L8_2,"l",col="blue", lwd=2 ,lty=4)
lines(1:63,L8_3,"l",col="black", lwd=2 ,lty=4)
lines(1:63,L8_4,"l",col="purple", lwd=2 ,lty=4)
lines(1:63,L8_5,"l",col="green", lwd=2 ,lty=4)
lines(1:63,L8_6,"l",col="cyan", lwd=2 ,lty=4)
lines(1:63,L8_7,"l",col="brown4", lwd=2 ,lty=4)
lines(1:63,L8_8,"l",col="cornflowerblue", lwd=2 ,lty=4)

dev.off()
```

```{r,echo=FALSE}
centers4 <- data.frame(L1 = 2*sin(x),L2 = 2*cos(x),L3 = sqrt(3+2*x),L4 = -0.5-x*sin(x))
estimates4.1 <- data.frame(L1_1)
estimates4.2 <- data.frame(L2_1,L2_2)
estimates4.3 <- data.frame(L3_1,L3_2,L3_3)
estimates4.4 <- data.frame(L4_1,L4_2,L4_3,L4_4)
estimates4.5 <- data.frame(L5_1,L5_2,L5_3,L5_4,L5_5)
estimates4.6 <- data.frame(L6_1,L6_2,L6_3,L6_4,L6_5,L6_6)
estimates4.7 <- data.frame(L7_1,L7_2,L7_3,L7_4,L7_5,L7_6,L7_7)
estimates4.8 <- data.frame(L8_1,L8_2,L8_3,L8_4,L8_5,L8_6,L8_7,L8_8)

center_mse(centers4,estimates4.1)
center_mse(centers4,estimates4.2)
center_mse(centers4,estimates4.3)
center_mse(centers4,estimates4.4)
center_mse(centers4,estimates4.5)
center_mse(centers4,estimates4.6)
center_mse(centers4,estimates4.7)
center_mse(centers4,estimates4.8)

```

```{r,eval=FALSE,include=TRUE}
png(file ="./figures/figure2-14.png",width = 1440,height = 960 )
par(mfrow=c(2,4))

ts.plot(series,main="1",ylim = c(-8,10))

dist_to_L2_1 <- c()
for (i in 1:ncol(series)) {
  dist_to_L2_1[i] <- fit2_means["theta.1"]/sqrt(fit2_means["epsilon.1"])*exp(-0.5*(sum((L2_1 - series[,i])^2))/fit2_means["epsilon.1"])
}
dist_to_L2_2 <- c()
for (i in 1:ncol(series)) {
  dist_to_L2_2[i] <- fit2_means["theta.2"]/sqrt(fit2_means["epsilon.2"])*exp(-0.5*(sum((L2_2 - series[,i])^2))/fit2_means["epsilon.2"])
}

Ldist2 <- data.frame(dist_to_L2_1,dist_to_L2_2)
assignments2 <- c(apply(Ldist2,1,max1))

plot(1:nrow(series),series[,1],type = "l",col=assignments2[1],xlab = "Time",ylab = "",ylim = c(-8,10),main="2")
for (i in 1:ncol(series)) {
  lines(1:nrow(series),series[,i],type = "l",col=assignments2[i])
}

dist_to_L3_1 <- c()
for (i in 1:ncol(series)) {
  dist_to_L3_1[i] <- fit3_means["theta.1"]/sqrt(fit3_means["epsilon.1"])*exp(-0.5*(sum((L3_1 - series[,i])^2))/fit3_means["epsilon.1"])
}
dist_to_L3_2 <- c()
for (i in 1:ncol(series)) {
  dist_to_L3_2[i] <- fit3_means["theta.2"]/sqrt(fit3_means["epsilon.2"])*exp(-0.5*(sum((L3_2 - series[,i])^2))/fit3_means["epsilon.2"])
}
dist_to_L3_3 <- c()
for (i in 1:ncol(series)) {
  dist_to_L3_3[i] <- fit3_means["theta.3"]/sqrt(fit3_means["epsilon.3"])*exp(-0.5*(sum((L3_3 - series[,i])^2))/fit3_means["epsilon.3"])
}

Ldist3 <- data.frame(dist_to_L3_1,dist_to_L3_2,dist_to_L3_3)
assignments3 <- c(apply(Ldist3,1,max1))

plot(1:nrow(series),series[,1],type = "l",col=assignments3[1],xlab = "Time",ylab = "",ylim = c(-8,10),main="3")
for (i in 1:ncol(series)) {
  lines(1:nrow(series),series[,i],type = "l",col=assignments3[i])
}

dist_to_L4_1 <- c()
for (i in 1:ncol(series)) {
  dist_to_L4_1[i] <- fit4_means["theta.1"]/sqrt(fit4_means["epsilon.1"])*exp(-0.5*(sum((L4_1 - series[,i])^2))/fit4_means["epsilon.1"])
}
dist_to_L4_2 <- c()
for (i in 1:ncol(series)) {
  dist_to_L4_2[i] <- fit4_means["theta.2"]/sqrt(fit4_means["epsilon.2"])*exp(-0.5*(sum((L4_2 - series[,i])^2))/fit4_means["epsilon.2"])
}
dist_to_L4_3 <- c()
for (i in 1:ncol(series)) {
  dist_to_L4_3[i] <- fit4_means["theta.3"]/sqrt(fit4_means["epsilon.3"])*exp(-0.5*(sum((L4_3 - series[,i])^2))/fit4_means["epsilon.3"])
}
dist_to_L4_4 <- c()
for (i in 1:ncol(series)) {
  dist_to_L4_4[i] <- fit4_means["theta.4"]/sqrt(fit4_means["epsilon.4"])*exp(-0.5*(sum((L4_4 - series[,i])^2))/fit4_means["epsilon.4"])
}

Ldist4 <- data.frame(dist_to_L4_1,dist_to_L4_2,dist_to_L4_3,dist_to_L4_4)
assignments4 <- c(apply(Ldist4,1,max1))

plot(1:nrow(series),series[,1],type = "l",col=assignments4[1],xlab = "Time",ylab = "",ylim = c(-8,10),main="4")
for (i in 1:ncol(series)) {
  lines(1:nrow(series),series[,i],type = "l",col=assignments4[i])
}

dist_to_L5_1 <- c()
for (i in 1:ncol(series)) {
  dist_to_L5_1[i] <- fit5_means["theta.1"]/sqrt(fit5_means["epsilon.1"])*exp(-0.5*(sum((L5_1 - series[,i])^2))/fit5_means["epsilon.1"])
}
dist_to_L5_2 <- c()
for (i in 1:ncol(series)) {
  dist_to_L5_2[i] <- fit5_means["theta.2"]/sqrt(fit5_means["epsilon.2"])*exp(-0.5*(sum((L5_2 - series[,i])^2))/fit5_means["epsilon.2"])
}
dist_to_L5_3 <- c()
for (i in 1:ncol(series)) {
  dist_to_L5_3[i] <- fit5_means["theta.3"]/sqrt(fit5_means["epsilon.3"])*exp(-0.5*(sum((L5_3 - series[,i])^2))/fit5_means["epsilon.3"])
}
dist_to_L5_4 <- c()
for (i in 1:ncol(series)) {
  dist_to_L5_4[i] <- fit5_means["theta.4"]/sqrt(fit5_means["epsilon.4"])*exp(-0.5*(sum((L5_4 - series[,i])^2))/fit5_means["epsilon.4"])
}
dist_to_L5_5 <- c()
for (i in 1:ncol(series)) {
  dist_to_L5_5[i] <- fit5_means["theta.5"]/sqrt(fit5_means["epsilon.5"])*exp(-0.5*(sum((L5_5 - series[,i])^2))/fit5_means["epsilon.5"])
}

Ldist5 <- data.frame(dist_to_L5_1,dist_to_L5_2,dist_to_L5_3,dist_to_L5_4,dist_to_L5_5)
assignments5 <- c(apply(Ldist5,1,max1))

plot(1:nrow(series),series[,1],type = "l",col=assignments5[1],xlab = "Time",ylab = "",ylim = c(-8,10),main=5)
for (i in 1:ncol(series)) {
  lines(1:nrow(series),series[,i],type = "l",col=assignments5[i])
}

dist_to_L6_1 <- c()
for (i in 1:ncol(series)) {
  dist_to_L6_1[i] <- fit6_means["theta.1"]/sqrt(fit6_means["epsilon.1"])*exp(-0.5*(sum((L6_1 - series[,i])^2))/fit6_means["epsilon.1"])
}
dist_to_L6_2 <- c()
for (i in 1:ncol(series)) {
  dist_to_L6_2[i] <- fit6_means["theta.2"]/sqrt(fit6_means["epsilon.2"])*exp(-0.5*(sum((L6_2 - series[,i])^2))/fit6_means["epsilon.2"])
}
dist_to_L6_3 <- c()
for (i in 1:ncol(series)) {
  dist_to_L6_3[i] <- fit6_means["theta.3"]/sqrt(fit6_means["epsilon.3"])*exp(-0.5*(sum((L6_3 - series[,i])^2))/fit6_means["epsilon.3"])
}
dist_to_L6_4 <- c()
for (i in 1:ncol(series)) {
  dist_to_L6_4[i] <- fit6_means["theta.4"]/sqrt(fit6_means["epsilon.4"])*exp(-0.5*(sum((L6_4 - series[,i])^2))/fit6_means["epsilon.4"])
}
dist_to_L6_5 <- c()
for (i in 1:ncol(series)) {
  dist_to_L6_5[i] <- fit6_means["theta.5"]/sqrt(fit6_means["epsilon.5"])*exp(-0.5*(sum((L6_5 - series[,i])^2))/fit6_means["epsilon.5"])
}
dist_to_L6_6 <- c()
for (i in 1:ncol(series)) {
  dist_to_L6_6[i] <- fit6_means["theta.6"]/sqrt(fit6_means["epsilon.6"])*exp(-0.5*(sum((L6_6 - series[,i])^2))/fit6_means["epsilon.6"])
}

Ldist6 <- data.frame(dist_to_L6_1,dist_to_L6_2,dist_to_L6_3,dist_to_L6_4,dist_to_L6_5,dist_to_L6_6)
assignments6 <- c(apply(Ldist6,1,max1))

plot(1:nrow(series),series[,1],type = "l",col=assignments6[1],xlab = "Time",ylab = "",ylim = c(-8,10),main="6")
for (i in 1:ncol(series)) {
  lines(1:nrow(series),series[,i],type = "l",col=assignments6[i])
}

dist_to_L7_1 <- c()
for (i in 1:ncol(series)) {
  dist_to_L7_1[i] <- fit7_means["theta.1"]/sqrt(fit7_means["epsilon.1"])*exp(-0.5*(sum((L7_1 - series[,i])^2))/fit7_means["epsilon.1"])
}
dist_to_L7_2 <- c()
for (i in 1:ncol(series)) {
  dist_to_L7_2[i] <- fit7_means["theta.2"]/sqrt(fit7_means["epsilon.2"])*exp(-0.5*(sum((L7_2 - series[,i])^2))/fit7_means["epsilon.2"])
}
dist_to_L7_3 <- c()
for (i in 1:ncol(series)) {
  dist_to_L7_3[i] <- fit7_means["theta.3"]/sqrt(fit7_means["epsilon.3"])*exp(-0.5*(sum((L7_3 - series[,i])^2))/fit7_means["epsilon.3"])
}
dist_to_L7_4 <- c()
for (i in 1:ncol(series)) {
  dist_to_L7_4[i] <- fit7_means["theta.4"]/sqrt(fit7_means["epsilon.4"])*exp(-0.5*(sum((L7_4 - series[,i])^2))/fit7_means["epsilon.4"])
}
dist_to_L7_5 <- c()
for (i in 1:ncol(series)) {
  dist_to_L7_5[i] <- fit7_means["theta.5"]/sqrt(fit7_means["epsilon.5"])*exp(-0.5*(sum((L7_5 - series[,i])^2))/fit7_means["epsilon.5"])
}
dist_to_L7_6 <- c()
for (i in 1:ncol(series)) {
  dist_to_L7_6[i] <- fit7_means["theta.6"]/sqrt(fit7_means["epsilon.6"])*exp(-0.5*(sum((L7_6 - series[,i])^2))/fit7_means["epsilon.6"])
}
dist_to_L7_7 <- c()
for (i in 1:ncol(series)) {
  dist_to_L7_7[i] <- fit7_means["theta.7"]/sqrt(fit7_means["epsilon.7"])*exp(-0.5*(sum((L7_7 - series[,i])^2))/fit7_means["epsilon.7"])
}

Ldist7 <- data.frame(dist_to_L7_1,dist_to_L7_2,dist_to_L7_3,dist_to_L7_4,dist_to_L7_5,dist_to_L7_6,dist_to_L7_7)
assignments7 <- c(apply(Ldist7,1,max1))

plot(1:nrow(series),series[,1],type = "l",col=assignments7[1],xlab = "Time",ylab = "",ylim = c(-8,10),main="7")
for (i in 1:ncol(series)) {
  lines(1:nrow(series),series[,i],type = "l",col=assignments7[i])
}

dist_to_L8_1 <- c()
for (i in 1:ncol(series)) {
  dist_to_L8_1[i] <- fit8_means["theta.1"]/sqrt(fit8_means["epsilon.1"])*exp(-0.5*(sum((L8_1 - series[,i])^2))/fit8_means["epsilon.1"])
}
dist_to_L8_2 <- c()
for (i in 1:ncol(series)) {
  dist_to_L8_2[i] <- fit8_means["theta.2"]/sqrt(fit8_means["epsilon.2"])*exp(-0.5*(sum((L8_2 - series[,i])^2))/fit8_means["epsilon.2"])
}
dist_to_L8_3 <- c()
for (i in 1:ncol(series)) {
  dist_to_L8_3[i] <- fit8_means["theta.3"]/sqrt(fit8_means["epsilon.3"])*exp(-0.5*(sum((L8_3 - series[,i])^2))/fit8_means["epsilon.3"])
}
dist_to_L8_4 <- c()
for (i in 1:ncol(series)) {
  dist_to_L8_4[i] <- fit8_means["theta.4"]/sqrt(fit8_means["epsilon.4"])*exp(-0.5*(sum((L8_4 - series[,i])^2))/fit8_means["epsilon.4"])
}
dist_to_L8_5 <- c()
for (i in 1:ncol(series)) {
  dist_to_L8_5[i] <- fit8_means["theta.5"]/sqrt(fit8_means["epsilon.5"])*exp(-0.5*(sum((L8_5 - series[,i])^2))/fit8_means["epsilon.5"])
}
dist_to_L8_6 <- c()
for (i in 1:ncol(series)) {
  dist_to_L8_6[i] <- fit8_means["theta.6"]/sqrt(fit8_means["epsilon.6"])*exp(-0.5*(sum((L8_6 - series[,i])^2))/fit8_means["epsilon.6"])
}
dist_to_L8_7 <- c()
for (i in 1:ncol(series)) {
  dist_to_L8_7[i] <- fit8_means["theta.7"]/sqrt(fit8_means["epsilon.7"])*exp(-0.5*(sum((L8_7 - series[,i])^2))/fit8_means["epsilon.7"])
}
dist_to_L8_8 <- c()
for (i in 1:ncol(series)) {
  dist_to_L8_8[i] <- fit8_means["theta.8"]/sqrt(fit8_means["epsilon.8"])*exp(-0.5*(sum((L8_8 - series[,i])^2))/fit8_means["epsilon.8"])
}

Ldist8 <- data.frame(dist_to_L8_1,dist_to_L8_2,dist_to_L8_3,dist_to_L8_4,dist_to_L8_5,dist_to_L8_6,dist_to_L8_7,dist_to_L8_8)
assignments8 <- c(apply(Ldist8,1,max1))

plot(1:nrow(series),series[,1],type = "l",col=assignments8[1],xlab = "Time",ylab = "",ylim = c(-8,10),main="8")
for (i in 1:ncol(series)) {
  lines(1:nrow(series),series[,i],type = "l",col=assignments8[i])
}

dev.off()
```

2.5 Five components
```{r,eval=FALSE,include=TRUE}
png(file ="./figures/figure2-16.png",width = 480)
data <- as.list(fromJSON(file="~/results/8_mallia_5_10k/data/data.json"))
series <- t(matrix(unlist(data$z),ncol = 63, nrow = 100))
ts.plot(series,ylim=c(-5,8),main="Simulated data, 5 components")
dev.off()
```


```{r,eval=FALSE,include=TRUE}
data1 <- read.csv("~/results/8_mallia_5_10k/goldStandardChains/1/1GSC1.csv")
data2 <- read.csv("~/results/8_mallia_5_10k/goldStandardChains/2/2GSC1.csv")
data3 <- read.csv("~/results/8_mallia_5_10k/goldStandardChains/3/3GSC1.csv")
data4 <- read.csv("~/results/8_mallia_5_10k/goldStandardChains/4/4GSC1.csv")
data5 <- read.csv("~/results/8_mallia_5_10k/goldStandardChains/5/5GSC1.csv")
data6 <- read.csv("~/results/8_mallia_5_10k/goldStandardChains/6/6GSC1.csv")
data7 <- read.csv("~/results/8_mallia_5_10k/goldStandardChains/7/7GSC1.csv")
data8 <- read.csv("~/results/8_mallia_5_10k/goldStandardChains/8/8GSC1.csv")

fit1_means <- apply(data1,2,median)
fit2_means <- apply(data2,2,median)
fit3_means <- apply(data3,2,median)
fit4_means <- apply(data4,2,median)
fit5_means <- apply(data5,2,median)
fit6_means <- apply(data6,2,median)
fit7_means <- apply(data7,2,median)
fit8_means <- apply(data8,2,median)

l1_1 <- paste('l.',1:63,sep='')
l1 <- paste('l.1.',1:63,sep='')
l2 <- paste('l.2.',1:63,sep='')
l3 <- paste('l.3.',1:63,sep='')
l4 <- paste('l.4.',1:63,sep='')
l5 <- paste('l.5.',1:63,sep='')
l6 <- paste('l.6.',1:63,sep='')
l7 <- paste('l.7.',1:63,sep='')
l8 <- paste('l.8.',1:63,sep='')
```

```{r,eval=FALSE,include=TRUE}
png(file ="./figures/figure2-17.png",width = 1440,height = 960 )
par(mfrow=c(2,4))

#1
L1_1 <-fit1_means[l1_1]

ts.plot(series, col="gray",ylim=c(-8,10),main="1")


lines(1:63,L1_1,"l",col="red", lwd=2 ,lty=4)

#2
L2_1 <- fit2_means[l1]
L2_2 <- fit2_means[l2]

ts.plot(series, col="gray",ylim=c(-8,10),main="2")
lines(1:63,L2_1,"l",col="red", lwd=2 ,lty=4)
lines(1:63,L2_2,"l",col="blue", lwd=2 ,lty=4)

#3
L3_1 <- fit3_means[l1]
L3_2 <- fit3_means[l2]
L3_3 <- fit3_means[l3]

ts.plot(series, col="gray",ylim=c(-8,10),main="3")
lines(1:63,L3_1,"l",col="red", lwd=2 ,lty=4)
lines(1:63,L3_2,"l",col="blue", lwd=2 ,lty=4)
lines(1:63,L3_3,"l",col="black", lwd=2 ,lty=4)

#4
L4_1 <- fit4_means[l1]
L4_2 <- fit4_means[l2]
L4_3 <- fit4_means[l3]
L4_4 <- fit4_means[l4]

ts.plot(series, col="gray",ylim=c(-8,10),main="4")
lines(1:63,L4_1,"l",col="red", lwd=2 ,lty=4)
lines(1:63,L4_2,"l",col="blue", lwd=2 ,lty=4)
lines(1:63,L4_3,"l",col="black", lwd=2 ,lty=4)
lines(1:63,L4_4,"l",col="purple", lwd=2 ,lty=4)

#5
L5_1 <- fit5_means[l1]
L5_2 <- fit5_means[l2]
L5_3 <- fit5_means[l3]
L5_4 <- fit5_means[l4]
L5_5 <- fit5_means[l5]

ts.plot(series, col="gray",ylim=c(-8,10),main="5")
lines(1:63,L5_1,"l",col="red", lwd=2 ,lty=4)
lines(1:63,L5_2,"l",col="blue", lwd=2 ,lty=4)
lines(1:63,L5_3,"l",col="black", lwd=2 ,lty=4)
lines(1:63,L5_4,"l",col="purple", lwd=2 ,lty=4)
lines(1:63,L5_5,"l",col="green", lwd=2 ,lty=4)

#6
L6_1 <- fit6_means[l1]
L6_2 <- fit6_means[l2]
L6_3 <- fit6_means[l3]
L6_4 <- fit6_means[l4]
L6_5 <- fit6_means[l5]
L6_6 <- fit6_means[l6]

ts.plot(series, col="gray",ylim=c(-8,10),main="6")
lines(1:63,L6_1,"l",col="red", lwd=2 ,lty=4)
lines(1:63,L6_2,"l",col="blue", lwd=2 ,lty=4)
lines(1:63,L6_3,"l",col="black", lwd=2 ,lty=4)
lines(1:63,L6_4,"l",col="purple", lwd=2 ,lty=4)
lines(1:63,L6_5,"l",col="green", lwd=2 ,lty=4)
lines(1:63,L6_6,"l",col="cyan", lwd=2 ,lty=4)

#7
L7_1 <- fit7_means[l1]
L7_2 <- fit7_means[l2]
L7_3 <- fit7_means[l3]
L7_4 <- fit7_means[l4]
L7_5 <- fit7_means[l5]
L7_6 <- fit7_means[l6]
L7_7 <- fit7_means[l7]

ts.plot(series, col="gray",ylim=c(-8,10),main="7")
lines(1:63,L7_1,"l",col="red", lwd=2 ,lty=4)
lines(1:63,L7_2,"l",col="blue", lwd=2 ,lty=4)
lines(1:63,L7_3,"l",col="black", lwd=2 ,lty=4)
lines(1:63,L7_4,"l",col="purple", lwd=2 ,lty=4)
lines(1:63,L7_5,"l",col="green", lwd=2 ,lty=4)
lines(1:63,L7_6,"l",col="cyan", lwd=2 ,lty=4)
lines(1:63,L7_7,"l",col="brown4", lwd=2 ,lty=4)

#8
L8_1 <- fit8_means[l1]
L8_2 <- fit8_means[l2]
L8_3 <- fit8_means[l3]
L8_4 <- fit8_means[l4]
L8_5 <- fit8_means[l5]
L8_6 <- fit8_means[l6]
L8_7 <- fit8_means[l7]
L8_8 <- fit8_means[l8]

ts.plot(series, col="gray",ylim=c(-8,10),main="8")
lines(1:63,L8_1,"l",col="red", lwd=2 ,lty=4)
lines(1:63,L8_2,"l",col="blue", lwd=2 ,lty=4)
lines(1:63,L8_3,"l",col="black", lwd=2 ,lty=4)
lines(1:63,L8_4,"l",col="purple", lwd=2 ,lty=4)
lines(1:63,L8_5,"l",col="green", lwd=2 ,lty=4)
lines(1:63,L8_6,"l",col="cyan", lwd=2 ,lty=4)
lines(1:63,L8_7,"l",col="brown4", lwd=2 ,lty=4)
lines(1:63,L8_8,"l",col="cornflowerblue", lwd=2 ,lty=4)

dev.off()
```

```{r,echo=FALSE}
centers5 <- data.frame(L1 = 2*sin(x),L2 = 2*cos(x),L3 = sqrt(3+2*x),L4 = -0.5-x*sin(x),L5 = rep(8,63))
estimates5.1 <- data.frame(L1_1)
estimates5.2 <- data.frame(L2_1,L2_2)
estimates5.3 <- data.frame(L3_1,L3_2,L3_3)
estimates5.4 <- data.frame(L4_1,L4_2,L4_3,L4_4)
estimates5.5 <- data.frame(L5_1,L5_2,L5_3,L5_4,L5_5)
estimates5.6 <- data.frame(L6_1,L6_2,L6_3,L6_4,L6_5,L6_6)
estimates5.7 <- data.frame(L7_1,L7_2,L7_3,L7_4,L7_5,L7_6,L7_7)
estimates5.8 <- data.frame(L8_1,L8_2,L8_3,L8_4,L8_5,L8_6,L8_7,L8_8)

center_mse(centers5,estimates5.1)
center_mse(centers5,estimates5.2)
center_mse(centers5,estimates5.3)
center_mse(centers5,estimates5.4)
center_mse(centers5,estimates5.5)
center_mse(centers5,estimates5.6)
center_mse(centers5,estimates5.7)
center_mse(centers5,estimates5.8)

```

2.5.1 Clusters for the 5 components data

```{r,eval=FALSE,include=TRUE}
png(file ="./figures/figure2-18.png",width = 1440,height = 960 )
par(mfrow=c(2,4))

ts.plot(series,main="1",ylim = c(-8,10))

dist_to_L2_1 <- c()
for (i in 1:ncol(series)) {
  dist_to_L2_1[i] <- fit2_means["theta.1"]/sqrt(fit2_means["epsilon.1"])*exp(-0.5*(sum((L2_1 - series[,i])^2))/fit2_means["epsilon.1"])
}
dist_to_L2_2 <- c()
for (i in 1:ncol(series)) {
  dist_to_L2_2[i] <- fit2_means["theta.2"]/sqrt(fit2_means["epsilon.2"])*exp(-0.5*(sum((L2_2 - series[,i])^2))/fit2_means["epsilon.2"])
}

Ldist2 <- data.frame(dist_to_L2_1,dist_to_L2_2)
assignments2 <- c(apply(Ldist2,1,max1))

plot(1:nrow(series),series[,1],type = "l",col=assignments2[1],xlab = "Time",ylab = "",ylim = c(-8,10),main="2")
for (i in 1:ncol(series)) {
  lines(1:nrow(series),series[,i],type = "l",col=assignments2[i])
}

dist_to_L3_1 <- c()
for (i in 1:ncol(series)) {
  dist_to_L3_1[i] <- fit3_means["theta.1"]/sqrt(fit3_means["epsilon.1"])*exp(-0.5*(sum((L3_1 - series[,i])^2))/fit3_means["epsilon.1"])
}
dist_to_L3_2 <- c()
for (i in 1:ncol(series)) {
  dist_to_L3_2[i] <- fit3_means["theta.2"]/sqrt(fit3_means["epsilon.2"])*exp(-0.5*(sum((L3_2 - series[,i])^2))/fit3_means["epsilon.2"])
}
dist_to_L3_3 <- c()
for (i in 1:ncol(series)) {
  dist_to_L3_3[i] <- fit3_means["theta.3"]/sqrt(fit3_means["epsilon.3"])*exp(-0.5*(sum((L3_3 - series[,i])^2))/fit3_means["epsilon.3"])
}

Ldist3 <- data.frame(dist_to_L3_1,dist_to_L3_2,dist_to_L3_3)
assignments3 <- c(apply(Ldist3,1,max1))

plot(1:nrow(series),series[,1],type = "l",col=assignments3[1],xlab = "Time",ylab = "",ylim = c(-8,10),main="3")
for (i in 1:ncol(series)) {
  lines(1:nrow(series),series[,i],type = "l",col=assignments3[i])
}

dist_to_L4_1 <- c()
for (i in 1:ncol(series)) {
  dist_to_L4_1[i] <- fit4_means["theta.1"]/sqrt(fit4_means["epsilon.1"])*exp(-0.5*(sum((L4_1 - series[,i])^2))/fit4_means["epsilon.1"])
}
dist_to_L4_2 <- c()
for (i in 1:ncol(series)) {
  dist_to_L4_2[i] <- fit4_means["theta.2"]/sqrt(fit4_means["epsilon.2"])*exp(-0.5*(sum((L4_2 - series[,i])^2))/fit4_means["epsilon.2"])
}
dist_to_L4_3 <- c()
for (i in 1:ncol(series)) {
  dist_to_L4_3[i] <- fit4_means["theta.3"]/sqrt(fit4_means["epsilon.3"])*exp(-0.5*(sum((L4_3 - series[,i])^2))/fit4_means["epsilon.3"])
}
dist_to_L4_4 <- c()
for (i in 1:ncol(series)) {
  dist_to_L4_4[i] <- fit4_means["theta.4"]/sqrt(fit4_means["epsilon.4"])*exp(-0.5*(sum((L4_4 - series[,i])^2))/fit4_means["epsilon.4"])
}

Ldist4 <- data.frame(dist_to_L4_1,dist_to_L4_2,dist_to_L4_3,dist_to_L4_4)
assignments4 <- c(apply(Ldist4,1,max1))

plot(1:nrow(series),series[,1],type = "l",col=assignments4[1],xlab = "Time",ylab = "",ylim = c(-8,10),main="4")
for (i in 1:ncol(series)) {
  lines(1:nrow(series),series[,i],type = "l",col=assignments4[i])
}

dist_to_L5_1 <- c()
for (i in 1:ncol(series)) {
  dist_to_L5_1[i] <- fit5_means["theta.1"]/sqrt(fit5_means["epsilon.1"])*exp(-0.5*(sum((L5_1 - series[,i])^2))/fit5_means["epsilon.1"])
}
dist_to_L5_2 <- c()
for (i in 1:ncol(series)) {
  dist_to_L5_2[i] <- fit5_means["theta.2"]/sqrt(fit5_means["epsilon.2"])*exp(-0.5*(sum((L5_2 - series[,i])^2))/fit5_means["epsilon.2"])
}
dist_to_L5_3 <- c()
for (i in 1:ncol(series)) {
  dist_to_L5_3[i] <- fit5_means["theta.3"]/sqrt(fit5_means["epsilon.3"])*exp(-0.5*(sum((L5_3 - series[,i])^2))/fit5_means["epsilon.3"])
}
dist_to_L5_4 <- c()
for (i in 1:ncol(series)) {
  dist_to_L5_4[i] <- fit5_means["theta.4"]/sqrt(fit5_means["epsilon.4"])*exp(-0.5*(sum((L5_4 - series[,i])^2))/fit5_means["epsilon.4"])
}
dist_to_L5_5 <- c()
for (i in 1:ncol(series)) {
  dist_to_L5_5[i] <- fit5_means["theta.5"]/sqrt(fit5_means["epsilon.5"])*exp(-0.5*(sum((L5_5 - series[,i])^2))/fit5_means["epsilon.5"])
}

Ldist5 <- data.frame(dist_to_L5_1,dist_to_L5_2,dist_to_L5_3,dist_to_L5_4,dist_to_L5_5)
assignments5 <- c(apply(Ldist5,1,max1))

plot(1:nrow(series),series[,1],type = "l",col=assignments5[1],xlab = "Time",ylab = "",ylim = c(-8,10),main=5)
for (i in 1:ncol(series)) {
  lines(1:nrow(series),series[,i],type = "l",col=assignments5[i])
}

dist_to_L6_1 <- c()
for (i in 1:ncol(series)) {
  dist_to_L6_1[i] <- fit6_means["theta.1"]/sqrt(fit6_means["epsilon.1"])*exp(-0.5*(sum((L6_1 - series[,i])^2))/fit6_means["epsilon.1"])
}
dist_to_L6_2 <- c()
for (i in 1:ncol(series)) {
  dist_to_L6_2[i] <- fit6_means["theta.2"]/sqrt(fit6_means["epsilon.2"])*exp(-0.5*(sum((L6_2 - series[,i])^2))/fit6_means["epsilon.2"])
}
dist_to_L6_3 <- c()
for (i in 1:ncol(series)) {
  dist_to_L6_3[i] <- fit6_means["theta.3"]/sqrt(fit6_means["epsilon.3"])*exp(-0.5*(sum((L6_3 - series[,i])^2))/fit6_means["epsilon.3"])
}
dist_to_L6_4 <- c()
for (i in 1:ncol(series)) {
  dist_to_L6_4[i] <- fit6_means["theta.4"]/sqrt(fit6_means["epsilon.4"])*exp(-0.5*(sum((L6_4 - series[,i])^2))/fit6_means["epsilon.4"])
}
dist_to_L6_5 <- c()
for (i in 1:ncol(series)) {
  dist_to_L6_5[i] <- fit6_means["theta.5"]/sqrt(fit6_means["epsilon.5"])*exp(-0.5*(sum((L6_5 - series[,i])^2))/fit6_means["epsilon.5"])
}
dist_to_L6_6 <- c()
for (i in 1:ncol(series)) {
  dist_to_L6_6[i] <- fit6_means["theta.6"]/sqrt(fit6_means["epsilon.6"])*exp(-0.5*(sum((L6_6 - series[,i])^2))/fit6_means["epsilon.6"])
}

Ldist6 <- data.frame(dist_to_L6_1,dist_to_L6_2,dist_to_L6_3,dist_to_L6_4,dist_to_L6_5,dist_to_L6_6)
assignments6 <- c(apply(Ldist6,1,max1))

plot(1:nrow(series),series[,1],type = "l",col=assignments6[1],xlab = "Time",ylab = "",ylim = c(-8,10),main="6")
for (i in 1:ncol(series)) {
  lines(1:nrow(series),series[,i],type = "l",col=assignments6[i])
}

dist_to_L7_1 <- c()
for (i in 1:ncol(series)) {
  dist_to_L7_1[i] <- fit7_means["theta.1"]/sqrt(fit7_means["epsilon.1"])*exp(-0.5*(sum((L7_1 - series[,i])^2))/fit7_means["epsilon.1"])
}
dist_to_L7_2 <- c()
for (i in 1:ncol(series)) {
  dist_to_L7_2[i] <- fit7_means["theta.2"]/sqrt(fit7_means["epsilon.2"])*exp(-0.5*(sum((L7_2 - series[,i])^2))/fit7_means["epsilon.2"])
}
dist_to_L7_3 <- c()
for (i in 1:ncol(series)) {
  dist_to_L7_3[i] <- fit7_means["theta.3"]/sqrt(fit7_means["epsilon.3"])*exp(-0.5*(sum((L7_3 - series[,i])^2))/fit7_means["epsilon.3"])
}
dist_to_L7_4 <- c()
for (i in 1:ncol(series)) {
  dist_to_L7_4[i] <- fit7_means["theta.4"]/sqrt(fit7_means["epsilon.4"])*exp(-0.5*(sum((L7_4 - series[,i])^2))/fit7_means["epsilon.4"])
}
dist_to_L7_5 <- c()
for (i in 1:ncol(series)) {
  dist_to_L7_5[i] <- fit7_means["theta.5"]/sqrt(fit7_means["epsilon.5"])*exp(-0.5*(sum((L7_5 - series[,i])^2))/fit7_means["epsilon.5"])
}
dist_to_L7_6 <- c()
for (i in 1:ncol(series)) {
  dist_to_L7_6[i] <- fit7_means["theta.6"]/sqrt(fit7_means["epsilon.6"])*exp(-0.5*(sum((L7_6 - series[,i])^2))/fit7_means["epsilon.6"])
}
dist_to_L7_7 <- c()
for (i in 1:ncol(series)) {
  dist_to_L7_7[i] <- fit7_means["theta.7"]/sqrt(fit7_means["epsilon.7"])*exp(-0.5*(sum((L7_7 - series[,i])^2))/fit7_means["epsilon.7"])
}

Ldist7 <- data.frame(dist_to_L7_1,dist_to_L7_2,dist_to_L7_3,dist_to_L7_4,dist_to_L7_5,dist_to_L7_6,dist_to_L7_7)
assignments7 <- c(apply(Ldist7,1,max1))

plot(1:nrow(series),series[,1],type = "l",col=assignments7[1],xlab = "Time",ylab = "",ylim = c(-8,10),main="7")
for (i in 1:ncol(series)) {
  lines(1:nrow(series),series[,i],type = "l",col=assignments7[i])
}

dist_to_L8_1 <- c()
for (i in 1:ncol(series)) {
  dist_to_L8_1[i] <- fit8_means["theta.1"]/sqrt(fit8_means["epsilon.1"])*exp(-0.5*(sum((L8_1 - series[,i])^2))/fit8_means["epsilon.1"])
}
dist_to_L8_2 <- c()
for (i in 1:ncol(series)) {
  dist_to_L8_2[i] <- fit8_means["theta.2"]/sqrt(fit8_means["epsilon.2"])*exp(-0.5*(sum((L8_2 - series[,i])^2))/fit8_means["epsilon.2"])
}
dist_to_L8_3 <- c()
for (i in 1:ncol(series)) {
  dist_to_L8_3[i] <- fit8_means["theta.3"]/sqrt(fit8_means["epsilon.3"])*exp(-0.5*(sum((L8_3 - series[,i])^2))/fit8_means["epsilon.3"])
}
dist_to_L8_4 <- c()
for (i in 1:ncol(series)) {
  dist_to_L8_4[i] <- fit8_means["theta.4"]/sqrt(fit8_means["epsilon.4"])*exp(-0.5*(sum((L8_4 - series[,i])^2))/fit8_means["epsilon.4"])
}
dist_to_L8_5 <- c()
for (i in 1:ncol(series)) {
  dist_to_L8_5[i] <- fit8_means["theta.5"]/sqrt(fit8_means["epsilon.5"])*exp(-0.5*(sum((L8_5 - series[,i])^2))/fit8_means["epsilon.5"])
}
dist_to_L8_6 <- c()
for (i in 1:ncol(series)) {
  dist_to_L8_6[i] <- fit8_means["theta.6"]/sqrt(fit8_means["epsilon.6"])*exp(-0.5*(sum((L8_6 - series[,i])^2))/fit8_means["epsilon.6"])
}
dist_to_L8_7 <- c()
for (i in 1:ncol(series)) {
  dist_to_L8_7[i] <- fit8_means["theta.7"]/sqrt(fit8_means["epsilon.7"])*exp(-0.5*(sum((L8_7 - series[,i])^2))/fit8_means["epsilon.7"])
}
dist_to_L8_8 <- c()
for (i in 1:ncol(series)) {
  dist_to_L8_8[i] <- fit8_means["theta.8"]/sqrt(fit8_means["epsilon.8"])*exp(-0.5*(sum((L8_8 - series[,i])^2))/fit8_means["epsilon.8"])
}

Ldist8 <- data.frame(dist_to_L8_1,dist_to_L8_2,dist_to_L8_3,dist_to_L8_4,dist_to_L8_5,dist_to_L8_6,dist_to_L8_7,dist_to_L8_8)
assignments8 <- c(apply(Ldist8,1,max1))

plot(1:nrow(series),series[,1],type = "l",col=assignments8[1],xlab = "Time",ylab = "",ylim = c(-8,10),main="8")
for (i in 1:ncol(series)) {
  lines(1:nrow(series),series[,i],type = "l",col=assignments8[i])
}

dev.off()
```

2.6. Assignments and estimated mixture weights; Rectified model posterior distributions

2.6.1 Single component
```{r,echo=FALSE}
round(table(assignments2)/100,5);round(fit2_means[c("theta.1","theta.2")],5)
round(table(assignments3)/100,5);round(fit3_means[c("theta.1","theta.2","theta.3")],5)
round(table(assignments4)/100,5);round(fit4_means[c("theta.1","theta.2","theta.3","theta.4")],5)
round(table(assignments5)/100,5);round(fit5_means[c("theta.1","theta.2","theta.3","theta.4","theta.5")],5)
round(table(assignments6)/100,5);round(fit6_means[c("theta.1","theta.2","theta.3","theta.4","theta.5","theta.6")],5)
round(table(assignments7)/100,5);round(fit7_means[c("theta.1","theta.2","theta.3","theta.4","theta.5","theta.6","theta.7")],5)
round(table(assignments8)/100,5);round(fit8_means[c("theta.1","theta.2","theta.3","theta.4","theta.5","theta.6","theta.7","theta.8")],5)
```

|                  	| K 	| Theta.1 	| Theta.2 	| Theta.3 	| Theta.4 	| Theta.5 	| Theta.6 	| Theta.7 	| Theta.8 	|
|------------------	|:-:	|:-------:	|:-------:	|:-------:	|:-------:	|:-------:	|---------	|---------	|---------	|
| Estimates        	| 1 	|    1    	|         	|         	|         	|         	|         	|         	|         	|
|                  	| 2 	| 0.99323 	| 0.00677 	|         	|         	|         	|         	|         	|         	|
|                  	| 3 	| 0.00666 	| 0.00668 	| 0.98355 	|         	|         	|         	|         	|         	|
|                  	| 4 	| 0.00664 	| 0.00686 	| 0.00679 	| 0.97414 	|         	|         	|         	|         	|
|                  	| 5 	| 0.00688 	| 0.00653 	| 0.00665 	| 0.96451 	| 0.00674 	|         	|         	|         	|
|                  	| 6 	| 0.95521 	| 0.00652 	| 0.00664 	| 0.00664 	| 0.00662 	| 0.00644 	|         	|         	|
|                  	| 7 	| 0.00648 	| 0.00655 	| 0.00650 	| 0.94677 	| 0.00649 	| 0.00645 	| 0.00650 	|         	|
|                  	| 8 	| 0.93805 	| 0.00659 	| 0.00632 	| 0.00636 	| 0.00652 	| 0.00648 	| 0.00644 	| 0.00650 	|
|                  	|   	|         	|         	|         	|         	|         	|         	|         	|         	|
| After assignment 	| 1 	| 1       	|         	|         	|         	|         	|         	|         	|         	|
|                  	| 2 	| 1       	| 0       	|         	|         	|         	|         	|         	|         	|
|                  	| 3 	| 0       	| 0       	| 1       	|         	|         	|         	|         	|         	|
|                  	| 4 	| 0       	| 0       	| 0       	| 1       	|         	|         	|         	|         	|
|                  	| 5 	| 0       	| 0       	| 0       	| 1       	| 0       	|         	|         	|         	|
|                  	| 6 	| 1       	| 0       	| 0       	| 0       	| 0       	| 0       	|         	|         	|
|                  	| 7 	| 0       	| 0       	| 0       	| 1       	| 0       	| 0       	| 0       	|         	|
|                  	| 8 	| 1       	| 0       	| 0       	| 0       	| 0       	| 0       	| 0       	| 0       	|

```{r,eval=FALSE,include=TRUE}
png(file ="./figures/figure2-3.png",width = 960,height = 480 )
par(mfrow=c(1,2))
counts <- read.csv("~/results/8_mallia_1_10k/modelSelection/modelIndexChain1.csv")
#table(counts[10000:19999,])/(dim(counts)[1]/2)
barplot(table(counts[10000:19999,])/(dim(counts)[1]/2),space = 0,names.arg = c(1,2,3,4,5,6,7,8),main = "Model posterior distribution",xlab = "Model")
barplot(c(1,0,0,0,0,0,0,0),space = 0,names.arg = c(1,2,3,4,5,6,7,8),main = "Rectified model posterior distribution",xlab = "Number of components")
dev.off()
```

2.6.2 Two components

```{r,echo=FALSE}
round(table(assignments2)/100,5);round(fit2_means[c("theta.1","theta.2")],5)
round(table(assignments3)/100,5);round(fit3_means[c("theta.1","theta.2","theta.3")],5)
round(table(assignments4)/100,5);round(fit4_means[c("theta.1","theta.2","theta.3","theta.4")],5)
round(table(assignments5)/100,5);round(fit5_means[c("theta.1","theta.2","theta.3","theta.4","theta.5")],5)
round(table(assignments6)/100,5);round(fit6_means[c("theta.1","theta.2","theta.3","theta.4","theta.5","theta.6")],5)
round(table(assignments7)/100,5);round(fit7_means[c("theta.1","theta.2","theta.3","theta.4","theta.5","theta.6","theta.7")],5)
round(table(assignments8)/100,5);round(fit8_means[c("theta.1","theta.2","theta.3","theta.4","theta.5","theta.6","theta.7","theta.8")],5)
```

|                  	| K 	| Theta.1 	| Theta.2 	| Theta.3 	| Theta.4 	| Theta.5 	| Theta.6 	| Theta.7 	| Theta.8 	|
|------------------	|:-:	|:-------:	|:-------:	|:-------:	|:-------:	|:-------:	|---------	|---------	|---------	|
| Estimates        	| 1 	|    1    	|         	|         	|         	|         	|         	|         	|         	|
|                  	| 2 	| 0.62889 	| 0.37111 	|         	|         	|         	|         	|         	|         	|
|                  	| 3 	| 0.36823 	| 0.00677 	| 0.62231 	|         	|         	|         	|         	|         	|
|                  	| 4 	| 0.00679 	| 0.00672 	| 0.61629 	| 0.36443 	|         	|         	|         	|         	|
|                  	| 5 	| 0.00664 	| 0.00672 	| 0.61018 	| 0.36157 	| 0.00668 	|         	|         	|         	|
|                  	| 6 	| 0.00654 	| 0.00652 	| 0.60523 	| 0.35700 	| 0.00663 	| 0.00647 	|         	|         	|
|                  	| 7 	| 0.00632 	| 0.00646 	| 0.59852 	| 0.35465 	| 0.00654 	| 0.00655 	| 0.00655 	|         	|
|                  	| 8 	| 0.00635 	| 0.00641 	| 0.59384 	| 0.35080 	| 0.00644 	| 0.00632 	| 0.00640 	| 0.00650 	|
|                  	|   	|         	|         	|         	|         	|         	|         	|         	|         	|
| After assignment 	| 1 	| 1       	|         	|         	|         	|         	|         	|         	|         	|
|                  	| 2 	| 0.63    	| 0.37    	|         	|         	|         	|         	|         	|         	|
|                  	| 3 	| 0       	| 0       	| 0.63    	|         	|         	|         	|         	|         	|
|                  	| 4 	| 0       	| 0       	| 0.63    	| 0.37    	|         	|         	|         	|         	|
|                  	| 5 	| 0       	| 0       	| 0.63    	| 0.37    	| 0       	|         	|         	|         	|
|                  	| 6 	| 0       	| 0       	| 0.63    	| 0.37    	| 0       	| 0       	|         	|         	|
|                  	| 7 	| 0       	| 0       	| 0.63    	| 0.37    	| 0       	| 0       	| 0       	|         	|
|                  	| 8 	| 0       	| 0       	| 0.63    	| 0.37    	| 0       	| 0       	| 0       	| 0       	|

```{r,eval=FALSE,include=TRUE}
png(file ="./figures/figure2-7.png",width = 960,height = 480 )
par(mfrow=c(1,2))
counts <- read.csv("~/results/8_mallia_2_10k/modelSelection/modelIndexChain1.csv")
#table(counts[10000:19999,])/(dim(counts)[1]/2)
barplot(table(counts[10000:19999,])/(dim(counts)[1]/2),space = 0,names.arg = c(1,2,3,4,5,6,7,8),main = "Model posterior distribution",xlab = "Model")
barplot(c(0.12840642,0.05440272 +0.08720436 +0.09570479 +0.11380569 +0.13660683 +0.16560828 +0.21831092,0,0,0,0,0,0),space = 0,names.arg = c(1,2,3,4,5,6,7,8),main = "Rectified model posterior distribution",xlab = "Number of components")
dev.off()
```

2.6.3 Three components
```{r,echo=FALSE}
round(table(assignments2)/100,5);round(fit2_means[c("theta.1","theta.2")],5)
round(table(assignments3)/100,5);round(fit3_means[c("theta.1","theta.2","theta.3")],5)
round(table(assignments4)/100,5);round(fit4_means[c("theta.1","theta.2","theta.3","theta.4")],5)
round(table(assignments5)/100,5);round(fit5_means[c("theta.1","theta.2","theta.3","theta.4","theta.5")],5)
round(table(assignments6)/100,5);round(fit6_means[c("theta.1","theta.2","theta.3","theta.4","theta.5","theta.6")],5)
round(table(assignments7)/100,5);round(fit7_means[c("theta.1","theta.2","theta.3","theta.4","theta.5","theta.6","theta.7")],5)
round(table(assignments8)/100,5);round(fit8_means[c("theta.1","theta.2","theta.3","theta.4","theta.5","theta.6","theta.7","theta.8")],5)
```

|                  	| K 	| Theta.1 	| Theta.2 	| Theta.3 	| Theta.4 	| Theta.5 	| Theta.6 	| Theta.7 	| Theta.8 	|
|------------------	|:-:	|:-------:	|:-------:	|:-------:	|:-------:	|:-------:	|---------	|---------	|---------	|
| Estimates        	| 1 	|    1    	|         	|         	|         	|         	|         	|         	|         	|
|                  	| 2 	| 0.28264 	| 0.71736 	|         	|         	|         	|         	|         	|         	|
|                  	| 3 	| 0.28060 	| 0.30928 	| 0.40686 	|         	|         	|         	|         	|         	|
|                  	| 4 	| 0.30683 	| 0.00683 	| 0.27606 	| 0.40360 	|         	|         	|         	|         	|
|                  	| 5 	| 0.00929 	| 0.00668 	| 0.30328 	| 0.39988 	| 0.26325 	|         	|         	|         	|
|                  	| 6 	| 0.13207 	| 0.00814 	| 0.30073 	| 0.39618 	| 0.13566 	| 0.00680 	|         	|         	|
|                  	| 7 	| 0.00658 	| 0.00623 	| 0.00664 	| 0.39147 	| 0.00793 	| 0.26208 	| 0.29794 	|         	|
|                  	| 8 	| 0.00657 	| 0.00650 	| 0.29488 	| 0.38931 	| 0.18099 	| 0.07635 	| 0.00717 	| 0.00668 	|
|                  	|   	|         	|         	|         	|         	|         	|         	|         	|         	|
| After assignment 	| 1 	| 1       	|         	|         	|         	|         	|         	|         	|         	|
|                  	| 2 	| 0.28    	| 0.72    	|         	|         	|         	|         	|         	|         	|
|                  	| 3 	| 0.28    	| 0.31    	| 0.41    	|         	|         	|         	|         	|         	|
|                  	| 4 	| 0.31    	| 0       	| 0.28    	| 0.41    	|         	|         	|         	|         	|
|                  	| 5 	| 0       	| 0       	| 0.31    	| 0.41    	| 0.28    	|         	|         	|         	|
|                  	| 6 	| 0.15    	| 0       	| 0.31    	| 0.41    	| 0.13    	| 0       	|         	|         	|
|                  	| 7 	| 0       	| 0       	| 0       	| 0.41    	| 0       	| 0.28    	| 0.31    	|         	|
|                  	| 8 	| 0       	| 0       	| 0.31    	| 0.41    	| 0.16    	| 0.12    	| 0       	| 0       	|

```{r,eval=FALSE,include=TRUE}
png(file ="./figures/figure2-11.png",width = 960,height = 480 )
par(mfrow=c(1,2))
#counts <- read.csv("~/results/8_mallia_3_10k/modelSelection/modelIndexChain1.csv")
table(counts[10000:19999,])/(dim(counts)[1]/2)
barplot(table(counts[10000:19999,])/(dim(counts)[1]/2),space = 0,names.arg = c(1,2,3,4,5,6,7,8),main = "Model posterior distribution",xlab = "Model")
barplot(c(0.13120656, 0.09790490,0.07600380+0.11620581+0.08430422+0.16490825,0.13790690+0.19160958,0,0,0,0),space = 0,names.arg = c(1,2,3,4,5,6,7,8),main = "Rectified model posterior distribution",xlab = "Number of components")
dev.off()
```

```{r,echo=FALSE,include=FALSE}
#png(file ="./figures/figure2-11.png",width = 960,height = 480 )
par(mfrow=c(1,2))
counts <- read.csv("~/results/8_mallia_3_10k/modelSelection/modelIndexChain1.csv")
table(counts[10000:19999,])/(dim(counts)[1]/2)
barplot(table(counts[10000:19999,])/(dim(counts)[1]/2),space = 0,names.arg = c(1,2,3,4,5,6,7,8),main = "Model posterior distribution",xlab = "Model")
barplot(c(0.13120656, 0.09790490,0.07600380+0.11620581+0.08430422+0.16490825,0.13790690+0.19160958,0,0,0,0),space = 0,names.arg = c(1,2,3,4,5,6,7,8),main = "Rectified model posterior distribution",xlab = "Number of components")
#dev.off()
```


2.6.4 Four components

```{r,echo=FALSE}
round(table(assignments2)/100,5);round(fit2_means[c("theta.1","theta.2")],5)
round(table(assignments3)/100,5);round(fit3_means[c("theta.1","theta.2","theta.3")],5)
round(table(assignments4)/100,5);round(fit4_means[c("theta.1","theta.2","theta.3","theta.4")],5)
round(table(assignments5)/100,5);round(fit5_means[c("theta.1","theta.2","theta.3","theta.4","theta.5")],5)
round(table(assignments6)/100,5);round(fit6_means[c("theta.1","theta.2","theta.3","theta.4","theta.5","theta.6")],5)
round(table(assignments7)/100,5);round(fit7_means[c("theta.1","theta.2","theta.3","theta.4","theta.5","theta.6","theta.7")],5)
round(table(assignments8)/100,5);round(fit8_means[c("theta.1","theta.2","theta.3","theta.4","theta.5","theta.6","theta.7","theta.8")],5)
```

|                  	| K 	| Theta.1 	| Theta.2 	| Theta.3 	| Theta.4 	| Theta.5 	| Theta.6 	| Theta.7 	| Theta.8 	|
|------------------	|:-:	|:-------:	|:-------:	|:-------:	|:-------:	|:-------:	|---------	|---------	|---------	|
| Estimates        	| 1 	|    1    	|         	|         	|         	|         	|         	|         	|         	|
|                  	| 2 	| 0.31316 	| 0.68684 	|         	|         	|         	|         	|         	|         	|
|                  	| 3 	| 0.30992 	| 0.34935 	| 0.33774 	|         	|         	|         	|         	|         	|
|                  	| 4 	| 0.17060 	| 0.14219 	| 0.33595 	| 0.34497 	|         	|         	|         	|         	|
|                  	| 5 	| 0.16884 	| 0.00668 	| 0.33240 	| 0.34115 	| 0.14147 	|         	|         	|         	|
|                  	| 6 	| 0.16800 	| 0.00662 	| 0.00671 	| 0.32874 	| 0.33946 	| 0.13948 	|         	|         	|
|                  	| 7 	| 0.16597 	| 0.32496 	| 0.33547 	| 0.13798 	| 0.00656 	| 0.00655 	| 0.00670 	|         	|
|                  	| 8 	| 0.00647 	| 0.00646 	| 0.16435 	| 0.32318 	| 0.00661 	| 0.00660 	| 0.33256 	| 0.13693 	|
|                  	|   	|         	|         	|         	|         	|         	|         	|         	|         	|
| After assignment 	| 1 	| 1       	|         	|         	|         	|         	|         	|         	|         	|
|                  	| 2 	| 0.31    	| 0.69    	|         	|         	|         	|         	|         	|         	|
|                  	| 3 	| 0.31    	| 0.35    	| 0.34    	|         	|         	|         	|         	|         	|
|                  	| 4 	| 0.17    	| 0.14    	| 0.34    	| 0.35    	|         	|         	|         	|         	|
|                  	| 5 	| 0.17    	| 0       	| 0.34    	| 0.35    	| 0.14    	|         	|         	|         	|
|                  	| 6 	| 0.17    	| 0       	| 0       	| 0.34    	| 0.35    	| 0.14    	|         	|         	|
|                  	| 7 	| 0.17    	| 0.34    	| 0.35    	| 0.13    	| 0.01    	| 0       	| 0       	|         	|
|                  	| 8 	| 0       	| 0       	| 0.17    	| 0.34    	| 0       	| 0       	| 0.35    	| 0.14    	|

```{r,eval=FALSE,include=TRUE}
png(file ="./figures/figure2-15.png",width = 960,height = 480 )
par(mfrow=c(1,2))
counts <- read.csv("~/results/8_mallia_4_10k/modelSelection/modelIndexChain1.csv")
#table(counts[10000:19999,])/(dim(counts)[1]/2)
barplot(table(counts[10000:19999,])/(dim(counts)[1]/2),space = 0,names.arg = c(1,2,3,4,5,6,7,8),main = "Model posterior distribution",xlab = "Model")
barplot(c(0.13030652,0.10040502,0.10990550,0.09250463+0.11370569+0.09370469+0.19440972,0.16510826,0,0,0),space = 0,names.arg = c(1,2,3,4,5,6,7,8),main = "Rectified model posterior distribution",xlab = "Number of components")
dev.off()
```

2.6.5 Five components

```{r,echo=FALSE}
round(table(assignments2)/100,5);round(fit2_means[c("theta.1","theta.2")],5)
round(table(assignments3)/100,5);round(fit3_means[c("theta.1","theta.2","theta.3")],5)
round(table(assignments4)/100,5);round(fit4_means[c("theta.1","theta.2","theta.3","theta.4")],5)
round(table(assignments5)/100,5);round(fit5_means[c("theta.1","theta.2","theta.3","theta.4","theta.5")],5)
round(table(assignments6)/100,5);round(fit6_means[c("theta.1","theta.2","theta.3","theta.4","theta.5","theta.6")],5)
round(table(assignments7)/100,5);round(fit7_means[c("theta.1","theta.2","theta.3","theta.4","theta.5","theta.6","theta.7")],5)
round(table(assignments8)/100,5);round(fit8_means[c("theta.1","theta.2","theta.3","theta.4","theta.5","theta.6","theta.7","theta.8")],5)
```

|                  	| K 	| Theta.1 	| Theta.2 	| Theta.3 	| Theta.4 	| Theta.5 	| Theta.6 	| Theta.7 	| Theta.8 	|
|------------------	|:-:	|:-------:	|:-------:	|:-------:	|:-------:	|:-------:	|---------	|---------	|---------	|
| Estimates        	| 1 	|    1    	|         	|         	|         	|         	|         	|         	|         	|
|                  	| 2 	| 0.63795 	| 0.36205 	|         	|         	|         	|         	|         	|         	|
|                  	| 3 	| 0.29871 	| 0.06462 	| 0.63352 	|         	|         	|         	|         	|         	|
|                  	| 4 	| 0.26760 	| 0.06495 	| 0.29681 	| 0.36490 	|         	|         	|         	|         	|
|                  	| 5 	| 0.12174 	| 0.06411 	| 0.26576 	| 0.36124 	| 0.17837 	|         	|         	|         	|
|                  	| 6 	| 0.11986 	| 0.00656 	| 0.35835 	| 0.17727 	| 0.26258 	| 0.06330 	|         	|         	|
|                  	| 7 	| 0.17491 	| 0.00658 	| 0.11862 	| 0.26038 	| 0.00657 	| 0.35465 	| 0.06323 	|         	|
|                  	| 8 	| 0.00657 	| 0.00655 	| 0.11810 	| 0.35077 	| 0.17404 	| 0.25790 	| 0.00659 	| 0.06232 	|
|                  	|   	|         	|         	|         	|         	|         	|         	|         	|         	|
| After assignment 	| 1 	| 1       	|         	|         	|         	|         	|         	|         	|         	|
|                  	| 2 	| 0.64    	| 0.36    	|         	|         	|         	|         	|         	|         	|
|                  	| 3 	| 0.30    	| 0.06    	| 0.64    	|         	|         	|         	|         	|         	|
|                  	| 4 	| 0.27    	| 0.06    	| 0.30    	| 0.37    	|         	|         	|         	|         	|
|                  	| 5 	| 0.12    	| 0.06    	| 0.27    	| 0.37    	| 0.18    	|         	|         	|         	|
|                  	| 6 	| 0.12    	| 0       	| 0.37    	| 0.18    	| 0.27    	| 0.06    	|         	|         	|
|                  	| 7 	| 0.18    	| 0       	| 0.12    	| 0.27    	| 0       	| 0.37    	| 0.06    	|         	|
|                  	| 8 	| 0       	| 0       	| 0.12    	| 0.37    	| 0.18    	| 0.27    	| 0       	| 0.06    	|

```{r,eval=FALSE,include=TRUE}
png(file ="./figures/figure2-19.png",width = 960,height = 480 )
par(mfrow=c(1,2))
counts <- read.csv("~/results/8_mallia_5_10k/modelSelection/modelIndexChain1.csv")
#table(counts[10000:19999,])/(dim(counts)[1]/2)
barplot(table(counts[10000:19999,])/(dim(counts)[1]/2),space = 0,names.arg = c(1,2,3,4,5,6,7,8),main = "Model posterior distribution",xlab = "Model")
barplot(c(0.12370619,0.11240562,0.11040552,0.12480624,0.10550528 +0.08740437+ 0.15920796 +0.17660883,0,0,0),space = 0,names.arg = c(1,2,3,4,5,6,7,8),main = "Rectified model posterior distribution",xlab = "Number of components")
dev.off()
```


## 3. The French mortality

This section of the notebook is a summary of the results from empirical analysis 3; the French mortality.
For R code, please refer to the source document.

This notebook is structured as follows. First, we consider Interpretation 1 of the data. We provide the results for the RJMCMC, an example Stan model, and the estimates for the mixture components and the assigned clusters, respectively. Based on these, we provide an example of the rectified model posterior distribution. We give results for the speed optimized version of the Stan model. The above are accompanied by the results from package TMixClust.
Second, the above are provided for the Interpretation 2 of the data. 

```{r,eval=FALSE,include=TRUE}
#mortality data pre-treatment

#library(dplyr)
#library(tidyr)

mortality_data <- read.table("death_rate_1x1.txt", sep = "", header = TRUE)

mortality <- as.data.frame(sapply(mortality_data, as.numeric))

mortality_year <- mortality %>% 
  select(-Male,-Female)%>%
  filter(!is.na("Age") )%>% 
  filter(Age < 101)%>%
  mutate(Total = log(Total))%>%
  spread(key = Year, value = Total)

mortality_year_age <- mortality_year["Age"]
mortality_year_deaths <- mortality_year %>% select(-"Age")

mortality_matrix <- as.matrix(mortality_year_deaths)
colnames(mortality_matrix) <- NULL
```


## Interpretation 1: 203 series of length 101

```{r,eval=FALSE,include=TRUE}
png(file ="./figures/figure3-0.png",width = 480,height = 480 )
data <- as.list(fromJSON(file="~/results/mortality_updated_4k8k/data/data.json"))
series <- (matrix(unlist(data$z),ncol = 203, nrow = 101))
ts.plot(series,main="French mortality",xlab="index")
dev.off()
```
FIGURE 0: The French mortality data set. 


## 1. Slow version

## Stan implementation of our model

Stan code for model with two components.

```{stan, output.var="ex1"}
data {
  int<lower=0> K; // # series
  int<lower=0> T; // # observations / series
  matrix[K, T] z; // data
  real<lower=0> sigma_y; // smoothing prior 
  real a;
  real b;
}
parameters {
  array[2] real<lower=0, upper=20> epsilon; // 
  simplex[2] theta; //weights
  array[2] vector[T] l; // 
  simplex[3] cht;  //order prior
}
transformed parameters {
  vector[2] log_theta;
  ordered[2] l_init;
  
  log_theta = log(theta);
  l_init = a + head(cumulative_sum(cht), 2) * (b - a); //https://groups.google.com/g/stan-users/c/04GSu-ql3vM
}
model {
  vector[2] lp; // 
  for (k in 1 : K) {
    lp = log_theta;
    for (h in 1 : 2) 
      lp[h] += normal_lpdf(z[k,  : ] | l[h,  : ], epsilon[h]);
    target += log_sum_exp(lp);
    for (h in 1 : 2) 
      target += inv_gamma_lpdf(epsilon[h] | 1, 1)
                + normal_lpdf(l_init[h] | -3, 6)
                + normal_lpdf(l[h, 1] | l_init[h], sigma_y)
                + normal_lpdf(l[h, 2 : T] | l[h, 1 : (T - 1)], sigma_y);
  }
}
generated quantities {
  real logModel;
  vector[2] log_theta2 = log_theta;
  
  for (k in 1 : K) {
    for (h in 1 : 2) 
      log_theta2[h] = log_theta2[h] + inv_gamma_lpdf(epsilon[h] | 1, 1)
                      + normal_lpdf(l_init[h] | -3, 6)
                      + normal_lpdf(l[h, 1] | l_init[h], sigma_y)
                      + normal_lpdf(l[h, 2 : T] | l[h, 1 : (T - 1)], sigma_y)
                      + normal_lpdf(z[ k , :] | l[h,  : ], epsilon[h]);
    
    logModel = log_sum_exp(log_theta2);
  }
}
```

## Results from the RJMCMC

Model posterior distribution

```{r,eval=FALSE,include=TRUE}
png(file ="./figures/figure3-1.png",width = 480,height = 480 )
modelIndexChain1 <- read.csv("~/results/mortality_up_4k8k_tarkka/modelSelection/modelIndexChain1.csv",header = F)
barplot(table(modelIndexChain1$V1[8001:16000])/(length(modelIndexChain1$V1)/2),space = 0,main = "Raw model posterior distribution", names.arg = c(2,3,4,5),xlab = "Model number")
#table(modelIndexChain1$V1[8001:16000])/(length(modelIndexChain1$V1)/2)
dev.off()
```
FIGURE 1: Raw model posterior distribution


```{r,eval=FALSE,include=TRUE}
data2 <- read.csv("~/results/mortality_up_4k8k_tarkka/goldStandardChains/2/2GSC1.csv")
data3 <- read.csv("~/results/mortality_up_4k8k_tarkka/goldStandardChains/3/3GSC1.csv")
data4 <- read.csv("~/results/mortality_up_4k8k_tarkka/goldStandardChains/4/4GSC1.csv")
data5 <- read.csv("~/results/mortality_up_4k8k_tarkka/goldStandardChains/5/5GSC1.csv")
```

```{r,eval=FALSE,include=TRUE}
fit2_means <- apply(data2,2,median)
fit3_means <- apply(data3,2,median)
fit4_means <- apply(data4,2,median)
fit5_means <- apply(data5,2,median)
```

```{r,eval=FALSE,include=TRUE}
fit2_CI <- posterior_interval(as.matrix(data2))
fit3_CI <- posterior_interval(as.matrix(data3))
fit4_CI <- posterior_interval(as.matrix(data4))
fit5_CI <- posterior_interval(as.matrix(data5))
fit6_CI <- posterior_interval(as.matrix(data6))
```

```{r,eval=FALSE,include=TRUE}
l1 <- paste('l.1.',1:101,sep='')
l2 <- paste('l.2.',1:101,sep='')
l3 <- paste('l.3.',1:101,sep='')
l4 <- paste('l.4.',1:101,sep='')
l5 <- paste('l.5.',1:101,sep='')
```

## 2 components

```{r,eval=FALSE,include=TRUE}
l1_1_CI_lb <- fit2_CI[l1,1] 
l1_1_CI_ub <- fit2_CI[l1,2] 
l1_2_CI_lb <- fit2_CI[l2,1] 
l1_2_CI_ub <- fit2_CI[l2,2]

l1_1_CI_lb2 <- fit2_CI[l1,1] -qnorm(1-0.025,0,sqrt(0.5+fit2_means["epsilon.1"]))
l1_1_CI_ub2 <- fit2_CI[l1,2] +qnorm(1-0.025,0,sqrt(0.5+fit2_means["epsilon.1"]))
l1_2_CI_lb2 <- fit2_CI[l2,1] -qnorm(1-0.025,0,sqrt(0.5+fit2_means["epsilon.2"]))
l1_2_CI_ub2 <- fit2_CI[l2,2] +qnorm(1-0.025,0,sqrt(0.5+fit2_means["epsilon.2"]))

l1_1_CI_lb3 <- fit2_CI[l1,1] -qnorm(1-0.025,0,sqrt(fit2_means["epsilon.1"]))
l1_1_CI_ub3 <- fit2_CI[l1,2] +qnorm(1-0.025,0,sqrt(fit2_means["epsilon.1"]))
l1_2_CI_lb3 <- fit2_CI[l2,1] -qnorm(1-0.025,0,sqrt(fit2_means["epsilon.2"]))
l1_2_CI_ub3 <- fit2_CI[l2,2] +qnorm(1-0.025,0,sqrt(fit2_means["epsilon.2"]))

```

Estimated mixture component centers (latent random walk process means), their 95% credible intervals (CI), 95% CI's for the mixture components, and 95% CI's with the variance of the random walk process taken into account.

```{r,eval=FALSE,include=TRUE}
png(file ="./figures/figure3-2.png",width = 960,height = 960 )
par(mfrow=c(2,2))

L2_1 <- fit2_means[l1]
L2_2 <- fit2_means[l2]

ts.plot(series,col="gray",main = "Centers, 2",xlab="index")
lines(1:101,L2_1,"l",col="red")
lines(1:101,L2_2,"l",col="green")

ts.plot(series,col="gray",main = "Centers, 95% CI",xlab="index")
lines(1:101,L2_1,"l",col="red")
lines(1:101,l1_1_CI_lb,"l",col="red",lty=4)
lines(1:101,l1_1_CI_ub,"l",col="red",lty=4)

lines(1:101,L2_2,"l",col="green")
lines(1:101,l1_2_CI_lb,"l",col="green",lty=4)
lines(1:101,l1_2_CI_ub,"l",col="green",lty=4)

ts.plot(series,col="gray",main = "Mixture components, 95% CI",xlab="index")
lines(1:101,L2_1,"l",col="red")
lines(1:101,l1_1_CI_lb3,"l",col="red",lty=4)
lines(1:101,l1_1_CI_ub3,"l",col="red",lty=4)

lines(1:101,L2_2,"l",col="green")
lines(1:101,l1_2_CI_lb3,"l",col="green",lty=4)
lines(1:101,l1_2_CI_ub3,"l",col="green",lty=4)

ts.plot(series,col="gray",main = "Mixture components, 95% CI, total variation" ,xlab="index")
lines(1:101,L2_1,"l",col="red")
lines(1:101,l1_1_CI_lb2,"l",col="red",lty=4)
lines(1:101,l1_1_CI_ub2,"l",col="red",lty=4)

lines(1:101,L2_2,"l",col="green")
lines(1:101,l1_2_CI_lb2,"l",col="green",lty=4)
lines(1:101,l1_2_CI_ub2,"l",col="green",lty=4)

dev.off()
```
FIGURE 2A: 

Clusters given the mixture components, no thresholding.

```{r,eval=FALSE,include=TRUE}
png(file ="./figures/figure3-3.png",width = 480,height = 480 )
dist_to_L2_1 <- c()
for (i in 1:ncol(series)) {
  dist_to_L2_1[i] <- fit2_means["theta.1"]/sqrt(fit2_means["epsilon.1"])*exp(-0.5*(sum((L2_1 - series[,i])^2))/fit2_means["epsilon.1"])
}
dist_to_L2_2 <- c()
for (i in 1:ncol(series)) {
  dist_to_L2_2[i] <- fit2_means["theta.2"]/sqrt(fit2_means["epsilon.2"])*exp(-0.5*(sum((L2_2 - series[,i])^2))/fit2_means["epsilon.2"])
}

Ldist2 <- data.frame(dist_to_L2_1,dist_to_L2_2)
assignments2 <- c(apply(Ldist2,1,max1))

plot(1:nrow(series),series[,1],type = "l",col=assignments2[1],xlab = "index",ylab ="", main= "2 components",ylim = c(-10,0))
for (i in 1:ncol(series)) {
  lines(1:nrow(series),series[,i],type = "l",col=assignments2[i])}

dev.off()

```
FIGURE 2B:

```{r,echo=FALSE}

round(table(assignments2)/203,5);round(fit2_means[c("theta.1","theta.2")],5)
```

## 3 components

Cluster centers and clusters

```{r,eval=FALSE,include=TRUE}
png(file ="./figures/figure3-4.png",width = 960,height = 480 )
par(mfrow=c(1,2))

L3_1 <- fit3_means[l1]
L3_2 <- fit3_means[l2]
L3_3 <- fit3_means[l3]

ts.plot(series,col="gray",main = "Centers, 3",xlab="index")
lines(1:101,L3_1,"l",col="red")
lines(1:101,L3_2,"l",col="green")
lines(1:101,L3_3,"l",col="blue")

dist_to_L3_1 <- c()
for (i in 1:ncol(series)) {
  dist_to_L3_1[i] <- fit3_means["theta.1"]/sqrt(fit3_means["epsilon.1"])*exp(-0.5*(sum((L3_1 - series[,i])^2))/fit3_means["epsilon.1"])
}
dist_to_L3_2 <- c()
for (i in 1:ncol(series)) {
  dist_to_L3_2[i] <- fit3_means["theta.2"]/sqrt(fit3_means["epsilon.2"])*exp(-0.5*(sum((L3_2 - series[,i])^2))/fit3_means["epsilon.2"])
}
dist_to_L3_3 <- c()
for (i in 1:ncol(series)) {
  dist_to_L3_3[i] <- fit3_means["theta.3"]/sqrt(fit3_means["epsilon.3"])*exp(-0.5*(sum((L3_3 - series[,i])^2))/fit3_means["epsilon.3"])
}

Ldist3 <- data.frame(dist_to_L3_1,dist_to_L3_2,dist_to_L3_3)
assignments3 <- c(apply(Ldist3,1,max1))

plot(1:nrow(series),series[,1],type = "l",col=assignments3[1],xlab = "index",ylab ="", main= "3 components",ylim = c(-10,0))
for (i in 1:ncol(series)) {
  lines(1:nrow(series),series[,i],type = "l",col=assignments3[i])
}
dev.off()
```
FIGURE 3A: Centers
FIGURE 3B: Clusters


```{r, echo=FALSE}
round(table(assignments3)/203,5);round(fit3_means[c("theta.1","theta.2","theta.3")],5)
```


## 4 components

Mixture component centers

```{r,eval=FALSE,include=TRUE}
png(file ="./figures/figure3-5.png",width = 960,height = 480 )
par(mfrow=c(1,2))

L4_1 <- fit4_means[l1]
L4_2 <- fit4_means[l2]
L4_3 <- fit4_means[l3]
L4_4 <- fit4_means[l4]

ts.plot(series,col="gray",main = "Centers, 4",xlab="index")
lines(1:101,L4_1,"l",col="red")
lines(1:101,L4_2,"l",col="green")
lines(1:101,L4_3,"l",col="blue")
lines(1:101,L4_4,"l",col="purple")

dist_to_L4_1 <- c()
for (i in 1:ncol(series)) {
  dist_to_L4_1[i] <- fit4_means["theta.1"]/sqrt(fit4_means["epsilon.1"])*exp(-0.5*(sum((L4_1 - series[,i])^2))/fit4_means["epsilon.1"])
}
dist_to_L4_2 <- c()
for (i in 1:ncol(series)) {
  dist_to_L4_2[i] <- fit4_means["theta.2"]/sqrt(fit4_means["epsilon.2"])*exp(-0.5*(sum((L4_2 - series[,i])^2))/fit4_means["epsilon.2"])
}
dist_to_L4_3 <- c()
for (i in 1:ncol(series)) {
  dist_to_L4_3[i] <- fit4_means["theta.3"]/sqrt(fit4_means["epsilon.3"])*exp(-0.5*(sum((L4_3 - series[,i])^2))/fit4_means["epsilon.3"])
}
dist_to_L4_4 <- c()
for (i in 1:ncol(series)) {
  dist_to_L4_4[i] <- fit4_means["theta.4"]/sqrt(fit4_means["epsilon.4"])*exp(-0.5*(sum((L4_4 - series[,i])^2))/fit4_means["epsilon.4"])
}

Ldist4 <- data.frame(dist_to_L4_1,dist_to_L4_2,dist_to_L4_3,dist_to_L4_4)
assignments4 <- c(apply(Ldist4,1,max1))

plot(1:nrow(series),series[,1],type = "l",col=assignments4[1],xlab = "index",ylab ="",main= "4 components",ylim = c(-10,0))
for (i in 1:ncol(series)) {
  lines(1:nrow(series),series[,i],type = "l",col=assignments4[i])
}
dev.off()
```
FIGURE 4A: Centers
FIGURE 4B: Clusters


```{r, echo=FALSE}

round(table(assignments4)/203,5);round(fit4_means[c("theta.1","theta.2","theta.3","theta.4")],5)
```


## 5 components

Mixture component centers

```{r,eval=FALSE,include=TRUE}
png(file ="./figures/figure3-6.png",width = 960,height = 480 )
par(mfrow=c(1,2))

L5_1 <- fit5_means[l1]
L5_2 <- fit5_means[l2]
L5_3 <- fit5_means[l3]
L5_4 <- fit5_means[l4]
L5_5 <- fit5_means[l5]

ts.plot(series,col="gray",main = "Centers, 5",xlab="index")
lines(1:101,L5_1,"l",col="red")
lines(1:101,L5_2,"l",col="green")
lines(1:101,L5_3,"l",col="blue")
lines(1:101,L5_4,"l",col="purple")
lines(1:101,L5_5,"l",col="purple")

dist_to_L5_1 <- c()
for (i in 1:ncol(series)) {
  dist_to_L5_1[i] <- fit5_means["theta.1"]/sqrt(fit5_means["epsilon.1"])*exp(-0.5*(sum((L5_1 - series[,i])^2))/fit5_means["epsilon.1"])
}
dist_to_L5_2 <- c()
for (i in 1:ncol(series)) {
  dist_to_L5_2[i] <- fit5_means["theta.2"]/sqrt(fit5_means["epsilon.2"])*exp(-0.5*(sum((L5_2 - series[,i])^2))/fit5_means["epsilon.2"])
}
dist_to_L5_3 <- c()
for (i in 1:ncol(series)) {
  dist_to_L5_3[i] <- fit5_means["theta.3"]/sqrt(fit5_means["epsilon.3"])*exp(-0.5*(sum((L5_3 - series[,i])^2))/fit5_means["epsilon.3"])
}
dist_to_L5_4 <- c()
for (i in 1:ncol(series)) {
  dist_to_L5_4[i] <- fit5_means["theta.4"]/sqrt(fit5_means["epsilon.4"])*exp(-0.5*(sum((L5_4 - series[,i])^2))/fit5_means["epsilon.4"])
}
dist_to_L5_5 <- c()
for (i in 1:ncol(series)) {
  dist_to_L5_5[i] <- fit5_means["theta.5"]/sqrt(fit5_means["epsilon.5"])*exp(-0.5*(sum((L5_5 - series[,i])^2))/fit5_means["epsilon.5"])
}
Ldist5 <- data.frame(dist_to_L5_1,dist_to_L5_2,dist_to_L5_3,dist_to_L5_4,dist_to_L5_5)
assignments5 <- c(apply(Ldist5,1,max1))

plot(1:nrow(series),series[,1],type = "l",col=assignments5[1],xlab = "index",ylab ="",main= "5 components",ylim = c(-10,0))
for (i in 1:ncol(series)) {
  lines(1:nrow(series),series[,i],type = "l",col=assignments5[i])
}
dev.off()
```
FIGURE 5A: Centers
FIGURE 5B: Clusters



```{r, echo=FALSE}

round(table(assignments5)/203,5);round(fit5_means[c("theta.1","theta.2","theta.3","theta.4","theta.5")],5)
```

|                  	| K 	| Theta.1 	| Theta.2 	| Theta.3 	| Theta.4 	| Theta.5 	|
|------------------	|:-:	|:-------:	|:-------:	|:-------:	|:-------:	|:-------:	|
| Estimates        	| 2 	| 0.63968 	| 0.36032 	|         	|         	|         	|
|                  	| 3 	| 0.26705 	| 0.35353 	| 0.37790 	|         	|         	|
|                  	| 4 	| 0.35731 	| 0.00345 	| 0.00334 	| 0.63296 	|         	|
|                  	| 5 	| 0.00328 	| 0.63024 	| 0.35549 	| 0.00335 	| 0.00335 	|
|                  	|   	|         	|         	|         	|         	|         	|
| After assignment 	| 2 	| 0.64039 	| 0.35961 	|         	|         	|         	|
|                  	| 3 	| 0.26601 	| 0.35468 	| 0.37931 	|         	|         	|
|                  	| 4 	| 0.35961 	| 0       	| 0       	| 0.64039 	|         	|
|                  	| 5 	| 0       	| 0.64039 	| 0.35961 	| 0       	| 0       	|

## Rectified model posterior distribution

```{r,eval=FALSE,include=TRUE}
png(file ="./figures/figure3-7.png",width = 480,height = 480 )
barplot(table(modelIndexChain1$V1[8001:16000])/(length(modelIndexChain1$V1)/2),space = 0,main = "Raw model posterior distribution", names.arg = c(2,3,4,5),xlab = "Model number")
dev.off()
```
FIGURE 6: Rectified model posterior distribution

## 2. Speed-optimized Stan model


```{r,eval=FALSE,include=TRUE}
data2 <- read.csv("~/results/mortality_up_4k8k_approx/goldStandardChains/2/2GSC1.csv")
data3 <- read.csv("~/results/mortality_up_4k8k_approx/goldStandardChains/3/3GSC1.csv")
data4 <- read.csv("~/results/mortality_up_4k8k_approx/goldStandardChains/4/4GSC1.csv")
data5 <- read.csv("~/results/mortality_up_4k8k_approx/goldStandardChains/5/5GSC1.csv")

```


```{stan, output.var="ex1"}
data {
  int<lower=0> K; 
  int<lower=0> T; 
  matrix[K, T] z; 
  real<lower=0> sigma_y; 
  real a;
  real b;
}
parameters {
  array[2] real<lower=0, upper=20> epsilon; 
  simplex[2] theta; 
  array[2] vector[T] l; 
  simplex[3] cht;
}
transformed parameters {
  vector[2] log_theta;
  ordered[2] l_init;
  
  log_theta = log(theta);
  l_init = a + head(cumulative_sum(cht), 2) * (b - a); //https://groups.google.com/g/stan-users/c/04GSu-ql3vM
}
model {
  vector[2] lp; 
  
  l_init ~ normal(-3, 6);
  
  for (h in 1 : 2) {
    epsilon[h] ~ inv_gamma(1, 1);
  }
  
  for (h in 1 : 2) {
    l[h, 1] ~ normal(l_init[h], sigma_y);
    for (t in 2 : T) {
      l[h, t] ~ normal(l[h, (t - 1)], sigma_y);
    }
  }
  
  for (k in 1 : K) {
    lp = log_theta;
    for (h in 1 : 2) 
      lp[h] += normal_lpdf(z[k,  : ] | l[h,  : ], epsilon[h]);
    target += log_sum_exp(lp);
  }
}
generated quantities {
  real logModel;
  vector[2] log_theta2 = log_theta;
  
  for (k in 1 : K) {
    for (h in 1 : 2) 
      log_theta2[h] = log_theta2[h] + inv_gamma_lpdf(epsilon[h] | 1, 1)
                      + normal_lpdf(l_init[h] | -3, 6)
                      + normal_lpdf(l[h, 1] | l_init[h], sigma_y)
                      + normal_lpdf(l[h, 2 : T] | l[h, 1 : (T - 1)], sigma_y)
                      + normal_lpdf(z[ k , :] | l[h,  : ], epsilon[h]);
    
    logModel = log_sum_exp(log_theta2);
  }
}

```

## Results from the RJMCMC

```{r,eval=FALSE,include=TRUE}
fit2_means <- apply(data2,2,median)
fit3_means <- apply(data3,2,median)
fit4_means <- apply(data4,2,median)
fit5_means <- apply(data5,2,median)
fit6_means <- apply(data6,2,median)
```

```{r,eval=FALSE,include=TRUE}
fit2_CI <- posterior_interval(as.matrix(data2))
fit3_CI <- posterior_interval(as.matrix(data3))
fit4_CI <- posterior_interval(as.matrix(data4))
fit5_CI <- posterior_interval(as.matrix(data5))
fit6_CI <- posterior_interval(as.matrix(data6))

l1 <- paste('l.1.',1:101,sep='')
l2 <- paste('l.2.',1:101,sep='')
l3 <- paste('l.3.',1:101,sep='')
l4 <- paste('l.4.',1:101,sep='')
l5 <- paste('l.5.',1:101,sep='')
l6 <- paste('l.6.',1:101,sep='')

```

```{r,eval=FALSE,include=TRUE}
png(file ="./figures/figure3-8.png",width = 960,height = 960 )
par(mfrow=c(2,2))

L2_1 <- fit2_means[l1]
L2_2 <- fit2_means[l2]

ts.plot(series,col="gray",main = "2",xlab="index")
lines(1:101,L2_1,"l",col="red")
lines(1:101,L2_2,"l",col="green")

L3_1 <- fit3_means[l1]
L3_2 <- fit3_means[l2]
L3_3 <- fit3_means[l3]

ts.plot(series,col="gray",main = "3",xlab="index")
lines(1:101,L3_1,"l",col="red")
lines(1:101,L3_2,"l",col="green")
lines(1:101,L3_3,"l",col="blue")

L4_1 <- fit4_means[l1]
L4_2 <- fit4_means[l2]
L4_3 <- fit4_means[l3]
L4_4 <- fit4_means[l4]

ts.plot(series,col="gray",main = "4",xlab="index")
lines(1:101,L4_1,"l",col="red")
lines(1:101,L4_2,"l",col="green")
lines(1:101,L4_3,"l",col="blue")
lines(1:101,L4_4,"l",col="purple")

L5_1 <- fit5_means[l1]
L5_2 <- fit5_means[l2]
L5_3 <- fit5_means[l3]
L5_4 <- fit5_means[l4]
L5_5 <- fit5_means[l5]

ts.plot(series,col="gray",main = "5",xlab="index")
lines(1:101,L5_1,"l",col="red")
lines(1:101,L5_2,"l",col="green")
lines(1:101,L5_3,"l",col="blue")
lines(1:101,L5_4,"l",col="purple")
lines(1:101,L5_5,"l",col="purple")
dev.off()
```
FIGURE 7A:


```{r,eval=FALSE,include=TRUE}
png(file ="./figures/figure3-9.png",width = 960,height = 960 )
par(mfrow=c(2,2))

dist_to_L2_1 <- c()
for (i in 1:ncol(series)) {
  dist_to_L2_1[i] <- fit2_means["theta.1"]/sqrt(fit2_means["epsilon.1"])*exp(-0.5*(sum((L2_1 - series[,i])^2))/fit2_means["epsilon.1"])
}
dist_to_L2_2 <- c()
for (i in 1:ncol(series)) {
  dist_to_L2_2[i] <- fit2_means["theta.2"]/sqrt(fit2_means["epsilon.2"])*exp(-0.5*(sum((L2_2 - series[,i])^2))/fit2_means["epsilon.2"])
}

Ldist2 <- data.frame(dist_to_L2_1,dist_to_L2_2)
assignments2 <- c(apply(Ldist2,1,max1))

plot(1:nrow(series),series[,1],type = "l",col=assignments2[1],xlab = "index",ylab ="", main= "2 components",ylim = c(-10,0))
for (i in 1:ncol(series)) {
  lines(1:nrow(series),series[,i],type = "l",col=assignments2[i])}

dist_to_L3_1 <- c()
for (i in 1:ncol(series)) {
  dist_to_L3_1[i] <- fit3_means["theta.1"]/sqrt(fit3_means["epsilon.1"])*exp(-0.5*(sum((L3_1 - series[,i])^2))/fit3_means["epsilon.1"])
}
dist_to_L3_2 <- c()
for (i in 1:ncol(series)) {
  dist_to_L3_2[i] <- fit3_means["theta.2"]/sqrt(fit3_means["epsilon.2"])*exp(-0.5*(sum((L3_2 - series[,i])^2))/fit3_means["epsilon.2"])
}
dist_to_L3_3 <- c()
for (i in 1:ncol(series)) {
  dist_to_L3_3[i] <- fit3_means["theta.3"]/sqrt(fit3_means["epsilon.3"])*exp(-0.5*(sum((L3_3 - series[,i])^2))/fit3_means["epsilon.3"])
}

Ldist3 <- data.frame(dist_to_L3_1,dist_to_L3_2,dist_to_L3_3)
assignments3 <- c(apply(Ldist3,1,max1))

plot(1:nrow(series),series[,1],type = "l",col=assignments3[1],xlab = "index",ylab ="", main= "3 components",ylim = c(-10,0))
for (i in 1:ncol(series)) {
  lines(1:nrow(series),series[,i],type = "l",col=assignments3[i])
}

dist_to_L4_1 <- c()
for (i in 1:ncol(series)) {
  dist_to_L4_1[i] <- fit4_means["theta.1"]/sqrt(fit4_means["epsilon.1"])*exp(-0.5*(sum((L4_1 - series[,i])^2))/fit4_means["epsilon.1"])
}
dist_to_L4_2 <- c()
for (i in 1:ncol(series)) {
  dist_to_L4_2[i] <- fit4_means["theta.2"]/sqrt(fit4_means["epsilon.2"])*exp(-0.5*(sum((L4_2 - series[,i])^2))/fit4_means["epsilon.2"])
}
dist_to_L4_3 <- c()
for (i in 1:ncol(series)) {
  dist_to_L4_3[i] <- fit4_means["theta.3"]/sqrt(fit4_means["epsilon.3"])*exp(-0.5*(sum((L4_3 - series[,i])^2))/fit4_means["epsilon.3"])
}
dist_to_L4_4 <- c()
for (i in 1:ncol(series)) {
  dist_to_L4_4[i] <- fit4_means["theta.4"]/sqrt(fit4_means["epsilon.4"])*exp(-0.5*(sum((L4_4 - series[,i])^2))/fit4_means["epsilon.4"])
}

Ldist4 <- data.frame(dist_to_L4_1,dist_to_L4_2,dist_to_L4_3,dist_to_L4_4)
assignments4 <- c(apply(Ldist4,1,max1))

plot(1:nrow(series),series[,1],type = "l",col=assignments4[1],xlab = "index",ylab ="",main= "4 components",ylim = c(-10,0))
for (i in 1:ncol(series)) {
  lines(1:nrow(series),series[,i],type = "l",col=assignments4[i])
}

dist_to_L5_1 <- c()
for (i in 1:ncol(series)) {
  dist_to_L5_1[i] <- fit5_means["theta.1"]/sqrt(fit5_means["epsilon.1"])*exp(-0.5*(sum((L5_1 - series[,i])^2))/fit5_means["epsilon.1"])
}
dist_to_L5_2 <- c()
for (i in 1:ncol(series)) {
  dist_to_L5_2[i] <- fit5_means["theta.2"]/sqrt(fit5_means["epsilon.2"])*exp(-0.5*(sum((L5_2 - series[,i])^2))/fit5_means["epsilon.2"])
}
dist_to_L5_3 <- c()
for (i in 1:ncol(series)) {
  dist_to_L5_3[i] <- fit5_means["theta.3"]/sqrt(fit5_means["epsilon.3"])*exp(-0.5*(sum((L5_3 - series[,i])^2))/fit5_means["epsilon.3"])
}
dist_to_L5_4 <- c()
for (i in 1:ncol(series)) {
  dist_to_L5_4[i] <- fit5_means["theta.4"]/sqrt(fit5_means["epsilon.4"])*exp(-0.5*(sum((L5_4 - series[,i])^2))/fit5_means["epsilon.4"])
}
dist_to_L5_5 <- c()
for (i in 1:ncol(series)) {
  dist_to_L5_5[i] <- fit5_means["theta.5"]/sqrt(fit5_means["epsilon.5"])*exp(-0.5*(sum((L5_5 - series[,i])^2))/fit5_means["epsilon.5"])
}
Ldist5 <- data.frame(dist_to_L5_1,dist_to_L5_2,dist_to_L5_3,dist_to_L5_4,dist_to_L5_5)
assignments5 <- c(apply(Ldist5,1,max1))

plot(1:nrow(series),series[,1],type = "l",col=assignments5[1],xlab = "index",ylab ="",main= "5 components",ylim = c(-10,0))
for (i in 1:ncol(series)) {
  lines(1:nrow(series),series[,i],type = "l",col=assignments5[i])
}

dev.off()
```
FIGURE 7B:

```{r,echo=FALSE}
round(table(assignments2)/203,5);round(fit2_means[c("theta.1","theta.2")],5)
round(table(assignments3)/203,5);round(fit3_means[c("theta.1","theta.2","theta.3")],5)
round(table(assignments4)/203,5);round(fit4_means[c("theta.1","theta.2","theta.3","theta.4")],5)
round(table(assignments5)/203,5);round(fit5_means[c("theta.1","theta.2","theta.3","theta.4","theta.5")],5)

```

|                  	| K 	| Theta.1 	| Theta.2 	| Theta.3 	| Theta.4 	| Theta.5 	|
|------------------	|:-:	|:-------:	|:-------:	|:-------:	|:-------:	|:-------:	|
| Estimates        	| 2 	| 0.63936 	| 0.36064 	|         	|         	|         	|
|                  	| 3 	| 0.36140 	| 0.28189 	| 0.35422 	|         	|         	|
|                  	| 4 	| 0.37640 	| 0.35678 	| 0.22076 	| 0.04200 	|         	|
|                  	| 5 	| 0.37472 	| 0.19621 	| 0.15761 	| 0.22494 	| 0.04166 	|
|                  	|   	|         	|         	|         	|         	|         	|
| After assignment 	| 2 	| 0.64039 	| 0.35961 	|         	|         	|         	|
|                  	| 3 	| 0.35468 	| 0.29064 	| 0.35468 	|         	|         	|
|                  	| 4 	| 0.37931 	| 0.35468 	| 0.22660 	| 0.03941 	|         	|
|                  	| 5 	| 0.37931 	| 0.19704 	| 0.15764 	| 0.22660 	| 0.03941 	|

```{r,eval=FALSE,include=TRUE}
png(file ="./figures/figure3-10.png",width = 480,height = 480 )
modelIndexChain1 <- read.csv("~/results/mortality_up_4k8k_approx/modelSelection/modelIndexChain1.csv",header = F)
barplot(table(modelIndexChain1$V1[8001:16000])/(length(modelIndexChain1$V1)/2),space = 0,main = "Model posterior distribution", names.arg = c(2,3,4,5),xlab = "Model number")
```


## TMixClust

```{r,echo=FALSE}
library(TMixClust)
```


```{r,echo=FALSE}
series_t <- t(series)
set.seed(12345)
samplingfunction<-function(x){
  if (x==1) res<-TMixClust::TMixClust(series_t, nb_clusters = 2)
  else if (x==2) TMixClust::TMixClust(series_t, nb_clusters = 3)
  else if (x==3) TMixClust::TMixClust(series_t, nb_clusters = 4)
  else if (x==4) TMixClust::TMixClust(series_t, nb_clusters = 5)
  else if (x==5) TMixClust::TMixClust(series_t, nb_clusters = 6)
}

cl <- parallel::makeCluster(4)
parallel::clusterExport(cl,c('series_t'))
out_tmix2 <- parallel::parLapply(cl, c(1:4),samplingfunction)

```

```{r,echo=FALSE}
png(file ="./figures/figure3-11.png",width = 960,height = 960 )
par(mfrow=c(2,2))
ts.plot(series, col= out_tmix2[[1]]$em_cluster_assignment)
ts.plot(series, col= out_tmix2[[2]]$em_cluster_assignment)
ts.plot(series, col= out_tmix2[[3]]$em_cluster_assignment)
ts.plot(series, col= out_tmix2[[4]]$em_cluster_assignment)

round(table(out_tmix2[[1]]$em_cluster_assignment)/203,5)
round(table(out_tmix2[[2]]$em_cluster_assignment)/203,5)
round(table(out_tmix2[[3]]$em_cluster_assignment)/203,5)
round(table(out_tmix2[[4]]$em_cluster_assignment)/203,5)

dev.off()
```
FIGURE 7: Results from applying TMixClust to the French mortality data set

|                  	| K 	| Theta.1 	| Theta.2 	| Theta.3 	| Theta.4 	| Theta.5 	|
|------------------	|:-:	|:-------:	|:-------:	|:-------:	|:-------:	|:-------:	|
| Estimates        	| 2 	| 0.34975 	| 0.65025 	|         	|         	|         	|
|                  	| 3 	| 0.19704 	| 0.34483 	| 0.45813 	|         	|         	|
|                  	| 4 	| 0.22167 	| 0.18227 	| 0.16749 	| 0.42857 	|         	|
|                  	| 5 	| 0.32020 	| 0.11330 	| 0.19212 	| 0.21675 	| 0.15764 	|

## Interpretation 2

```{r,eval=FALSE,include=TRUE}
data <- as.list(fromJSON(file="~/results/mortality_t_up_4k8k_approx/data/data.json"))
series <- (matrix(unlist(data$z),ncol = 203, nrow = 101))
series_t <- t(series)
#ts.plot(series_t,main="French mortality",xlab="index")

png(file ="./figures/figure3-12.png",width = 480,height = 480 )
plot(1:nrow(series_t),series_t[,1],type = "l",col="black",xaxt = "n",xlab = "t",ylab ="",main= "French mortality",ylim = c(-10,0))
for (i in 1:ncol(series_t)) {
  lines(1:nrow(series_t),series_t[,i],type = "l",col="black")
}
axis(1,at=c(0,50,100,150,200),labels = c(1816,1866,1916,1966,2016))
dev.off()
```

```{r,eval=FALSE,include=TRUE}
data2 <- read.csv("~/results/mortality_t_up_4k8k_approx/goldStandardChains/2/2GSC1.csv")
data3 <- read.csv("~/results/mortality_t_up_4k8k_approx/goldStandardChains/3/3GSC1.csv")
data4 <- read.csv("~/results/mortality_t_up_4k8k_approx/goldStandardChains/4/4GSC1.csv")
data5 <- read.csv("~/results/mortality_t_up_4k8k_approx/goldStandardChains/5/5GSC1.csv")

```

```{r,eval=FALSE,include=TRUE}
fit2_means <- apply(data2,2,median)
fit3_means <- apply(data3,2,median)
fit4_means <- apply(data4,2,median)
fit5_means <- apply(data5,2,median)
```

```{r,eval=FALSE,include=TRUE}
fit2_CI <- posterior_interval(as.matrix(data2))
fit3_CI <- posterior_interval(as.matrix(data3))
fit4_CI <- posterior_interval(as.matrix(data4))
fit5_CI <- posterior_interval(as.matrix(data5))

l1 <- paste('l.1.',1:203,sep='')
l2 <- paste('l.2.',1:203,sep='')
l3 <- paste('l.3.',1:203,sep='')
l4 <- paste('l.4.',1:203,sep='')
l5 <- paste('l.5.',1:203,sep='')
```


```{r,eval=FALSE,include=TRUE}
png(file ="./figures/figure3-13.png",width = 960,height = 960 )
par(mfrow=c(2,2))

L2_1 <- fit2_means[l1]
L2_2 <- fit2_means[l2]


plot(1:nrow(series_t),series_t[,1],type = "l",col="gray",xaxt = "n",xlab = "t",ylab ="",main= "2 components",ylim = c(-10,0))
for (i in 1:ncol(series_t)) {
  lines(1:nrow(series_t),series_t[,i],type = "l",col="gray")
}
lines(1:203,L2_1,"l",col="red")
lines(1:203,L2_2,"l",col="green")
axis(1,at=c(0,50,100,150,200),labels = c(1816,1866,1916,1966,2016))

L3_1 <- fit3_means[l1]
L3_2 <- fit3_means[l2]
L3_3 <- fit3_means[l3]

plot(1:nrow(series_t),series_t[,1],type = "l",col="gray",xaxt = "n",xlab = "t",ylab ="",main= "3 components",ylim = c(-10,0))
for (i in 1:ncol(series_t)) {
  lines(1:nrow(series_t),series_t[,i],type = "l",col="gray")
}
lines(1:203,L3_1,"l",col="red")
lines(1:203,L3_2,"l",col="green")
lines(1:203,L3_3,"l",col="blue")
axis(1,at=c(0,50,100,150,200),labels = c(1816,1866,1916,1966,2016))

L4_1 <- fit4_means[l1]
L4_2 <- fit4_means[l2]
L4_3 <- fit4_means[l3]
L4_4 <- fit4_means[l4]

plot(1:nrow(series_t),series_t[,1],type = "l",col="gray",xaxt = "n",xlab = "t",ylab ="",main= "4 components",ylim = c(-10,0))
for (i in 1:ncol(series_t)) {
  lines(1:nrow(series_t),series_t[,i],type = "l",col="gray")
}
lines(1:203,L4_1,"l",col="red")
lines(1:203,L4_2,"l",col="green")
lines(1:203,L4_3,"l",col="blue")
lines(1:203,L4_4,"l",col="purple")
axis(1,at=c(0,50,100,150,200),labels = c(1816,1866,1916,1966,2016))

L5_1 <- fit5_means[l1]
L5_2 <- fit5_means[l2]
L5_3 <- fit5_means[l3]
L5_4 <- fit5_means[l4]
L5_5 <- fit5_means[l5]

plot(1:nrow(series_t),series_t[,1],type = "l",col="gray",xaxt = "n",xlab = "t",ylab ="",main= "5 components",ylim = c(-10,0))
for (i in 1:ncol(series_t)) {
  lines(1:nrow(series_t),series_t[,i],type = "l",col="gray")
}
lines(1:203,L5_1,"l",col="red")
lines(1:203,L5_2,"l",col="green")
lines(1:203,L5_3,"l",col="blue")
lines(1:203,L5_4,"l",col="purple")
lines(1:203,L5_5,"l",col="blueviolet")
axis(1,at=c(0,50,100,150,200),labels = c(1816,1866,1916,1966,2016))

dev.off()
```

```{r,eval=FALSE,include=TRUE}
png(file ="./figures/figure3-14.png",width = 960,height = 960 )
par(mfrow=c(2,2))

dist_to_L2_1 <- c()
for (i in 1:ncol(series_t)) {
  dist_to_L2_1[i] <- fit2_means["theta.1"]/sqrt(fit2_means["epsilon.1"])*exp(-0.5*(sum((L2_1 - series_t[,i])^2))/fit2_means["epsilon.1"])
}
dist_to_L2_2 <- c()
for (i in 1:ncol(series_t)) {
  dist_to_L2_2[i] <- fit2_means["theta.2"]/sqrt(fit2_means["epsilon.2"])*exp(-0.5*(sum((L2_2 - series_t[,i])^2))/fit2_means["epsilon.2"])
}

Ldist2 <- data.frame(dist_to_L2_1,dist_to_L2_2)
assignments2 <- c(apply(Ldist2,1,max1))

plot(1:nrow(series_t),series_t[,1],type = "l",col=assignments2[1],xaxt = "n",xlab = "t",ylab ="", main= "2 components",ylim = c(-10,0))
for (i in 1:ncol(series_t)) {
  lines(1:nrow(series_t),series_t[,i],type = "l",col=assignments2[i])
}
axis(1,at=c(0,50,100,150,200),labels = c(1816,1866,1916,1966,2016))

dist_to_L3_1 <- c()
for (i in 1:ncol(series_t)) {
  dist_to_L3_1[i] <- fit3_means["theta.1"]/sqrt(fit3_means["epsilon.1"])*exp(-0.5*(sum((L3_1 - series_t[,i])^2))/fit3_means["epsilon.1"])
}
dist_to_L3_2 <- c()
for (i in 1:ncol(series_t)) {
  dist_to_L3_2[i] <- fit3_means["theta.2"]/sqrt(fit3_means["epsilon.2"])*exp(-0.5*(sum((L3_2 - series_t[,i])^2))/fit3_means["epsilon.2"])
}
dist_to_L3_3 <- c()
for (i in 1:ncol(series_t)) {
  dist_to_L3_3[i] <- fit3_means["theta.3"]/sqrt(fit3_means["epsilon.3"])*exp(-0.5*(sum((L3_3 - series_t[,i])^2))/fit3_means["epsilon.3"])
}

Ldist3 <- data.frame(dist_to_L3_1,dist_to_L3_2,dist_to_L3_3)
assignments3 <- c(apply(Ldist3,1,max1))

plot(1:nrow(series_t),series_t[,1],type = "l",col=assignments3[1],xaxt = "n",xlab = "t",ylab ="", main= "3 components",ylim = c(-10,0))
for (i in 1:ncol(series_t)) {
  lines(1:nrow(series_t),series_t[,i],type = "l",col=assignments3[i])
}
axis(1,at=c(0,50,100,150,200),labels = c(1816,1866,1916,1966,2016))

dist_to_L4_1 <- c()
for (i in 1:ncol(series_t)) {
  dist_to_L4_1[i] <- fit4_means["theta.1"]/sqrt(fit4_means["epsilon.1"])*exp(-0.5*(sum((L4_1 - series_t[,i])^2))/fit4_means["epsilon.1"])
}
dist_to_L4_2 <- c()
for (i in 1:ncol(series_t)) {
  dist_to_L4_2[i] <- fit4_means["theta.2"]/sqrt(fit4_means["epsilon.2"])*exp(-0.5*(sum((L4_2 - series_t[,i])^2))/fit4_means["epsilon.2"])
}
dist_to_L4_3 <- c()
for (i in 1:ncol(series_t)) {
  dist_to_L4_3[i] <- fit4_means["theta.3"]/sqrt(fit4_means["epsilon.3"])*exp(-0.5*(sum((L4_3 - series_t[,i])^2))/fit4_means["epsilon.3"])
}
dist_to_L4_4 <- c()
for (i in 1:ncol(series_t)) {
  dist_to_L4_4[i] <- fit4_means["theta.4"]/sqrt(fit4_means["epsilon.4"])*exp(-0.5*(sum((L4_4 - series_t[,i])^2))/fit4_means["epsilon.4"])
}

Ldist4 <- data.frame(dist_to_L4_1,dist_to_L4_2,dist_to_L4_3,dist_to_L4_4)
assignments4 <- c(apply(Ldist4,1,max1))

plot(1:nrow(series_t),series_t[,1],type = "l",col=assignments4[1],xaxt = "n",xlab = "t",ylab ="",main= "4 components",ylim = c(-10,0))
for (i in 1:ncol(series_t)) {
  lines(1:nrow(series_t),series_t[,i],type = "l",col=assignments4[i])
}
axis(1,at=c(0,50,100,150,200),labels = c(1816,1866,1916,1966,2016))

dist_to_L5_1 <- c()
for (i in 1:ncol(series_t)) {
  dist_to_L5_1[i] <- fit5_means["theta.1"]/sqrt(fit5_means["epsilon.1"])*exp(-0.5*(sum((L5_1 - series_t[,i])^2))/fit5_means["epsilon.1"])
}
dist_to_L5_2 <- c()
for (i in 1:ncol(series_t)) {
  dist_to_L5_2[i] <- fit5_means["theta.2"]/sqrt(fit5_means["epsilon.2"])*exp(-0.5*(sum((L5_2 - series_t[,i])^2))/fit5_means["epsilon.2"])
}
dist_to_L5_3 <- c()
for (i in 1:ncol(series_t)) {
  dist_to_L5_3[i] <- fit5_means["theta.3"]/sqrt(fit5_means["epsilon.3"])*exp(-0.5*(sum((L5_3 - series_t[,i])^2))/fit5_means["epsilon.3"])
}
dist_to_L5_4 <- c()
for (i in 1:ncol(series_t)) {
  dist_to_L5_4[i] <- fit5_means["theta.4"]/sqrt(fit5_means["epsilon.4"])*exp(-0.5*(sum((L5_4 - series_t[,i])^2))/fit5_means["epsilon.4"])
}
dist_to_L5_5 <- c()
for (i in 1:ncol(series_t)) {
  dist_to_L5_5[i] <- fit5_means["theta.5"]/sqrt(fit5_means["epsilon.5"])*exp(-0.5*(sum((L5_5 - series_t[,i])^2))/fit5_means["epsilon.5"])
}
Ldist5 <- data.frame(dist_to_L5_1,dist_to_L5_2,dist_to_L5_3,dist_to_L5_4,dist_to_L5_5)
assignments5 <- c(apply(Ldist5,1,max1))

plot(1:nrow(series_t),series_t[,1],type = "l",col=assignments5[1],xaxt = "n",xlab = "t",ylab ="",main= "5 components",ylim = c(-10,0))
for (i in 1:ncol(series_t)) {
  lines(1:nrow(series_t),series_t[,i],type = "l",col=assignments5[i])
}
axis(1,at=c(0,50,100,150,200),labels = c(1816,1866,1916,1966,2016))
dev.off()
```
FIGURE :

```{r,echo=FALSE}
round(table(assignments2)/101,5);round(fit2_means[c("theta.1","theta.2")],5)
round(table(assignments3)/101,5);round(fit3_means[c("theta.1","theta.2","theta.3")],5)
round(table(assignments4)/101,5);round(fit4_means[c("theta.1","theta.2","theta.3","theta.4")],5)
round(table(assignments5)/101,5);round(fit5_means[c("theta.1","theta.2","theta.3","theta.4","theta.5")],5)
```

|                  	| K 	| Theta.1 	| Theta.2 	| Theta.3 	| Theta.4 	| Theta.5 	|
|------------------	|:-:	|:-------:	|:-------:	|:-------:	|:-------:	|:-------:	|
| Estimates        	| 2 	| 0.58301 	| 0.41699 	|         	|         	|         	|
|                  	| 3 	| 0.29649 	| 0.46150 	| 0.23852 	|         	|         	|
|                  	| 4 	| 0.19779 	| 0.39977 	| 0.18797 	| 0.20754 	|         	|
|                  	| 5 	| 0.12015 	| 0.16785 	| 0.38455 	| 0.17896 	| 0.13940 	|
|                  	|   	|         	|         	|         	|         	|         	|
| After assignment 	| 2 	| 0.58416 	| 0.41584 	|         	|         	|         	|
|                  	| 3 	| 0.29703 	| 0.46535 	| 0.23762 	|         	|         	|
|                  	| 4 	| 0.19802 	| 0.40594 	| 0.18812 	| 0.20792 	|         	|
|                  	| 5 	| 0.11881 	| 0.16832 	| 0.39604 	| 0.17822 	| 0.13861 	|

## TMixClust

```{r,echo=FALSE}
series_t <- t(series)
set.seed(12345)
samplingfunction<-function(x){
  if (x==1) res<-TMixClust::TMixClust(series, nb_clusters = 2)
  else if (x==2) TMixClust::TMixClust(series, nb_clusters = 3)
  else if (x==3) TMixClust::TMixClust(series, nb_clusters = 4)
  else if (x==4) TMixClust::TMixClust(series, nb_clusters = 5)
  else if (x==5) TMixClust::TMixClust(series, nb_clusters = 6)
}

cl <- parallel::makeCluster(4)
parallel::clusterExport(cl,c('series'))
out_tmix3 <- parallel::parLapply(cl, c(1:4),samplingfunction)

```

```{r,echo=FALSE}
png(file ="./figures/figure3-15.png",width = 960,height = 960 )
par(mfrow=c(2,2))
ts.plot(series_t, col= out_tmix3[[1]]$em_cluster_assignment,main="2")
ts.plot(series_t, col= out_tmix3[[2]]$em_cluster_assignment,main="3")
ts.plot(series_t, col= out_tmix3[[3]]$em_cluster_assignment,main="4")
ts.plot(series_t, col= out_tmix3[[4]]$em_cluster_assignment,main="5")

dev.off()

round(table(out_tmix3[[1]]$em_cluster_assignment)/101,5)
round(table(out_tmix3[[2]]$em_cluster_assignment)/101,5)
round(table(out_tmix3[[3]]$em_cluster_assignment)/101,5)
round(table(out_tmix3[[4]]$em_cluster_assignment)/101,5)

```

|                  	| K 	| Theta.1 	| Theta.2 	| Theta.3 	| Theta.4 	| Theta.5 	|
|------------------	|:-:	|:-------:	|:-------:	|:-------:	|:-------:	|:-------:	|
| Estimates        	| 2 	| 0.42574 	| 0.57426 	|         	|         	|         	|
|                  	| 3 	| 0.44554 	| 0.14851 	| 0.40594 	|         	|         	|
|                  	| 4 	| 0.29703 	| 0.14851 	| 0.14851 	| 0.40594 	|         	|
|                  	| 5 	| 0.24752 	| 0.14851 	| 0.11881 	| 0.33663 	| 0.14851 	|


## 4. Drosophila melanogaster embryogenetics data set


```{r,eval=FALSE,include=TRUE}
########## data processing

#### replicate 1
data_gsm0_1 <- read.csv("~/GSM3427100_00h_1.tsv", header = F,sep = "")
data_gsm1_1 <- read.csv("~/GSM3427104_01h_1.tsv", header = F,sep = "")
data_gsm2_1 <- read.csv("~/GSM3427108_02h_1.tsv", header = F,sep = "")
data_gsm3_1 <- read.csv("~/GSM3427112_03h_1.tsv", header = F,sep = "")
data_gsm4_1 <- read.csv("~/GSM3427116_04h_1.tsv", header = F,sep = "")
data_gsm5_1 <- read.csv("~/GSM3427120_05h_1.tsv", header = F,sep = "")
data_gsm6_1 <- read.csv("~/GSM3427124_06h_1.tsv", header = F,sep = "")
data_gsm8_1 <- read.csv("~/GSM3427128_08h_1.tsv", header = F,sep = "")
data_gsm10_1 <- read.csv("~/GSM3427132_10h_1.tsv", header = F,sep = "")
data_gsm12_1 <- read.csv("~/GSM3427136_12h_1.tsv", header = F,sep = "")
data_gsm14_1 <- read.csv("~/GSM3427140_14h_1.tsv", header = F,sep = "")
data_gsm16_1 <- read.csv("~/GSM3427144_16h_1.tsv", header = F,sep = "")
data_gsm18_1 <- read.csv("~/GSM3427148_18h_1.tsv", header = F,sep = "")
data_gsm20_1 <- read.csv("~/GSM3427152_20h_1.tsv", header = F,sep = "")

raw_data_1 <- matrix(nrow = nrow(data_gsm3_1),ncol = 14)
raw_data_1[,1] <- data_gsm0_1[,2]
raw_data_1[,2] <- data_gsm1_1[,2]
raw_data_1[,3] <- data_gsm2_1[,2]
raw_data_1[,4] <- data_gsm3_1[,2]
raw_data_1[,5] <- data_gsm4_1[,2]
raw_data_1[,6] <- data_gsm5_1[,2]
raw_data_1[,7] <- data_gsm6_1[,2]
raw_data_1[,8] <- data_gsm8_1[,2]
raw_data_1[,9] <- data_gsm10_1[,2]
raw_data_1[,10] <- data_gsm12_1[,2]
raw_data_1[,11] <- data_gsm14_1[,2]
raw_data_1[,12] <- data_gsm16_1[,2]
raw_data_1[,13] <- data_gsm18_1[,2]
raw_data_1[,14] <- data_gsm20_1[,2]

raw_data_no_meta_1 <- raw_data_1[1:17558,]

#### replicate 2
data_gsm0_2 <- read.csv("~/GSM3427101_00h_2.tsv", header = F,sep = "")
data_gsm1_2 <- read.csv("~/GSM3427105_01h_2.tsv", header = F,sep = "")
data_gsm2_2 <- read.csv("~/GSM3427109_02h_2.tsv", header = F,sep = "")
data_gsm3_2 <- read.csv("~/GSM3427113_03h_2.tsv", header = F,sep = "")
data_gsm4_2 <- read.csv("~/GSM3427117_04h_2.tsv", header = F,sep = "")
data_gsm5_2 <- read.csv("~/GSM3427121_05h_2.tsv", header = F,sep = "")
data_gsm6_2 <- read.csv("~/GSM3427125_06h_2.tsv", header = F,sep = "")
data_gsm8_2 <- read.csv("~/GSM3427129_08h_2.tsv", header = F,sep = "")
data_gsm10_2 <- read.csv("~/GSM3427133_10h_2.tsv", header = F,sep = "")
data_gsm12_2 <- read.csv("~/GSM3427137_12h_2.tsv", header = F,sep = "")
data_gsm14_2 <- read.csv("~/GSM3427141_14h_2.tsv", header = F,sep = "")
data_gsm16_2 <- read.csv("~/GSM3427145_16h_2.tsv", header = F,sep = "")
data_gsm18_2 <- read.csv("~/GSM3427149_18h_2.tsv", header = F,sep = "")
data_gsm20_2 <- read.csv("~/GSM3427153_20h_2.tsv", header = F,sep = "")

raw_data_2 <- matrix(nrow = nrow(data_gsm3_2),ncol = 14)
raw_data_2[,1] <- data_gsm0_2[,2]
raw_data_2[,2] <- data_gsm1_2[,2]
raw_data_2[,3] <- data_gsm2_2[,2]
raw_data_2[,4] <- data_gsm3_2[,2]
raw_data_2[,5] <- data_gsm4_2[,2]
raw_data_2[,6] <- data_gsm5_2[,2]
raw_data_2[,7] <- data_gsm6_2[,2]
raw_data_2[,8] <- data_gsm8_2[,2]
raw_data_2[,9] <- data_gsm10_2[,2]
raw_data_2[,10] <- data_gsm12_2[,2]
raw_data_2[,11] <- data_gsm14_2[,2]
raw_data_2[,12] <- data_gsm16_2[,2]
raw_data_2[,13] <- data_gsm18_2[,2]
raw_data_2[,14] <- data_gsm20_2[,2]

raw_data_no_meta_2 <- raw_data_2[1:17558,]

#### replicate 3
data_gsm0_3 <- read.csv("~/GSM3427102_00h_3.tsv", header = F,sep = "")
data_gsm1_3 <- read.csv("~/GSM3427106_01h_3.tsv", header = F,sep = "")
data_gsm2_3 <- read.csv("~/GSM3427110_02h_3.tsv", header = F,sep = "")
data_gsm3_3 <- read.csv("~/GSM3427114_03h_3.tsv", header = F,sep = "")
data_gsm4_3 <- read.csv("~/GSM3427118_04h_3.tsv", header = F,sep = "")
data_gsm5_3 <- read.csv("~/GSM3427122_05h_3.tsv", header = F,sep = "")
data_gsm6_3 <- read.csv("~/GSM3427126_06h_3.tsv", header = F,sep = "")
data_gsm8_3 <- read.csv("~/GSM3427130_08h_3.tsv", header = F,sep = "")
data_gsm10_3 <- read.csv("~/GSM3427134_10h_3.tsv", header = F,sep = "")
data_gsm12_3 <- read.csv("~/GSM3427138_12h_3.tsv", header = F,sep = "")
data_gsm14_3 <- read.csv("~/GSM3427142_14h_3.tsv", header = F,sep = "")
data_gsm16_3 <- read.csv("~/GSM3427146_16h_3.tsv", header = F,sep = "")
data_gsm18_3 <- read.csv("~/GSM3427150_18h_3.tsv", header = F,sep = "")
data_gsm20_3 <- read.csv("~/GSM3427154_20h_3.tsv", header = F,sep = "")

raw_data_3 <- matrix(nrow = nrow(data_gsm3_3),ncol = 14)
raw_data_3[,1] <- data_gsm0_3[,2]
raw_data_3[,2] <- data_gsm1_3[,2]
raw_data_3[,3] <- data_gsm2_3[,2]
raw_data_3[,4] <- data_gsm3_3[,2]
raw_data_3[,5] <- data_gsm4_3[,2]
raw_data_3[,6] <- data_gsm5_3[,2]
raw_data_3[,7] <- data_gsm6_3[,2]
raw_data_3[,8] <- data_gsm8_3[,2]
raw_data_3[,9] <- data_gsm10_3[,2]
raw_data_3[,10] <- data_gsm12_3[,2]
raw_data_3[,11] <- data_gsm14_3[,2]
raw_data_3[,12] <- data_gsm16_3[,2]
raw_data_3[,13] <- data_gsm18_3[,2]
raw_data_3[,14] <- data_gsm20_3[,2]

raw_data_no_meta_3 <- raw_data_3[1:17558,]

#### raw replicate 4
data_gsm0_4 <- read.csv("~/GSM3427103_00h_4.tsv", header = F,sep = "")
data_gsm1_4 <- read.csv("~/GSM3427107_01h_4.tsv", header = F,sep = "")
data_gsm2_4 <- read.csv("~/GSM3427111_02h_4.tsv", header = F,sep = "")
data_gsm3_4 <- read.csv("~/GSM3427115_03h_4.tsv", header = F,sep = "")
data_gsm4_4 <- read.csv("~/GSM3427119_04h_4.tsv", header = F,sep = "")
data_gsm5_4 <- read.csv("~/GSM3427123_05h_4.tsv", header = F,sep = "")
data_gsm6_4 <- read.csv("~/GSM3427127_06h_4.tsv", header = F,sep = "")
data_gsm8_4 <- read.csv("~/GSM3427131_08h_4.tsv", header = F,sep = "")
data_gsm10_4 <- read.csv("~/GSM3427135_10h_4.tsv", header = F,sep = "")
data_gsm12_4 <- read.csv("~/GSM3427139_12h_4.tsv", header = F,sep = "")
data_gsm14_4 <- read.csv("~/GSM3427143_14h_4.tsv", header = F,sep = "")
data_gsm16_4 <- read.csv("~/GSM3427147_16h_4.tsv", header = F,sep = "")
data_gsm18_4 <- read.csv("~/GSM3427151_18h_4.tsv", header = F,sep = "")
data_gsm20_4 <- read.csv("~/GSM3427155_20h_4.tsv", header = F,sep = "")

raw_data_4 <- matrix(nrow = nrow(data_gsm3_4),ncol = 14)
raw_data_4[,1] <- data_gsm0_4[,2]
raw_data_4[,2] <- data_gsm1_4[,2]
raw_data_4[,3] <- data_gsm2_4[,2]
raw_data_4[,4] <- data_gsm3_4[,2]
raw_data_4[,5] <- data_gsm4_4[,2]
raw_data_4[,6] <- data_gsm5_4[,2]
raw_data_4[,7] <- data_gsm6_4[,2]
raw_data_4[,8] <- data_gsm8_4[,2]
raw_data_4[,9] <- data_gsm10_4[,2]
raw_data_4[,10] <- data_gsm12_4[,2]
raw_data_4[,11] <- data_gsm14_4[,2]
raw_data_4[,12] <- data_gsm16_4[,2]
raw_data_4[,13] <- data_gsm18_4[,2]
raw_data_4[,14] <- data_gsm20_4[,2]

raw_data_no_meta_4 <- raw_data_4[1:17558,]

#### scaling
scaled2_raw1.2 <- raw_data_no_meta_1*(1+colSums(raw_data_1[17559:17563,])/colSums(raw_data_1[1:17563,]))
scaled2_raw2.2 <- raw_data_no_meta_2*(1+colSums(raw_data_2[17559:17563,])/colSums(raw_data_2[1:17563,]))
scaled2_raw2.3 <- raw_data_no_meta_3*(1+colSums(raw_data_3[17559:17563,])/colSums(raw_data_3[1:17563,]))
scaled2_raw2.4 <- raw_data_no_meta_4*(1+colSums(raw_data_4[17559:17563,])/colSums(raw_data_4[1:17563,]))

#### log2 transformation and averaging
mean_scale2.2_log2 <- (log2(scaled2_raw1.2+1)+log2(scaled2_raw1.2+1)+log2(scaled2_raw1.3+1)+log2(scaled2_raw1.4+1))*(1/4)

```

Removing genes that weren't observed at all. These cause some issues (longer computational time).

```{r,eval=FALSE,include=TRUE}
nolla_sarakkeet <- which(colSums(mean_scale2.2_log2_t)==0)
mean_scale2.2_log2_t2 <- t(mean_scale2.2_log2_t[,-c(nolla_sarakkeet)])
dim(mean_scale2.2_log2_t);dim(mean_scale2.2_log2_t[,-c(nolla_sarakkeet)])
```

Using NbClust to obtain prior for the range for the number of components. 

```{r}
k_prior <- NbClust::NbClust(mean_scale2.2_log2,method = "ward.D", index="silhouette",min.nc = 2,max.nc = 7)
```

```{r,echo=FALSE}
k_prior2 <- NbClust::NbClust(2^mean_scale2.2_log2,method = "ward.D", index="silhouette",min.nc = 2,max.nc = 7)
```


```{r,eval=FALSE,include=TRUE}
png(file ="./figures/figure4-0_prior.png",width = 480,height = 480 )
plot(k_prior$All.index,main="log2 full data Silhouette index",xlab="Number of components",ylab="index",type="l",xaxt = "n")
axis(1,at=c(1,2,3,4,5,6),labels=c(2,3,4,5,6,7))
dev.off()
```

```{r,echo=FALSE}
png(file ="./figures/figure4-0_prior2.png",width = 480,height = 480 )
plot(k_prior2$All.index,main="Full data Silhouette index",xlab="Number of components",ylab="index",type="l",xaxt = "n")
axis(1,at=c(1,2,3,4,5,6),labels=c(2,3,4,5,6,7))
dev.off()
```

The data.

```{r,eval=FALSE,include=TRUE}
png(file ="./figures/figure4-0.png",width = 480,height = 480 )
ts.plot(t(mean_scale2.2_log2_t2),main="Mean log2-transformed expression")
dev.off()
series_t <- t(mean_scale2.2_log2_t2)
```

## Analysis on full* data set

Model posterior distribution

```{r,eval=FALSE,include=TRUE}
png(file ="./figures/figure4-1.png",width = 480,height = 480 )
modelIndexChain1 <- read.csv("~/kokodata_poisnollat_4k8k/modelSelection/modelIndexChain1.csv",header = F)
barplot(table(modelIndexChain1$V1[8001:16000])/(length(modelIndexChain1$V1)/2),space = 0,main = "Model posterior distribution", names.arg = c(2,3,4,5),xlab = "Model number")
```

```{r,eval=FALSE,include=TRUE}
data2 <- read.csv("~/kokodata_poisnollat_4k8k/goldStandardChains/2/2GSC1.csv")
data3 <- read.csv("~/kokodata_poisnollat_4k8k/goldStandardChains/3/3GSC1.csv")
data4 <- read.csv("~/kokodata_poisnollat_4k8k/goldStandardChains/4/4GSC1.csv")
data5 <- read.csv("~/kokodata_poisnollat_4k8k/goldStandardChains/5/5GSC1.csv")

```

```{r,eval=FALSE,include=TRUE}
fit2_means <- apply(data2,2,median)
fit3_means <- apply(data3,2,median)
fit4_means <- apply(data4,2,median)
fit5_means <- apply(data5,2,median)
```

```{r,eval=FALSE,include=TRUE}
fit2_CI <- posterior_interval(as.matrix(data2))
fit3_CI <- posterior_interval(as.matrix(data3))
fit4_CI <- posterior_interval(as.matrix(data4))
fit5_CI <- posterior_interval(as.matrix(data5))

l1 <- paste('l.1.',1:14,sep='')
l2 <- paste('l.2.',1:14,sep='')
l3 <- paste('l.3.',1:14,sep='')
l4 <- paste('l.4.',1:14,sep='')
l5 <- paste('l.5.',1:14,sep='')
```

```{r,eval=FALSE,include=TRUE}
png(file ="./figures/figure4-2.png",width = 960,height = 960 )
par(mfrow=c(2,2))

L2_1 <- fit2_means[l1]
L2_2 <- fit2_means[l2]

plot(1:nrow(series_t),series_t[,1],type = "l",col="gray",xlab = "Time",ylab ="",main= "2 components",ylim = c(0,21))
for (i in 1:ncol(series_t)) {
  lines(1:nrow(series_t),series_t[,i],type = "l",col="gray")
}
lines(1:14,L2_1,"l",col="red")
lines(1:14,L2_2,"l",col="green")

L3_1 <- fit3_means[l1]
L3_2 <- fit3_means[l2]
L3_3 <- fit3_means[l3]

plot(1:nrow(series_t),series_t[,1],type = "l",col="gray",xlab = "Time",ylab ="",main= "3 components",ylim = c(0,21))
for (i in 1:ncol(series_t)) {
  lines(1:nrow(series_t),series_t[,i],type = "l",col="gray")
}
lines(1:14,L3_1,"l",col="red")
lines(1:14,L3_2,"l",col="green")
lines(1:14,L3_3,"l",col="blue")

L4_1 <- fit4_means[l1]
L4_2 <- fit4_means[l2]
L4_3 <- fit4_means[l3]
L4_4 <- fit4_means[l4]

plot(1:nrow(series_t),series_t[,1],type = "l",col="gray",xlab = "Time",ylab ="",main= "4 components",ylim = c(0,21))
for (i in 1:ncol(series_t)) {
  lines(1:nrow(series_t),series_t[,i],type = "l",col="gray")
}
lines(1:14,L4_1,"l",col="red")
lines(1:14,L4_2,"l",col="green")
lines(1:14,L4_3,"l",col="blue")
lines(1:14,L4_4,"l",col="purple")

L5_1 <- fit5_means[l1]
L5_2 <- fit5_means[l2]
L5_3 <- fit5_means[l3]
L5_4 <- fit5_means[l4]
L5_5 <- fit5_means[l5]

plot(1:nrow(series_t),series_t[,1],type = "l",col="gray",xlab = "Time",ylab ="",main= "5 components",ylim = c(0,21))
for (i in 1:ncol(series_t)) {
  lines(1:nrow(series_t),series_t[,i],type = "l",col="gray")
}
lines(1:14,L5_1,"l",col="red")
lines(1:14,L5_2,"l",col="green")
lines(1:14,L5_3,"l",col="blue")
lines(1:14,L5_4,"l",col="purple")
lines(1:14,L5_5,"l",col="blueviolet")

dev.off()
```

```{r,eval=FALSE,include=TRUE}
png(file ="./figures/figure4-3.png",width = 960,height = 960 )
par(mfrow=c(2,2))

dist_to_L2_1 <- c()
for (i in 1:ncol(series_t)) {
  dist_to_L2_1[i] <- fit2_means["theta.1"]/sqrt(fit2_means["epsilon.1"])*exp(-0.5*(sum((L2_1 - series_t[,i])^2))/fit2_means["epsilon.1"])
}
dist_to_L2_2 <- c()
for (i in 1:ncol(series_t)) {
  dist_to_L2_2[i] <- fit2_means["theta.2"]/sqrt(fit2_means["epsilon.2"])*exp(-0.5*(sum((L2_2 - series_t[,i])^2))/fit2_means["epsilon.2"])
}

Ldist2 <- data.frame(dist_to_L2_1,dist_to_L2_2)
assignments2 <- c(apply(Ldist2,1,max1))

plot(1:nrow(series_t),series_t[,1],type = "l",col=assignments2[1],xlab = "t",ylab ="", main= "2 components",ylim = c(0,21))
for (i in 1:ncol(series_t)) {
  lines(1:nrow(series_t),series_t[,i],type = "l",col=assignments2[i])
}

dist_to_L3_1 <- c()
for (i in 1:ncol(series_t)) {
  dist_to_L3_1[i] <- fit3_means["theta.1"]/sqrt(fit3_means["epsilon.1"])*exp(-0.5*(sum((L3_1 - series_t[,i])^2))/fit3_means["epsilon.1"])
}
dist_to_L3_2 <- c()
for (i in 1:ncol(series_t)) {
  dist_to_L3_2[i] <- fit3_means["theta.2"]/sqrt(fit3_means["epsilon.2"])*exp(-0.5*(sum((L3_2 - series_t[,i])^2))/fit3_means["epsilon.2"])
}
dist_to_L3_3 <- c()
for (i in 1:ncol(series_t)) {
  dist_to_L3_3[i] <- fit3_means["theta.3"]/sqrt(fit3_means["epsilon.3"])*exp(-0.5*(sum((L3_3 - series_t[,i])^2))/fit3_means["epsilon.3"])
}

Ldist3 <- data.frame(dist_to_L3_1,dist_to_L3_2,dist_to_L3_3)
assignments3 <- c(apply(Ldist3,1,max1))

plot(1:nrow(series_t),series_t[,1],type = "l",col=assignments3[1],xlab = "t",ylab ="", main= "3 components",ylim = c(0,21))
for (i in 1:ncol(series_t)) {
  lines(1:nrow(series_t),series_t[,i],type = "l",col=assignments3[i])
}

dist_to_L4_1 <- c()
for (i in 1:ncol(series_t)) {
  dist_to_L4_1[i] <- fit4_means["theta.1"]/sqrt(fit4_means["epsilon.1"])*exp(-0.5*(sum((L4_1 - series_t[,i])^2))/fit4_means["epsilon.1"])
}
dist_to_L4_2 <- c()
for (i in 1:ncol(series_t)) {
  dist_to_L4_2[i] <- fit4_means["theta.2"]/sqrt(fit4_means["epsilon.2"])*exp(-0.5*(sum((L4_2 - series_t[,i])^2))/fit4_means["epsilon.2"])
}
dist_to_L4_3 <- c()
for (i in 1:ncol(series_t)) {
  dist_to_L4_3[i] <- fit4_means["theta.3"]/sqrt(fit4_means["epsilon.3"])*exp(-0.5*(sum((L4_3 - series_t[,i])^2))/fit4_means["epsilon.3"])
}
dist_to_L4_4 <- c()
for (i in 1:ncol(series_t)) {
  dist_to_L4_4[i] <- fit4_means["theta.4"]/sqrt(fit4_means["epsilon.4"])*exp(-0.5*(sum((L4_4 - series_t[,i])^2))/fit4_means["epsilon.4"])
}

Ldist4 <- data.frame(dist_to_L4_1,dist_to_L4_2,dist_to_L4_3,dist_to_L4_4)
assignments4 <- c(apply(Ldist4,1,max1))

plot(1:nrow(series_t),series_t[,1],type = "l",col=assignments4[1],xlab = "t",ylab ="",main= "4 components",ylim = c(0,21))
for (i in 1:ncol(series_t)) {
  lines(1:nrow(series_t),series_t[,i],type = "l",col=assignments4[i])
}

dist_to_L5_1 <- c()
for (i in 1:ncol(series_t)) {
  dist_to_L5_1[i] <- fit5_means["theta.1"]/sqrt(fit5_means["epsilon.1"])*exp(-0.5*(sum((L5_1 - series_t[,i])^2))/fit5_means["epsilon.1"])
}
dist_to_L5_2 <- c()
for (i in 1:ncol(series_t)) {
  dist_to_L5_2[i] <- fit5_means["theta.2"]/sqrt(fit5_means["epsilon.2"])*exp(-0.5*(sum((L5_2 - series_t[,i])^2))/fit5_means["epsilon.2"])
}
dist_to_L5_3 <- c()
for (i in 1:ncol(series_t)) {
  dist_to_L5_3[i] <- fit5_means["theta.3"]/sqrt(fit5_means["epsilon.3"])*exp(-0.5*(sum((L5_3 - series_t[,i])^2))/fit5_means["epsilon.3"])
}
dist_to_L5_4 <- c()
for (i in 1:ncol(series_t)) {
  dist_to_L5_4[i] <- fit5_means["theta.4"]/sqrt(fit5_means["epsilon.4"])*exp(-0.5*(sum((L5_4 - series_t[,i])^2))/fit5_means["epsilon.4"])
}
dist_to_L5_5 <- c()
for (i in 1:ncol(series_t)) {
  dist_to_L5_5[i] <- fit5_means["theta.5"]/sqrt(fit5_means["epsilon.5"])*exp(-0.5*(sum((L5_5 - series_t[,i])^2))/fit5_means["epsilon.5"])
}
Ldist5 <- data.frame(dist_to_L5_1,dist_to_L5_2,dist_to_L5_3,dist_to_L5_4,dist_to_L5_5)
assignments5 <- c(apply(Ldist5,1,max1))

plot(1:nrow(series_t),series_t[,1],type = "l",col=assignments5[1],xlab = "t",ylab ="",main= "5 components",ylim = c(0,21))
for (i in 1:ncol(series_t)) {
  lines(1:nrow(series_t),series_t[,i],type = "l",col=assignments5[i])
}

dev.off()
```
FIGURE :

```{r,echo=FALSE}
round(table(assignments2)/15927,5);round(fit2_means[c("theta.1","theta.2")],5)
round(table(assignments3)/15927,5);round(fit3_means[c("theta.1","theta.2","theta.3")],5)
round(table(assignments4)/15927,5);round(fit4_means[c("theta.1","theta.2","theta.3","theta.4")],5)
round(table(assignments5)/15927,5);round(fit5_means[c("theta.1","theta.2","theta.3","theta.4","theta.5")],5)
```

|                  	| K 	| Theta.1 	| Theta.2 	| Theta.3 	| Theta.4 	| Theta.5 	|
|------------------	|:-:	|:-------:	|:-------:	|:-------:	|:-------:	|:-------:	|
| Estimates        	| 2 	| 0.44039 	| 0.55961 	|         	|         	|         	|
|                  	| 3 	| 0.22818 	| 0.44933 	| 0.32251 	|         	|         	|
|                  	| 4 	| 0.18911 	| 0.37570 	| 0.22458 	| 0.21068 	|         	|
|                  	| 5 	| 0.18498 	| 0.18035 	| 0.20866 	| 0.17581 	| 0.25010 	|
|                  	|   	|         	|         	|         	|         	|         	|
| After assignment 	| 2 	| 0.45972 	| 0.54028 	|         	|         	|         	|
|                  	| 3 	| 0.24713 	| 0.44955 	| 0.30332 	|         	|         	|
|                  	| 4 	| 0.19571 	| 0.37553 	| 0.22321 	| 0.20556 	|         	|
|                  	| 5 	| 0.18321 	| 0.17844 	| 0.20462 	| 0.17982 	| 0.25391 	|


## Thresholding

Setting different thresholds: $0.1^4,0.1^5,0.1^6,0.1^7,\ldots$


```{r,eval=FALSE,include=TRUE}
assignments4_t1 <- assignments4
for (i in 1:nrow(mean_scale2.2_log2_t2)) {
  if (Ldist4[i,assignments4_t1[i]] < 0.1^2){ 
    assignments4_t1[i] <- NA
  }
}

assignments4_t2 <- assignments4
for (i in 1:nrow(mean_scale2.2_log2_t2)) {
  if (Ldist4[i,assignments4_t2[i]] < 0.1^3){ 
    assignments4_t2[i] <- NA
  }
}

assignments4_t3 <- assignments4
for (i in 1:nrow(mean_scale2.2_log2_t2)) {
  if (Ldist4[i,assignments4_t3[i]] < 0.1^5){ 
    assignments4_t3[i] <- NA
  }
}

assignments4_t4 <- assignments4
for (i in 1:nrow(mean_scale2.2_log2_t2)) {
  if (Ldist4[i,assignments4_t4[i]] < 0.1^8){ 
    assignments4_t4[i] <- NA
  }
}
```

```{r,eval=FALSE,include=TRUE}
png(file ="./figures/figure4-4.png",width = 960,height = 960 )
par(mfrow=c(2,2))

plot(1:nrow(series_t),series_t[,1],type = "l",col=assignments4_t1[1],xlab = "t",ylab ="",main= "4 components, thresholded <0.1^2",ylim = c(0,21))
for (i in 1:ncol(series_t)) {
  lines(1:nrow(series_t),series_t[,i],type = "l",col=assignments4_t1[i])
}
plot(1:nrow(series_t),series_t[,1],type = "l",col=assignments4_t2[1],xlab = "t",ylab ="",main= "4 components, thresholded <0.1^3",ylim = c(0,21))
for (i in 1:ncol(series_t)) {
  lines(1:nrow(series_t),series_t[,i],type = "l",col=assignments4_t2[i])
}
plot(1:nrow(series_t),series_t[,1],type = "l",col=assignments4_t3[1],xlab = "t",ylab ="",main= "4 components, thresholded <0.1^5",ylim = c(0,21))
for (i in 1:ncol(series_t)) {
  lines(1:nrow(series_t),series_t[,i],type = "l",col=assignments4_t3[i])
}
plot(1:nrow(series_t),series_t[,1],type = "l",col=assignments4_t4[1],xlab = "t",ylab ="",main= "4 components, thresholded <0.1^8",ylim = c(0,21))
for (i in 1:ncol(series_t)) {
  lines(1:nrow(series_t),series_t[,i],type = "l",col=assignments4_t4[i])
}
dev.off()
```

```{r,eval=FALSE,include=TRUE}
png(file ="./figures/figure4-5.png",width = 960,height = 960 )
par(mfrow=c(2,2))
ts.plot(mean_scale2.2_log2_t[,is.na(assignments4_t1)==TRUE],col="red", gpars=list( xlab="Time", ylab="",main="thresholded <0.1^2"))#,xaxt="n"
ts.plot(mean_scale2.2_log2_t[,is.na(assignments4_t2)==TRUE],col="red", gpars=list( xlab="Time", ylab="",main="thresholded <0.1^3"))
ts.plot(mean_scale2.2_log2_t[,is.na(assignments4_t3)==TRUE],col="red", gpars=list( xlab="Time", ylab="",main="thresholded <0.1^5"))
ts.plot(mean_scale2.2_log2_t[,is.na(assignments4_t4)==TRUE],col="red", gpars=list( xlab="Time", ylab="",main="thresholded <0.1^8"))
dev.off()
```

```{r,echo=FALSE}
table(assignments4_t1);sum(is.na(assignments4_t1))
table(assignments4_t2);sum(is.na(assignments4_t2))
table(assignments4_t3);sum(is.na(assignments4_t3))
table(assignments4_t4);sum(is.na(assignments4_t4))
```

|                         	| Threshold<br>< 	|         	|         	|         	|         	| Thresholded 	|
|-------------------------	|:--------------:	|:-------:	|:-------:	|:-------:	|:-------:	|:-----------:	|
| Assignments             	|      0.1^2     	|   2585  	|   1481  	|    66   	|   324   	| 11471       	|
|                         	|      0.1^3     	|   2884  	|   2374  	|   357   	|   1104  	| 9208        	|
|                         	|      0.1^5     	|   3113  	|   3523  	|   1239  	|   2327  	| 5725        	|
|                         	|      0.1^8     	|   3117  	|   4562  	|   2247  	|   2895  	| 3106        	|
|                         	|                	|         	|         	|         	|         	|             	|
| Without<br>Thresholding 	|        -       	|   3117   	|   5981   	|   3555   	|   3274   	|             	|


## Analysis on Subsets

Comparison; full data vs sample of 1000 and 2000 with fast and slow model implementations RJMCMC method.

```{r,eval=FALSE,include=TRUE}
#sm_prior_pois8 <- c(0.1,0.47,1,1.3,1.7,2)
#log2_data_mean2.6.2 <-list(K=15927, T=14, z= mean_scale2.2_log2_t2, sigma_y=sm_prior_pois8[c(1,3,5)], a=-1,b=20)
#model_va3_3 <- "model_va_3_3.stan"
#mean_scale2.2_log2_t2_10k_2 <- stan(file = model_va3_3, data = log2_data_mean2.6.2 ,thin = 1, iter = 10000, chains = 1, control = list(adapt_delta=0.9)) #delta=0.25
#write.csv(mean_scale2.2_log2_t2_10k_2,"mean_scale2.2_log2_t2_10k_2.csv")

```

```{r,eval=FALSE,include=TRUE}
k_prior3 <- NbClust::NbClust(series_t,method = "ward.D", index="silhouette",min.nc = 2,max.nc = 7)
```


```{r,eval=FALSE,include=TRUE}
png(file ="./figures/figure4-0_prior1000.png",width = 480,height = 480 )
plot(k_prior3$All.index,main="sample of 1000, log2 data Silhouette index",xlab="Number of components",ylab="index",type="l",xaxt = "n")
axis(1,at=c(1,2,3,4,5,6),labels=c(2,3,4,5,6,7))
dev.off()
```


```{r,eval=FALSE,include=TRUE}
k_prior4 <- NbClust::NbClust(series_t,method = "ward.D", index="silhouette",min.nc = 2,max.nc = 7)
```

```{r,eval=FALSE,include=TRUE}
png(file ="./figures/figure4-0_prior2000.png",width = 480,height = 480 )
plot(k_prior4$All.index,main="sample of 2000, log2 data Silhouette index",xlab="Number of components",ylab="index",type="l",xaxt = "n")
axis(1,at=c(1,2,3,4,5,6),labels=c(2,3,4,5,6,7))
dev.off()
```


```{r,eval=FALSE,include=TRUE}
k_prior5 <- NbClust::NbClust(mean_scale2.2_log2_t2_s3 ,method = "ward.D", index="silhouette",min.nc = 2,max.nc = 7)
```

```{r,eval=FALSE,include=TRUE}
png(file ="./figures/figure4-0_prior3000.png",width = 480,height = 480 )
plot(k_prior5$All.index,main="sample of 3000, log2 data Silhouette index",xlab="Number of components",ylab="index",type="l",xaxt = "n")
axis(1,at=c(1,2,3,4,5,6),labels=c(2,3,4,5,6,7))
dev.off()
```

```{r,eval=FALSE,include=TRUE}
png(file ="./figures/figure4-0_prior1000.png",width = 480,height = 480 )
plot(k_prior3$All.index,main="sample of 1000, log2 data Silhouette index",xlab="Number of components",ylab="index",type="l",xaxt = "n")
axis(1,at=c(1,2,3,4,5,6),labels=c(2,3,4,5,6,7))
dev.off()
```

```{r,eval=FALSE,include=TRUE}
png(file ="./figures/figure4-6.png",width = 480,height = 480 )

l1 <- paste('l[1,',1:14,']',sep='')
l2 <- paste('l[2,',1:14,']',sep='')
l3 <- paste('l[3,',1:14,']',sep='')
l4 <- paste('l[4,',1:14,']',sep='')
l5 <- paste('l[5,',1:14,']',sep='')

fit4_means <- apply(as.matrix(mean_scale2.2_log2_t2_10k_2 ), 2, median)

l1.m <- fit4_means[l1]
l2.m <- fit4_means[l2]
l3.m <- fit4_means[l3]
l4.m <- fit4_means[l4]
l5.m <- fit4_means[l5]

ts.plot(t(mean_scale2.2_log2_t2),col="gray",main = "Sample of 1000, Centers")

lines(1:14,l1.m,"l",col="red", lwd=1.5 ,lty=4)
lines(1:14,l2.m,"l",col="blue", lwd=1.5,lty=4)
lines(1:14,l3.m,"l",col="black", lwd=1.5,lty=4)
lines(1:14,l4.m,"l",col="purple", lwd=1.5,lty=4)

dev.off()
```


```{r,eval=FALSE,include=TRUE}
png(file ="./figures/figure4-7.png",width = 960,height = 960 )
par(mfrow=c(2,2))
mean_scale2.2_log2_t2t <- t(mean_scale2.2_log2_t2)

dist_to_L4_1 <- c()
for (i in 1:ncol(mean_scale2.2_log2_t2t)) {
  dist_to_L4_1[i] <- fit4_means["theta[1]"]/sqrt(fit4_means["epsilon[1]"])*exp(-0.5*(sum((l1.m - mean_scale2.2_log2_t2t[,i])^2))/fit4_means["epsilon[1]"])
}
dist_to_L4_2 <- c()
for (i in 1:ncol(mean_scale2.2_log2_t2t)) {
  dist_to_L4_2[i] <- fit4_means["theta[2]"]/sqrt(fit4_means["epsilon[2]"])*exp(-0.5*(sum((l2.m - mean_scale2.2_log2_t2t[,i])^2))/fit4_means["epsilon[2]"])
}
dist_to_L4_3 <- c()
for (i in 1:ncol(mean_scale2.2_log2_t2t)) {
  dist_to_L4_3[i] <- fit4_means["theta[3]"]/sqrt(fit4_means["epsilon[3]"])*exp(-0.5*(sum((l3.m - mean_scale2.2_log2_t2t[,i])^2))/fit4_means["epsilon[3]"])
}

Ldist4 <- data.frame(dist_to_L4_1,dist_to_L4_2,dist_to_L4_3)#,dist_to_L4_4,dist_to_L4_5
assignments4 <- c(apply(Ldist4,1,max1))

plot(1:nrow(mean_scale2.2_log2_t2t),mean_scale2.2_log2_t2t[,1],type = "l",col=assignments4[1],xlab = "Time",ylab = "",ylim = c(-1,21),main="Full data")
for (i in 1:ncol(mean_scale2.2_log2_t2t)) {
  lines(1:nrow(mean_scale2.2_log2_t2t),mean_scale2.2_log2_t2t[,i],type = "l",col=assignments4[i])
}

table(assignments4)#/ncol(test_data)
#cut 0.15 tai 0.25
ts.plot(mean_scale2.2_log2_t2t[,which(assignments4==1)],col="black", gpars=list( xlab="", ylab="",xaxt="n"))
ts.plot(mean_scale2.2_log2_t2t[,which(assignments4==2)],col="red", gpars=list( xlab="", ylab="",xaxt="n"))
ts.plot(mean_scale2.2_log2_t2t[,which(assignments4==3)],col="blue", gpars=list( xlab="", ylab="",xaxt="n"))


dev.off()
```
Compare with Figure 4-1

```{r,eval=FALSE,include=TRUE}
png(file ="./figures/figure4-8.png",width = 960,height = 960 )
par(mfrow=c(2,2))
modelIndexChain1 <- read.csv("~/expression_1ks_appr4k8k/modelSelection/modelIndexChain1.csv",header = F)
barplot(table(modelIndexChain1$V1[8001:16000])/(length(modelIndexChain1$V1)/2),space = 0,main = "Model posterior distribution, 1000 fast", names.arg = c(2,3,4,5),xlab = "Model number")

modelIndexChain2 <- read.csv("~/expression_1ks_tarkka4k8k/modelSelection/modelIndexChain1.csv",header = F)
barplot(table(modelIndexChain2$V1[8001:16000])/(length(modelIndexChain2$V1)/2),space = 0,main = "Model posterior distribution, 1000 slow", names.arg = c(2,3,4,5),xlab = "Model number")

modelIndexChain3 <- read.csv("~/expression_2k_sample/modelSelection/modelIndexChain1.csv",header = F)
barplot(table(modelIndexChain3$V1[8001:16000])/(length(modelIndexChain3$V1)/2),space = 0,main = "Model posterior distribution, 2000 fast", names.arg = c(2,3,4,5),xlab = "Model number")

modelIndexChain4 <- read.csv("~/expression_2k_sample_tarkka/modelSelection/modelIndexChain1.csv",header = F)
barplot(table(modelIndexChain4$V1[8001:16000])/(length(modelIndexChain4$V1)/2),space = 0,main = "Model posterior distribution, 2000 slow", names.arg = c(2,3,4,5),xlab = "Model number")
dev.off()
```

```{r,eval=FALSE,include=TRUE}
png(file ="./figures/figure4-9.png",width = 960,height = 960 )
par(mfrow=c(2,2))
modelIndexChain1 <- read.csv("~/expression_1ks_appr4k8k/modelSelection/modelIndexChain1.csv",header = F)
barplot(table(modelIndexChain1$V1)/(length(modelIndexChain1$V1)),space = 0,main = "Model posterior distribution, 1000 fast", names.arg = c(2,3,4,5),xlab = "Model number")

modelIndexChain2 <- read.csv("~/expression_1ks_tarkka4k8k/modelSelection/modelIndexChain1.csv",header = F)
barplot(table(modelIndexChain2$V1)/(length(modelIndexChain2$V1)),space = 0,main = "Model posterior distribution, 1000 slow", names.arg = c(2,3,4,5),xlab = "Model number")

modelIndexChain3 <- read.csv("~/expression_2k_sample/modelSelection/modelIndexChain1.csv",header = F)
barplot(table(modelIndexChain3$V1)/(length(modelIndexChain3$V1)),space = 0,main = "Model posterior distribution, 2000 fast", names.arg = c(2,3,4,5),xlab = "Model number")

modelIndexChain4 <- read.csv("~/expression_2k_sample_tarkka/modelSelection/modelIndexChain1.csv",header = F)
barplot(table(modelIndexChain4$V1)/(length(modelIndexChain4$V1)),space = 0,main = "Model posterior distribution, 2000 slow", names.arg = c(2,3,4,5),xlab = "Model number")
dev.off()
```

```{r,eval=FALSE,include=TRUE}
png(file ="./figures/figure4-10.png",width = 480,height = 480 )
data <- as.list(fromJSON(file="~/expression_revisit/expression_1ks_appr4k8k/data/data.json"))
series <- (matrix(unlist(data$z),ncol = 1000, nrow = 14))
series_t <- (series)
ts.plot(series,main="Sample: 1000",xlab="Time")
dev.off()
```

```{r,eval=FALSE,include=TRUE}
data2 <- read.csv("~/expression_1ks_appr4k8k/goldStandardChains/2/2GSC1.csv")
data3 <- read.csv("~/expression_1ks_appr4k8k/goldStandardChains/3/3GSC1.csv")
data4 <- read.csv("~/expression_1ks_appr4k8k/goldStandardChains/4/4GSC1.csv")
data5 <- read.csv("~/expression_1ks_appr4k8k/goldStandardChains/5/5GSC1.csv")

```

```{r,eval=FALSE,include=TRUE}
fit2_means <- apply(data2,2,median)
fit3_means <- apply(data3,2,median)
fit4_means <- apply(data4,2,median)
fit5_means <- apply(data5,2,median)
```

```{r,eval=FALSE,include=TRUE}
fit2_CI <- posterior_interval(as.matrix(data2))
fit3_CI <- posterior_interval(as.matrix(data3))
fit4_CI <- posterior_interval(as.matrix(data4))
fit5_CI <- posterior_interval(as.matrix(data5))

l1 <- paste('l.1.',1:14,sep='')
l2 <- paste('l.2.',1:14,sep='')
l3 <- paste('l.3.',1:14,sep='')
l4 <- paste('l.4.',1:14,sep='')
l5 <- paste('l.5.',1:14,sep='')
```

```{r,eval=FALSE,include=TRUE}
png(file ="./figures/figure4-11.png",width = 960,height = 960 )
par(mfrow=c(2,2))

L2_1.1 <- fit2_means[l1]
L2_2.1 <- fit2_means[l2]

plot(1:nrow(series_t),series_t[,1],type = "l",col="gray",xlab = "Time",ylab ="",main= "2 components",ylim = c(0,21))
for (i in 1:ncol(series_t)) {
  lines(1:nrow(series_t),series_t[,i],type = "l",col="gray")
}
lines(1:14,L2_1.1,"l",col="red")
lines(1:14,L2_2.1,"l",col="green")

L3_1.1 <- fit3_means[l1]
L3_2.1 <- fit3_means[l2]
L3_3.1 <- fit3_means[l3]

plot(1:nrow(series_t),series_t[,1],type = "l",col="gray",xlab = "Time",ylab ="",main= "3 components",ylim = c(0,21))
for (i in 1:ncol(series_t)) {
  lines(1:nrow(series_t),series_t[,i],type = "l",col="gray")
}
lines(1:14,L3_1.1,"l",col="red")
lines(1:14,L3_2.1,"l",col="green")
lines(1:14,L3_3.1,"l",col="blue")

L4_1.1 <- fit4_means[l1]
L4_2.1 <- fit4_means[l2]
L4_3.1 <- fit4_means[l3]
L4_4.1 <- fit4_means[l4]

plot(1:nrow(series_t),series_t[,1],type = "l",col="gray",xlab = "Time",ylab ="",main= "4 components",ylim = c(0,21))
for (i in 1:ncol(series_t)) {
  lines(1:nrow(series_t),series_t[,i],type = "l",col="gray")
}
lines(1:14,L4_1.1,"l",col="red")
lines(1:14,L4_2.1,"l",col="green")
lines(1:14,L4_3.1,"l",col="blue")
lines(1:14,L4_4.1,"l",col="purple")

L5_1.1 <- fit5_means[l1]
L5_2.1 <- fit5_means[l2]
L5_3.1 <- fit5_means[l3]
L5_4.1 <- fit5_means[l4]
L5_5.1 <- fit5_means[l5]

plot(1:nrow(series_t),series_t[,1],type = "l",col="gray",xlab = "Time",ylab ="",main= "5 components",ylim = c(0,21))
for (i in 1:ncol(series_t)) {
  lines(1:nrow(series_t),series_t[,i],type = "l",col="gray")
}
lines(1:14,L5_1.1,"l",col="red")
lines(1:14,L5_2.1,"l",col="green")
lines(1:14,L5_3.1,"l",col="blue")
lines(1:14,L5_4.1,"l",col="purple")
lines(1:14,L5_5.1,"l",col="blueviolet")

dev.off()
```

```{r,eval=FALSE,include=TRUE}
png(file ="./figures/figure4-12.png",width = 960,height = 960 )
par(mfrow=c(2,2))

dist_to_L2_1.1 <- c()
for (i in 1:ncol(series_t)) {
  dist_to_L2_1.1[i] <- fit2_means["theta.1"]/sqrt(fit2_means["epsilon.1"])*exp(-0.5*(sum((L2_1.1 - series_t[,i])^2))/fit2_means["epsilon.1"])
}
dist_to_L2_2.1 <- c()
for (i in 1:ncol(series_t)) {
  dist_to_L2_2.1[i] <- fit2_means["theta.2"]/sqrt(fit2_means["epsilon.2"])*exp(-0.5*(sum((L2_2.1 - series_t[,i])^2))/fit2_means["epsilon.2"])
}

Ldist2.1 <- data.frame(dist_to_L2_1.1,dist_to_L2_2.1)
assignments2.1 <- c(apply(Ldist2.1,1,max1))

plot(1:nrow(series_t),series_t[,1],type = "l",col=assignments2.1[1],xlab = "t",ylab ="", main= "2 components",ylim = c(0,21))
for (i in 1:ncol(series_t)) {
  lines(1:nrow(series_t),series_t[,i],type = "l",col=assignments2.1[i])
}

dist_to_L3_1.1 <- c()
for (i in 1:ncol(series_t)) {
  dist_to_L3_1.1[i] <- fit3_means["theta.1"]/sqrt(fit3_means["epsilon.1"])*exp(-0.5*(sum((L3_1.1 - series_t[,i])^2))/fit3_means["epsilon.1"])
}
dist_to_L3_2.1 <- c()
for (i in 1:ncol(series_t)) {
  dist_to_L3_2.1[i] <- fit3_means["theta.2"]/sqrt(fit3_means["epsilon.2"])*exp(-0.5*(sum((L3_2.1 - series_t[,i])^2))/fit3_means["epsilon.2"])
}
dist_to_L3_3.1 <- c()
for (i in 1:ncol(series_t)) {
  dist_to_L3_3.1[i] <- fit3_means["theta.3"]/sqrt(fit3_means["epsilon.3"])*exp(-0.5*(sum((L3_3.1 - series_t[,i])^2))/fit3_means["epsilon.3"])
}

Ldist3.1 <- data.frame(dist_to_L3_1.1,dist_to_L3_2.1,dist_to_L3_3.1)
assignments3.1 <- c(apply(Ldist3.1,1,max1))

plot(1:nrow(series_t),series_t[,1],type = "l",col=assignments3.1[1],xlab = "t",ylab ="", main= "3 components",ylim = c(0,21))
for (i in 1:ncol(series_t)) {
  lines(1:nrow(series_t),series_t[,i],type = "l",col=assignments3.1[i])
}

dist_to_L4_1.1 <- c()
for (i in 1:ncol(series_t)) {
  dist_to_L4_1.1[i] <- fit4_means["theta.1"]/sqrt(fit4_means["epsilon.1"])*exp(-0.5*(sum((L4_1.1 - series_t[,i])^2))/fit4_means["epsilon.1"])
}
dist_to_L4_2.1 <- c()
for (i in 1:ncol(series_t)) {
  dist_to_L4_2.1[i] <- fit4_means["theta.2"]/sqrt(fit4_means["epsilon.2"])*exp(-0.5*(sum((L4_2.1 - series_t[,i])^2))/fit4_means["epsilon.2"])
}
dist_to_L4_3.1 <- c()
for (i in 1:ncol(series_t)) {
  dist_to_L4_3.1[i] <- fit4_means["theta.3"]/sqrt(fit4_means["epsilon.3"])*exp(-0.5*(sum((L4_3.1 - series_t[,i])^2))/fit4_means["epsilon.3"])
}
dist_to_L4_4.1 <- c()
for (i in 1:ncol(series_t)) {
  dist_to_L4_4.1[i] <- fit4_means["theta.4"]/sqrt(fit4_means["epsilon.4"])*exp(-0.5*(sum((L4_4.1 - series_t[,i])^2))/fit4_means["epsilon.4"])
}

Ldist4.1 <- data.frame(dist_to_L4_1.1,dist_to_L4_2.1,dist_to_L4_3.1,dist_to_L4_4.1)
assignments4.1 <- c(apply(Ldist4.1,1,max1))

plot(1:nrow(series_t),series_t[,1],type = "l",col=assignments4.1[1],xlab = "t",ylab ="",main= "4 components",ylim = c(0,21))
for (i in 1:ncol(series_t)) {
  lines(1:nrow(series_t),series_t[,i],type = "l",col=assignments4.1[i])
}

dist_to_L5_1.1 <- c()
for (i in 1:ncol(series_t)) {
  dist_to_L5_1.1[i] <- fit5_means["theta.1"]/sqrt(fit5_means["epsilon.1"])*exp(-0.5*(sum((L5_1.1 - series_t[,i])^2))/fit5_means["epsilon.1"])
}
dist_to_L5_2.1 <- c()
for (i in 1:ncol(series_t)) {
  dist_to_L5_2.1[i] <- fit5_means["theta.2"]/sqrt(fit5_means["epsilon.2"])*exp(-0.5*(sum((L5_2.1 - series_t[,i])^2))/fit5_means["epsilon.2"])
}
dist_to_L5_3.1 <- c()
for (i in 1:ncol(series_t)) {
  dist_to_L5_3.1[i] <- fit5_means["theta.3"]/sqrt(fit5_means["epsilon.3"])*exp(-0.5*(sum((L5_3.1 - series_t[,i])^2))/fit5_means["epsilon.3"])
}
dist_to_L5_4.1 <- c()
for (i in 1:ncol(series_t)) {
  dist_to_L5_4.1[i] <- fit5_means["theta.4"]/sqrt(fit5_means["epsilon.4"])*exp(-0.5*(sum((L5_4.1 - series_t[,i])^2))/fit5_means["epsilon.4"])
}
dist_to_L5_5.1 <- c()
for (i in 1:ncol(series_t)) {
  dist_to_L5_5.1[i] <- fit5_means["theta.5"]/sqrt(fit5_means["epsilon.5"])*exp(-0.5*(sum((L5_5.1 - series_t[,i])^2))/fit5_means["epsilon.5"])
}
Ldist5.1 <- data.frame(dist_to_L5_1.1,dist_to_L5_2.1,dist_to_L5_3.1,dist_to_L5_4.1,dist_to_L5_5.1)
assignments5.1 <- c(apply(Ldist5.1,1,max1))

plot(1:nrow(series_t),series_t[,1],type = "l",col=assignments5.1[1],xlab = "t",ylab ="",main= "5 components",ylim = c(0,21))
for (i in 1:ncol(series_t)) {
  lines(1:nrow(series_t),series_t[,i],type = "l",col=assignments5.1[i])
}

dev.off()
```

```{r,echo=FALSE}
round(table(assignments2.1)/1000,5);round(fit2_means[c("theta.1","theta.2")],5)
round(table(assignments3.1)/1000,5);round(fit3_means[c("theta.1","theta.2","theta.3")],5)
round(table(assignments4.1)/1000,5);round(fit4_means[c("theta.1","theta.2","theta.3","theta.4")],5)
round(table(assignments5.1)/1000,5);round(fit5_means[c("theta.1","theta.2","theta.3","theta.4","theta.5")],5)
```

Slow version

```{r,eval=FALSE,include=TRUE}
data2 <- read.csv("~/expression_1ks_tarkka4k8k/goldStandardChains/2/2GSC1.csv")
data3 <- read.csv("~/expression_1ks_tarkka4k8k/goldStandardChains/3/3GSC1.csv")
data4 <- read.csv("~/expression_1ks_tarkka4k8k/goldStandardChains/4/4GSC1.csv")
data5 <- read.csv("~/expression_1ks_tarkka4k8k/goldStandardChains/5/5GSC1.csv")

```

```{r,eval=FALSE,include=TRUE}
fit2_means <- apply(data2,2,median)
fit3_means <- apply(data3,2,median)
fit4_means <- apply(data4,2,median)
fit5_means <- apply(data5,2,median)
```

```{r,eval=FALSE,include=TRUE}
fit2_CI <- posterior_interval(as.matrix(data2))
fit3_CI <- posterior_interval(as.matrix(data3))
fit4_CI <- posterior_interval(as.matrix(data4))
fit5_CI <- posterior_interval(as.matrix(data5))

l1 <- paste('l.1.',1:14,sep='')
l2 <- paste('l.2.',1:14,sep='')
l3 <- paste('l.3.',1:14,sep='')
l4 <- paste('l.4.',1:14,sep='')
l5 <- paste('l.5.',1:14,sep='')
```

```{r,eval=FALSE,include=TRUE}
png(file ="./figures/figure4-13.png",width = 960,height = 960 )
par(mfrow=c(2,2))

L2_1.2 <- fit2_means[l1]
L2_2.2 <- fit2_means[l2]

plot(1:nrow(series_t),series_t[,1],type = "l",col="gray",xlab = "Time",ylab ="",main= "2 components",ylim = c(0,21))
for (i in 1:ncol(series_t)) {
  lines(1:nrow(series_t),series_t[,i],type = "l",col="gray")
}
lines(1:14,L2_1.2,"l",col="red")
lines(1:14,L2_2.2,"l",col="green")

L3_1.2 <- fit3_means[l1]
L3_2.2 <- fit3_means[l2]
L3_3.2 <- fit3_means[l3]

plot(1:nrow(series_t),series_t[,1],type = "l",col="gray",xlab = "Time",ylab ="",main= "3 components",ylim = c(0,21))
for (i in 1:ncol(series_t)) {
  lines(1:nrow(series_t),series_t[,i],type = "l",col="gray")
}
lines(1:14,L3_1.2,"l",col="red")
lines(1:14,L3_2.2,"l",col="green")
lines(1:14,L3_3.2,"l",col="blue")

L4_1.2 <- fit4_means[l1]
L4_2.2 <- fit4_means[l2]
L4_3.2 <- fit4_means[l3]
L4_4.2 <- fit4_means[l4]

plot(1:nrow(series_t),series_t[,1],type = "l",col="gray",xlab = "Time",ylab ="",main= "4 components",ylim = c(0,21))
for (i in 1:ncol(series_t)) {
  lines(1:nrow(series_t),series_t[,i],type = "l",col="gray")
}
lines(1:14,L4_1.2,"l",col="red")
lines(1:14,L4_2.2,"l",col="green")
lines(1:14,L4_3.2,"l",col="blue")
lines(1:14,L4_4.2,"l",col="purple")

L5_1.2 <- fit5_means[l1]
L5_2.2 <- fit5_means[l2]
L5_3.2 <- fit5_means[l3]
L5_4.2 <- fit5_means[l4]
L5_5.2 <- fit5_means[l5]

plot(1:nrow(series_t),series_t[,1],type = "l",col="gray",xlab = "Time",ylab ="",main= "5 components",ylim = c(0,21))
for (i in 1:ncol(series_t)) {
  lines(1:nrow(series_t),series_t[,i],type = "l",col="gray")
}
lines(1:14,L5_1.2,"l",col="red")
lines(1:14,L5_2.2,"l",col="green")
lines(1:14,L5_3.2,"l",col="blue")
lines(1:14,L5_4.2,"l",col="purple")
lines(1:14,L5_5.2,"l",col="blueviolet")

dev.off()
```

```{r,eval=FALSE,include=TRUE}
png(file ="./figures/figure4-14.png",width = 960,height = 960 )
par(mfrow=c(2,2))

dist_to_L2_1.2 <- c()
for (i in 1:ncol(series_t)) {
  dist_to_L2_1.2[i] <- fit2_means["theta.1"]/sqrt(fit2_means["epsilon.1"])*exp(-0.5*(sum((L2_1.2 - series_t[,i])^2))/fit2_means["epsilon.1"])
}
dist_to_L2_2.2 <- c()
for (i in 1:ncol(series_t)) {
  dist_to_L2_2.2[i] <- fit2_means["theta.2"]/sqrt(fit2_means["epsilon.2"])*exp(-0.5*(sum((L2_2.2 - series_t[,i])^2))/fit2_means["epsilon.2"])
}

Ldist2.2 <- data.frame(dist_to_L2_1.2,dist_to_L2_2.2)
assignments2.2 <- c(apply(Ldist2.2,1,max1))

plot(1:nrow(series_t),series_t[,1],type = "l",col=assignments2.2[1],xlab = "t",ylab ="", main= "2 components",ylim = c(0,21))
for (i in 1:ncol(series_t)) {
  lines(1:nrow(series_t),series_t[,i],type = "l",col=assignments2.2[i])
}

dist_to_L3_1.2 <- c()
for (i in 1:ncol(series_t)) {
  dist_to_L3_1.2[i] <- fit3_means["theta.1"]/sqrt(fit3_means["epsilon.1"])*exp(-0.5*(sum((L3_1.2 - series_t[,i])^2))/fit3_means["epsilon.1"])
}
dist_to_L3_2.2 <- c()
for (i in 1:ncol(series_t)) {
  dist_to_L3_2.2[i] <- fit3_means["theta.2"]/sqrt(fit3_means["epsilon.2"])*exp(-0.5*(sum((L3_2.2 - series_t[,i])^2))/fit3_means["epsilon.2"])
}
dist_to_L3_3.2 <- c()
for (i in 1:ncol(series_t)) {
  dist_to_L3_3.2[i] <- fit3_means["theta.3"]/sqrt(fit3_means["epsilon.3"])*exp(-0.5*(sum((L3_3.2 - series_t[,i])^2))/fit3_means["epsilon.3"])
}

Ldist3.2 <- data.frame(dist_to_L3_1.2,dist_to_L3_2.2,dist_to_L3_3.2)
assignments3.2 <- c(apply(Ldist3.2,1,max1))

plot(1:nrow(series_t),series_t[,1],type = "l",col=assignments3.2[1],xlab = "t",ylab ="", main= "3 components",ylim = c(0,21))
for (i in 1:ncol(series_t)) {
  lines(1:nrow(series_t),series_t[,i],type = "l",col=assignments3.2[i])
}

dist_to_L4_1.2 <- c()
for (i in 1:ncol(series_t)) {
  dist_to_L4_1.2[i] <- fit4_means["theta.1"]/sqrt(fit4_means["epsilon.1"])*exp(-0.5*(sum((L4_1.2 - series_t[,i])^2))/fit4_means["epsilon.1"])
}
dist_to_L4_2.2 <- c()
for (i in 1:ncol(series_t)) {
  dist_to_L4_2.2[i] <- fit4_means["theta.2"]/sqrt(fit4_means["epsilon.2"])*exp(-0.5*(sum((L4_2.2 - series_t[,i])^2))/fit4_means["epsilon.2"])
}
dist_to_L4_3.2 <- c()
for (i in 1:ncol(series_t)) {
  dist_to_L4_3.2[i] <- fit4_means["theta.3"]/sqrt(fit4_means["epsilon.3"])*exp(-0.5*(sum((L4_3.2 - series_t[,i])^2))/fit4_means["epsilon.3"])
}
dist_to_L4_4.2 <- c()
for (i in 1:ncol(series_t)) {
  dist_to_L4_4.2[i] <- fit4_means["theta.4"]/sqrt(fit4_means["epsilon.4"])*exp(-0.5*(sum((L4_4.2 - series_t[,i])^2))/fit4_means["epsilon.4"])
}

Ldist4.2 <- data.frame(dist_to_L4_1.2,dist_to_L4_2.2,dist_to_L4_3.2,dist_to_L4_4.2)
assignments4.2 <- c(apply(Ldist4.2,1,max1))

plot(1:nrow(series_t),series_t[,1],type = "l",col=assignments4.2[1],xlab = "t",ylab ="",main= "4 components",ylim = c(0,21))
for (i in 1:ncol(series_t)) {
  lines(1:nrow(series_t),series_t[,i],type = "l",col=assignments4.2[i])
}

dist_to_L5_1.2 <- c()
for (i in 1:ncol(series_t)) {
  dist_to_L5_1.2[i] <- fit5_means["theta.1"]/sqrt(fit5_means["epsilon.1"])*exp(-0.5*(sum((L5_1.2 - series_t[,i])^2))/fit5_means["epsilon.1"])
}
dist_to_L5_2.2 <- c()
for (i in 1:ncol(series_t)) {
  dist_to_L5_2.2[i] <- fit5_means["theta.2"]/sqrt(fit5_means["epsilon.2"])*exp(-0.5*(sum((L5_2.2 - series_t[,i])^2))/fit5_means["epsilon.2"])
}
dist_to_L5_3.2 <- c()
for (i in 1:ncol(series_t)) {
  dist_to_L5_3.2[i] <- fit5_means["theta.3"]/sqrt(fit5_means["epsilon.3"])*exp(-0.5*(sum((L5_3.2 - series_t[,i])^2))/fit5_means["epsilon.3"])
}
dist_to_L5_4.2 <- c()
for (i in 1:ncol(series_t)) {
  dist_to_L5_4.2[i] <- fit5_means["theta.4"]/sqrt(fit5_means["epsilon.4"])*exp(-0.5*(sum((L5_4.2 - series_t[,i])^2))/fit5_means["epsilon.4"])
}
dist_to_L5_5.2 <- c()
for (i in 1:ncol(series_t)) {
  dist_to_L5_5.2[i] <- fit5_means["theta.5"]/sqrt(fit5_means["epsilon.5"])*exp(-0.5*(sum((L5_5.2 - series_t[,i])^2))/fit5_means["epsilon.5"])
}
Ldist5.2 <- data.frame(dist_to_L5_1.2,dist_to_L5_2.2,dist_to_L5_3.2,dist_to_L5_4.2,dist_to_L5_5.2)
assignments5.2 <- c(apply(Ldist5.2,1,max1))

plot(1:nrow(series_t),series_t[,1],type = "l",col=assignments5.2[1],xlab = "t",ylab ="",main= "5 components",ylim = c(0,21))
for (i in 1:ncol(series_t)) {
  lines(1:nrow(series_t),series_t[,i],type = "l",col=assignments5.2[i])
}

dev.off()
```

```{r,echo=FALSE}
round(table(assignments2.2)/1000,5);round(fit2_means[c("theta.1","theta.2")],5)
round(table(assignments3.2)/1000,5);round(fit3_means[c("theta.1","theta.2","theta.3")],5)
round(table(assignments4.2)/1000,5);round(fit4_means[c("theta.1","theta.2","theta.3","theta.4")],5)
round(table(assignments5.2)/1000,5);round(fit5_means[c("theta.1","theta.2","theta.3","theta.4","theta.5")],5)
```

| Sample: 1000 	| K 	| Theta.1 	| Theta.2 	| Theta.3 	| Theta.4 	| Theta.5 	| Slow 	| Theta.1 	| Theta.2 	| Theta.3 	| Theta.4 	| Theta.5 	|
|:------------:	|:-:	|:-------:	|:-------:	|:-------:	|:-------:	|:-------:	|------	|:-------:	|:-------:	|:-------:	|:-------:	|:-------:	|
| Estimated    	| 2 	| 0.39401 	| 0.60599 	|         	|         	|         	|      	| 0.3704  	| 0.6296  	|         	|         	|         	|
|              	| 3 	| 0.25314 	| 0.44169 	| 0.30493 	|         	|         	|      	| 0.29246 	| 0.39773 	| 0.30927 	|         	|         	|
|              	| 4 	| 0.21342 	| 0.24477 	| 0.30686 	| 0.23396 	|         	|      	| 0.29339 	| 0.23896 	| 0.12894 	| 0.33829 	|         	|
|              	| 5 	| 0.18355 	| 0.19067 	| 0.19968 	| 0.17923 	| 0.24594 	|      	| 0.26417 	| 0.20473 	| 0.00927 	| 0.28952 	| 0.23112 	|
|              	|   	|         	|         	|         	|         	|         	|      	|         	|         	|         	|         	|         	|
| Assignments  	| 2 	| 0.426   	| 0.574   	|         	|         	|         	|      	| 0.407   	| 0.593   	|         	|         	|         	|
|              	| 3 	| 0.266   	| 0.442   	| 0.292   	|         	|         	|      	| 0.324   	| 0.397   	| 0.279   	|         	|         	|
|              	| 4 	| 0.221   	| 0.244   	| 0.306   	| 0.229   	|         	|      	| 0.327   	| 0.246   	| 0.127   	| 0.300   	|         	|
|              	| 5 	| 0.189   	| 0.189   	| 0.199   	| 0.174   	| 0.249   	|      	| 0.291   	| 0.212   	| 0.004   	| 0.263   	| 0.230   	|

```{r,eval=FALSE,include=TRUE}
png(file ="./figures/figure4-21.png",width = 480,height = 480 )
ts.plot(series[,which(assignments5.2==3)],main="1000 slow, cluster 3")
dev.off()
```


2k sample
```{r,eval=FALSE,include=TRUE}
png(file ="./figures/figure4-15.png",width = 480,height = 480 )
data <- as.list(fromJSON(file="~/expression_revisit/expression_2k_sample/data/data.json"))
series <- (matrix(unlist(data$z),ncol = 2000, nrow = 14))
series_t <- (series)
ts.plot(series,main="Sample: 2000",xlab="Time")
dev.off()
```

```{r,eval=FALSE,include=TRUE}
data2 <- read.csv("~/expression_2k_sample/goldStandardChains/2/2GSC1.csv")
data3 <- read.csv("~/expression_2k_sample/goldStandardChains/3/3GSC1.csv")
data4 <- read.csv("~/expression_2k_sample/goldStandardChains/4/4GSC1.csv")
data5 <- read.csv("~/expression_2k_sample/goldStandardChains/5/5GSC1.csv")

```

```{r,eval=FALSE,include=TRUE}
fit2_means <- apply(data2,2,median)
fit3_means <- apply(data3,2,median)
fit4_means <- apply(data4,2,median)
fit5_means <- apply(data5,2,median)
```

```{r,eval=FALSE,include=TRUE}
fit2_CI <- posterior_interval(as.matrix(data2))
fit3_CI <- posterior_interval(as.matrix(data3))
fit4_CI <- posterior_interval(as.matrix(data4))
fit5_CI <- posterior_interval(as.matrix(data5))

l1 <- paste('l.1.',1:14,sep='')
l2 <- paste('l.2.',1:14,sep='')
l3 <- paste('l.3.',1:14,sep='')
l4 <- paste('l.4.',1:14,sep='')
l5 <- paste('l.5.',1:14,sep='')
```

```{r,eval=FALSE,include=TRUE}
png(file ="./figures/figure4-16.png",width = 960,height = 960 )
par(mfrow=c(2,2))

L2_1.3 <- fit2_means[l1]
L2_2.3 <- fit2_means[l2]

plot(1:nrow(series_t),series_t[,1],type = "l",col="gray",xlab = "Time",ylab ="",main= "2 components",ylim = c(0,21))
for (i in 1:ncol(series_t)) {
  lines(1:nrow(series_t),series_t[,i],type = "l",col="gray")
}
lines(1:14,L2_1.3,"l",col="red")
lines(1:14,L2_2.3,"l",col="green")

L3_1.3 <- fit3_means[l1]
L3_2.3 <- fit3_means[l2]
L3_3.3 <- fit3_means[l3]

plot(1:nrow(series_t),series_t[,1],type = "l",col="gray",xlab = "Time",ylab ="",main= "3 components",ylim = c(0,21))
for (i in 1:ncol(series_t)) {
  lines(1:nrow(series_t),series_t[,i],type = "l",col="gray")
}
lines(1:14,L3_1.3,"l",col="red")
lines(1:14,L3_2.3,"l",col="green")
lines(1:14,L3_3.3,"l",col="blue")

L4_1.3 <- fit4_means[l1]
L4_2.3 <- fit4_means[l2]
L4_3.3 <- fit4_means[l3]
L4_4.3 <- fit4_means[l4]

plot(1:nrow(series_t),series_t[,1],type = "l",col="gray",xlab = "Time",ylab ="",main= "4 components",ylim = c(0,21))
for (i in 1:ncol(series_t)) {
  lines(1:nrow(series_t),series_t[,i],type = "l",col="gray")
}
lines(1:14,L4_1.3,"l",col="red")
lines(1:14,L4_2.3,"l",col="green")
lines(1:14,L4_3.3,"l",col="blue")
lines(1:14,L4_4.3,"l",col="purple")

L5_1.3 <- fit5_means[l1]
L5_2.3 <- fit5_means[l2]
L5_3.3 <- fit5_means[l3]
L5_4.3 <- fit5_means[l4]
L5_5.3 <- fit5_means[l5]

plot(1:nrow(series_t),series_t[,1],type = "l",col="gray",xlab = "Time",ylab ="",main= "5 components",ylim = c(0,21))
for (i in 1:ncol(series_t)) {
  lines(1:nrow(series_t),series_t[,i],type = "l",col="gray")
}
lines(1:14,L5_1.3,"l",col="red")
lines(1:14,L5_2.3,"l",col="green")
lines(1:14,L5_3.3,"l",col="blue")
lines(1:14,L5_4.3,"l",col="purple")
lines(1:14,L5_5.3,"l",col="blueviolet")

dev.off()
```

```{r,eval=FALSE,include=TRUE}
png(file ="./figures/figure4-17.png",width = 960,height = 960 )
par(mfrow=c(2,2))

dist_to_L2_1.3 <- c()
for (i in 1:ncol(series_t)) {
  dist_to_L2_1.3[i] <- fit2_means["theta.1"]/sqrt(fit2_means["epsilon.1"])*exp(-0.5*(sum((L2_1.3 - series_t[,i])^2))/fit2_means["epsilon.1"])
}
dist_to_L2_2.3 <- c()
for (i in 1:ncol(series_t)) {
  dist_to_L2_2.3[i] <- fit2_means["theta.2"]/sqrt(fit2_means["epsilon.2"])*exp(-0.5*(sum((L2_2.3 - series_t[,i])^2))/fit2_means["epsilon.2"])
}

Ldist2.3 <- data.frame(dist_to_L2_1.3,dist_to_L2_2.3)
assignments2.3 <- c(apply(Ldist2.3,1,max1))

plot(1:nrow(series_t),series_t[,1],type = "l",col=assignments2.3[1],xlab = "t",ylab ="", main= "2 components",ylim = c(0,21))
for (i in 1:ncol(series_t)) {
  lines(1:nrow(series_t),series_t[,i],type = "l",col=assignments2.3[i])
}

dist_to_L3_1.3 <- c()
for (i in 1:ncol(series_t)) {
  dist_to_L3_1.3[i] <- fit3_means["theta.1"]/sqrt(fit3_means["epsilon.1"])*exp(-0.5*(sum((L3_1.3 - series_t[,i])^2))/fit3_means["epsilon.1"])
}
dist_to_L3_2.3 <- c()
for (i in 1:ncol(series_t)) {
  dist_to_L3_2.3[i] <- fit3_means["theta.2"]/sqrt(fit3_means["epsilon.2"])*exp(-0.5*(sum((L3_2.3 - series_t[,i])^2))/fit3_means["epsilon.2"])
}
dist_to_L3_3.3 <- c()
for (i in 1:ncol(series_t)) {
  dist_to_L3_3.3[i] <- fit3_means["theta.3"]/sqrt(fit3_means["epsilon.3"])*exp(-0.5*(sum((L3_3.3 - series_t[,i])^2))/fit3_means["epsilon.3"])
}

Ldist3.3 <- data.frame(dist_to_L3_1.3,dist_to_L3_2.3,dist_to_L3_3.3)
assignments3.3 <- c(apply(Ldist3.3,1,max1))

plot(1:nrow(series_t),series_t[,1],type = "l",col=assignments3.3[1],xlab = "t",ylab ="", main= "3 components",ylim = c(0,21))
for (i in 1:ncol(series_t)) {
  lines(1:nrow(series_t),series_t[,i],type = "l",col=assignments3.3[i])
}

dist_to_L4_1.3 <- c()
for (i in 1:ncol(series_t)) {
  dist_to_L4_1.3[i] <- fit4_means["theta.1"]/sqrt(fit4_means["epsilon.1"])*exp(-0.5*(sum((L4_1.3 - series_t[,i])^2))/fit4_means["epsilon.1"])
}
dist_to_L4_2.3 <- c()
for (i in 1:ncol(series_t)) {
  dist_to_L4_2.3[i] <- fit4_means["theta.2"]/sqrt(fit4_means["epsilon.2"])*exp(-0.5*(sum((L4_2.3 - series_t[,i])^2))/fit4_means["epsilon.2"])
}
dist_to_L4_3.3 <- c()
for (i in 1:ncol(series_t)) {
  dist_to_L4_3.3[i] <- fit4_means["theta.3"]/sqrt(fit4_means["epsilon.3"])*exp(-0.5*(sum((L4_3.3 - series_t[,i])^2))/fit4_means["epsilon.3"])
}
dist_to_L4_4.3 <- c()
for (i in 1:ncol(series_t)) {
  dist_to_L4_4.3[i] <- fit4_means["theta.4"]/sqrt(fit4_means["epsilon.4"])*exp(-0.5*(sum((L4_4.3 - series_t[,i])^2))/fit4_means["epsilon.4"])
}

Ldist4.3 <- data.frame(dist_to_L4_1.3,dist_to_L4_2.3,dist_to_L4_3.3,dist_to_L4_4.3)
assignments4.3 <- c(apply(Ldist4.3,1,max1))

plot(1:nrow(series_t),series_t[,1],type = "l",col=assignments4.3[1],xlab = "t",ylab ="",main= "4 components",ylim = c(0,21))
for (i in 1:ncol(series_t)) {
  lines(1:nrow(series_t),series_t[,i],type = "l",col=assignments4.3[i])
}

dist_to_L5_1.3 <- c()
for (i in 1:ncol(series_t)) {
  dist_to_L5_1.3[i] <- fit5_means["theta.1"]/sqrt(fit5_means["epsilon.1"])*exp(-0.5*(sum((L5_1.3 - series_t[,i])^2))/fit5_means["epsilon.1"])
}
dist_to_L5_2.3 <- c()
for (i in 1:ncol(series_t)) {
  dist_to_L5_2.3[i] <- fit5_means["theta.2"]/sqrt(fit5_means["epsilon.2"])*exp(-0.5*(sum((L5_2.3 - series_t[,i])^2))/fit5_means["epsilon.2"])
}
dist_to_L5_3.3 <- c()
for (i in 1:ncol(series_t)) {
  dist_to_L5_3.3[i] <- fit5_means["theta.3"]/sqrt(fit5_means["epsilon.3"])*exp(-0.5*(sum((L5_3.3 - series_t[,i])^2))/fit5_means["epsilon.3"])
}
dist_to_L5_4.3 <- c()
for (i in 1:ncol(series_t)) {
  dist_to_L5_4.3[i] <- fit5_means["theta.4"]/sqrt(fit5_means["epsilon.4"])*exp(-0.5*(sum((L5_4.3 - series_t[,i])^2))/fit5_means["epsilon.4"])
}
dist_to_L5_5.3 <- c()
for (i in 1:ncol(series_t)) {
  dist_to_L5_5.3[i] <- fit5_means["theta.5"]/sqrt(fit5_means["epsilon.5"])*exp(-0.5*(sum((L5_5.3 - series_t[,i])^2))/fit5_means["epsilon.5"])
}
Ldist5.3 <- data.frame(dist_to_L5_1.3,dist_to_L5_2.3,dist_to_L5_3.3,dist_to_L5_4.3,dist_to_L5_5.3)
assignments5.3 <- c(apply(Ldist5.3,1,max1))

plot(1:nrow(series_t),series_t[,1],type = "l",col=assignments5.3[1],xlab = "t",ylab ="",main= "5 components",ylim = c(0,21))
for (i in 1:ncol(series_t)) {
  lines(1:nrow(series_t),series_t[,i],type = "l",col=assignments5.3[i])
}

dev.off()
```

```{r,echo=FALSE}
round(table(assignments2.3)/2000,5);round(fit2_means[c("theta.1","theta.2")],5)
round(table(assignments3.3)/2000,5);round(fit3_means[c("theta.1","theta.2","theta.3")],5)
round(table(assignments4.3)/2000,5);round(fit4_means[c("theta.1","theta.2","theta.3","theta.4")],5)
round(table(assignments5.3)/2000,5);round(fit5_means[c("theta.1","theta.2","theta.3","theta.4","theta.5")],5)
```

```{r,eval=FALSE,include=TRUE}
data2 <- read.csv("~/expression_2ks_tarkka4k8k/goldStandardChains/2/2GSC1.csv")
data3 <- read.csv("~/expression_2ks_tarkka4k8k/goldStandardChains/3/3GSC1.csv")
data4 <- read.csv("~/expression_2ks_tarkka4k8k/goldStandardChains/4/4GSC1.csv")
data5 <- read.csv("~/expression_2ks_tarkka4k8k/goldStandardChains/5/5GSC1.csv")

```

```{r,eval=FALSE,include=TRUE}
fit2_means <- apply(data2,2,median)
fit3_means <- apply(data3,2,median)
fit4_means <- apply(data4,2,median)
fit5_means <- apply(data5,2,median)
```

```{r,eval=FALSE,include=TRUE}
fit2_CI <- posterior_interval(as.matrix(data2))
fit3_CI <- posterior_interval(as.matrix(data3))
fit4_CI <- posterior_interval(as.matrix(data4))
fit5_CI <- posterior_interval(as.matrix(data5))

l1 <- paste('l.1.',1:14,sep='')
l2 <- paste('l.2.',1:14,sep='')
l3 <- paste('l.3.',1:14,sep='')
l4 <- paste('l.4.',1:14,sep='')
l5 <- paste('l.5.',1:14,sep='')
```

```{r,eval=FALSE,include=TRUE}
png(file ="./figures/figure4-18.png",width = 960,height = 960 )
par(mfrow=c(2,2))

L2_1.4 <- fit2_means[l1]
L2_2.4 <- fit2_means[l2]

plot(1:nrow(series_t),series_t[,1],type = "l",col="gray",xlab = "Time",ylab ="",main= "2 components",ylim = c(0,21))
for (i in 1:ncol(series_t)) {
  lines(1:nrow(series_t),series_t[,i],type = "l",col="gray")
}
lines(1:14,L2_1.3,"l",col="red")
lines(1:14,L2_2.3,"l",col="green")

L3_1.4 <- fit3_means[l1]
L3_2.4 <- fit3_means[l2]
L3_3.4 <- fit3_means[l3]

plot(1:nrow(series_t),series_t[,1],type = "l",col="gray",xlab = "Time",ylab ="",main= "3 components",ylim = c(0,21))
for (i in 1:ncol(series_t)) {
  lines(1:nrow(series_t),series_t[,i],type = "l",col="gray")
}
lines(1:14,L3_1.4,"l",col="red")
lines(1:14,L3_2.4,"l",col="green")
lines(1:14,L3_3.4,"l",col="blue")

L4_1.4 <- fit4_means[l1]
L4_2.4 <- fit4_means[l2]
L4_3.4 <- fit4_means[l3]
L4_4.4 <- fit4_means[l4]

plot(1:nrow(series_t),series_t[,1],type = "l",col="gray",xlab = "Time",ylab ="",main= "4 components",ylim = c(0,21))
for (i in 1:ncol(series_t)) {
  lines(1:nrow(series_t),series_t[,i],type = "l",col="gray")
}
lines(1:14,L4_1.4,"l",col="red")
lines(1:14,L4_2.4,"l",col="green")
lines(1:14,L4_3.4,"l",col="blue")
lines(1:14,L4_4.4,"l",col="purple")

L5_1.4 <- fit5_means[l1]
L5_2.4 <- fit5_means[l2]
L5_3.4 <- fit5_means[l3]
L5_4.4 <- fit5_means[l4]
L5_5.4 <- fit5_means[l5]

plot(1:nrow(series_t),series_t[,1],type = "l",col="gray",xlab = "Time",ylab ="",main= "5 components",ylim = c(0,21))
for (i in 1:ncol(series_t)) {
  lines(1:nrow(series_t),series_t[,i],type = "l",col="gray")
}
lines(1:14,L5_1.4,"l",col="red")
lines(1:14,L5_2.4,"l",col="green")
lines(1:14,L5_3.4,"l",col="blue")
lines(1:14,L5_4.4,"l",col="purple")
lines(1:14,L5_5.4,"l",col="blueviolet")

dev.off()
```

```{r,eval=FALSE,include=TRUE}
png(file ="./figures/figure4-19.png",width = 960,height = 960 )
par(mfrow=c(2,2))

dist_to_L2_1.4 <- c()
for (i in 1:ncol(series_t)) {
  dist_to_L2_1.4[i] <- fit2_means["theta.1"]/sqrt(fit2_means["epsilon.1"])*exp(-0.5*(sum((L2_1.4 - series_t[,i])^2))/fit2_means["epsilon.1"])
}
dist_to_L2_2.4 <- c()
for (i in 1:ncol(series_t)) {
  dist_to_L2_2.4[i] <- fit2_means["theta.2"]/sqrt(fit2_means["epsilon.2"])*exp(-0.5*(sum((L2_2.4 - series_t[,i])^2))/fit2_means["epsilon.2"])
}

Ldist2.4 <- data.frame(dist_to_L2_1.4,dist_to_L2_2.4)
assignments2.4 <- c(apply(Ldist2.4,1,max1))

plot(1:nrow(series_t),series_t[,1],type = "l",col=assignments2.4[1],xlab = "t",ylab ="", main= "2 components",ylim = c(0,21))
for (i in 1:ncol(series_t)) {
  lines(1:nrow(series_t),series_t[,i],type = "l",col=assignments2.4[i])
}

dist_to_L3_1.4 <- c()
for (i in 1:ncol(series_t)) {
  dist_to_L3_1.4[i] <- fit3_means["theta.1"]/sqrt(fit3_means["epsilon.1"])*exp(-0.5*(sum((L3_1.4 - series_t[,i])^2))/fit3_means["epsilon.1"])
}
dist_to_L3_2.4 <- c()
for (i in 1:ncol(series_t)) {
  dist_to_L3_2.4[i] <- fit3_means["theta.2"]/sqrt(fit3_means["epsilon.2"])*exp(-0.5*(sum((L3_2.4 - series_t[,i])^2))/fit3_means["epsilon.2"])
}
dist_to_L3_3.4 <- c()
for (i in 1:ncol(series_t)) {
  dist_to_L3_3.4[i] <- fit3_means["theta.3"]/sqrt(fit3_means["epsilon.3"])*exp(-0.5*(sum((L3_3.4 - series_t[,i])^2))/fit3_means["epsilon.3"])
}

Ldist3.4 <- data.frame(dist_to_L3_1.4,dist_to_L3_2.4,dist_to_L3_3.4)
assignments3.4 <- c(apply(Ldist3.4,1,max1))

plot(1:nrow(series_t),series_t[,1],type = "l",col=assignments3.4[1],xlab = "t",ylab ="", main= "3 components",ylim = c(0,21))
for (i in 1:ncol(series_t)) {
  lines(1:nrow(series_t),series_t[,i],type = "l",col=assignments3.4[i])
}

dist_to_L4_1.4 <- c()
for (i in 1:ncol(series_t)) {
  dist_to_L4_1.4[i] <- fit4_means["theta.1"]/sqrt(fit4_means["epsilon.1"])*exp(-0.5*(sum((L4_1.4 - series_t[,i])^2))/fit4_means["epsilon.1"])
}
dist_to_L4_2.4 <- c()
for (i in 1:ncol(series_t)) {
  dist_to_L4_2.4[i] <- fit4_means["theta.2"]/sqrt(fit4_means["epsilon.2"])*exp(-0.5*(sum((L4_2.4 - series_t[,i])^2))/fit4_means["epsilon.2"])
}
dist_to_L4_3.4 <- c()
for (i in 1:ncol(series_t)) {
  dist_to_L4_3.4[i] <- fit4_means["theta.3"]/sqrt(fit4_means["epsilon.3"])*exp(-0.5*(sum((L4_3.4 - series_t[,i])^2))/fit4_means["epsilon.3"])
}
dist_to_L4_4.4 <- c()
for (i in 1:ncol(series_t)) {
  dist_to_L4_4.4[i] <- fit4_means["theta.4"]/sqrt(fit4_means["epsilon.4"])*exp(-0.5*(sum((L4_4.4 - series_t[,i])^2))/fit4_means["epsilon.4"])
}

Ldist4.4 <- data.frame(dist_to_L4_1.4,dist_to_L4_2.4,dist_to_L4_3.4,dist_to_L4_4.4)
assignments4.4 <- c(apply(Ldist4.4,1,max1))

plot(1:nrow(series_t),series_t[,1],type = "l",col=assignments4.4[1],xlab = "t",ylab ="",main= "4 components",ylim = c(0,21))
for (i in 1:ncol(series_t)) {
  lines(1:nrow(series_t),series_t[,i],type = "l",col=assignments4.4[i])
}

dist_to_L5_1.4 <- c()
for (i in 1:ncol(series_t)) {
  dist_to_L5_1.4[i] <- fit5_means["theta.1"]/sqrt(fit5_means["epsilon.1"])*exp(-0.5*(sum((L5_1.4 - series_t[,i])^2))/fit5_means["epsilon.1"])
}
dist_to_L5_2.4 <- c()
for (i in 1:ncol(series_t)) {
  dist_to_L5_2.4[i] <- fit5_means["theta.2"]/sqrt(fit5_means["epsilon.2"])*exp(-0.5*(sum((L5_2.4 - series_t[,i])^2))/fit5_means["epsilon.2"])
}
dist_to_L5_3.4 <- c()
for (i in 1:ncol(series_t)) {
  dist_to_L5_3.4[i] <- fit5_means["theta.3"]/sqrt(fit5_means["epsilon.3"])*exp(-0.5*(sum((L5_3.4 - series_t[,i])^2))/fit5_means["epsilon.3"])
}
dist_to_L5_4.4 <- c()
for (i in 1:ncol(series_t)) {
  dist_to_L5_4.4[i] <- fit5_means["theta.4"]/sqrt(fit5_means["epsilon.4"])*exp(-0.5*(sum((L5_4.4 - series_t[,i])^2))/fit5_means["epsilon.4"])
}
dist_to_L5_5.4 <- c()
for (i in 1:ncol(series_t)) {
  dist_to_L5_5.4[i] <- fit5_means["theta.5"]/sqrt(fit5_means["epsilon.5"])*exp(-0.5*(sum((L5_5.4 - series_t[,i])^2))/fit5_means["epsilon.5"])
}
Ldist5.4 <- data.frame(dist_to_L5_1.4,dist_to_L5_2.4,dist_to_L5_3.4,dist_to_L5_4.4,dist_to_L5_5.4)
assignments5.4 <- c(apply(Ldist5.4,1,max1))

plot(1:nrow(series_t),series_t[,1],type = "l",col=assignments5.4[1],xlab = "t",ylab ="",main= "5 components",ylim = c(0,21))
for (i in 1:ncol(series_t)) {
  lines(1:nrow(series_t),series_t[,i],type = "l",col=assignments5.4[i])
}

dev.off()
```

```{r,echo=FALSE}
round(table(assignments2.4)/2000,5);round(fit2_means[c("theta.1","theta.2")],5)
round(table(assignments3.4)/2000,5);round(fit3_means[c("theta.1","theta.2","theta.3")],5)
round(table(assignments4.4)/2000,5);round(fit4_means[c("theta.1","theta.2","theta.3","theta.4")],5)
round(table(assignments5.4)/2000,5);round(fit5_means[c("theta.1","theta.2","theta.3","theta.4","theta.5")],5)
```

| Sample: 2000 	| K 	| Theta.1 	| Theta.2 	| Theta.3 	| Theta.4 	| Theta.5 	| Slow 	| Theta.1 	| Theta.2 	| Theta.3 	| Theta.4 	| Theta.5 	|
|:------------:	|:-:	|:-------:	|:-------:	|:-------:	|:-------:	|:-------:	|------	|:-------:	|:-------:	|:-------:	|:-------:	|:-------:	|
|   Estimated  	| 2 	| 0.45385 	| 0.54615 	|         	|         	|         	|      	| 0.45971 	| 0.54029 	|         	|         	|         	|
|              	| 3 	| 0.23419 	| 0.43900 	| 0.32639 	|         	|         	|      	| 0.25852 	| 0.40368 	| 0.33761 	|         	|         	|
|              	| 4 	| 0.19531 	| 0.21926 	| 0.37278 	| 0.21239 	|         	|      	| 0.16847 	| 0.44636 	| 0.15017 	| 0.23462 	|         	|
|              	| 5 	| 0.19159 	| 0.24934 	| 0.19112 	| 0.19372 	| 0.17384 	|      	| 0.22352 	| 0.20074 	| 0.07562 	| 0.22610 	| 0.27345 	|
|              	|   	|         	|         	|         	|         	|         	|      	|         	|         	|         	|         	|         	|
|  Assignments 	| 2 	| 0.471   	| 0.529   	|         	|         	|         	|      	| 0.4745  	| 0.5255  	|         	|         	|         	|
|              	| 3 	| 0.2500  	| 0.4405  	| 0.3095  	|         	|         	|      	| 0.2945  	| 0.4040  	| 0.3015  	|         	|         	|
|              	| 4 	| 0.2015  	| 0.2185  	| 0.3735  	| 0.2065  	|         	|      	| 0.1660  	| 0.4455  	| 0.1500  	| 0.2385  	|         	|
|              	| 5 	| 0.1970  	| 0.2515  	| 0.1895  	| 0.1895  	| 0.1725  	|      	| 0.2495  	| 0.2030  	| 0.0475  	| 0.2215  	| 0.2785  	|


```{r,eval=FALSE,include=TRUE}
png(file ="./figures/figure4-22.png",width = 480,height = 480 )
ts.plot(series[,which(assignments5.4==3)],main="2000 slow, cluster 3")
dev.off()
```

Summary
```{r,eval=FALSE,include=TRUE}
png(file ="./figures/figure4-20.png",width = 960,height = 960 )
par(mfrow=c(2,2))


plot(1:nrow(series_t),series_t[,1],type = "l",col="gray",xlab = "Time",ylab ="",main= "2 components",ylim = c(0,21))
for (i in 1:ncol(series_t)) {
  lines(1:nrow(series_t),series_t[,i],type = "l",col="gray")
}
lines(1:14,L2_1.1,"l",col="red")
lines(1:14,L2_2.1,"l",col="green")
lines(1:14,L2_1.2,"l",col="red")
lines(1:14,L2_2.2,"l",col="green")
lines(1:14,L2_1.3,"l",col="red")
lines(1:14,L2_2.3,"l",col="green")
lines(1:14,L2_1.4,"l",col="red")
lines(1:14,L2_2.4,"l",col="green")

plot(1:nrow(series_t),series_t[,1],type = "l",col="gray",xlab = "Time",ylab ="",main= "3 components",ylim = c(0,21))
for (i in 1:ncol(series_t)) {
  lines(1:nrow(series_t),series_t[,i],type = "l",col="gray")
}
lines(1:14,L3_1.1,"l",col="red")
lines(1:14,L3_2.1,"l",col="green")
lines(1:14,L3_3.1,"l",col="blue")
lines(1:14,L3_1.2,"l",col="red")
lines(1:14,L3_2.2,"l",col="green")
lines(1:14,L3_3.2,"l",col="blue")
lines(1:14,L3_1.3,"l",col="red")
lines(1:14,L3_2.3,"l",col="green")
lines(1:14,L3_3.3,"l",col="blue")
lines(1:14,L3_1.4,"l",col="red")
lines(1:14,L3_2.4,"l",col="green")
lines(1:14,L3_3.4,"l",col="blue")

plot(1:nrow(series_t),series_t[,1],type = "l",col="gray",xlab = "Time",ylab ="",main= "4 components",ylim = c(0,21))
for (i in 1:ncol(series_t)) {
  lines(1:nrow(series_t),series_t[,i],type = "l",col="gray")
}
lines(1:14,L4_1.1,"l",col="red")
lines(1:14,L4_2.1,"l",col="green")
lines(1:14,L4_3.1,"l",col="blue")
lines(1:14,L4_4.1,"l",col="purple")
lines(1:14,L4_1.2,"l",col="red")
lines(1:14,L4_2.2,"l",col="green")
lines(1:14,L4_3.2,"l",col="blue")
lines(1:14,L4_4.2,"l",col="purple")
lines(1:14,L4_1.3,"l",col="red")
lines(1:14,L4_2.3,"l",col="green")
lines(1:14,L4_3.3,"l",col="blue")
lines(1:14,L4_4.3,"l",col="purple")
lines(1:14,L4_1.4,"l",col="red")
lines(1:14,L4_2.4,"l",col="green")
lines(1:14,L4_3.4,"l",col="blue")
lines(1:14,L4_4.4,"l",col="purple")

plot(1:nrow(series_t),series_t[,1],type = "l",col="gray",xlab = "Time",ylab ="",main= "5 components",ylim = c(0,21))
for (i in 1:ncol(series_t)) {
  lines(1:nrow(series_t),series_t[,i],type = "l",col="gray")
}
lines(1:14,L5_1.1,"l",col="red")
lines(1:14,L5_2.1,"l",col="green")
lines(1:14,L5_3.1,"l",col="blue")
lines(1:14,L5_4.1,"l",col="purple")
lines(1:14,L5_5.1,"l",col="blueviolet")
lines(1:14,L5_1.2,"l",col="red")
lines(1:14,L5_2.2,"l",col="green")
lines(1:14,L5_3.2,"l",col="blue")
lines(1:14,L5_4.2,"l",col="purple")
lines(1:14,L5_5.2,"l",col="blueviolet")
lines(1:14,L5_1.3,"l",col="red")
lines(1:14,L5_2.3,"l",col="green")
lines(1:14,L5_3.3,"l",col="blue")
lines(1:14,L5_4.3,"l",col="purple")
lines(1:14,L5_5.3,"l",col="blueviolet")
lines(1:14,L5_1.4,"l",col="red")
lines(1:14,L5_2.4,"l",col="green")
lines(1:14,L5_3.4,"l",col="blue")
lines(1:14,L5_4.4,"l",col="purple")
lines(1:14,L5_5.4,"l",col="blueviolet")

dev.off()
```


## Stability (Random seeds in R), Sample of 3000

```{r,eval=FALSE,include=TRUE}
#set.seed(12345)
#mean_scale2.2_log2_t2_sample3 <- sample(1:15927,3000)
#mean_scale2.2_log2_t2_s3 <- mean_scale2.2_log2_t2[mean_scale2.2_log2_t2_sample3,]
#log2_data_mean2.6.2.3.3 <-list(K=3000, T=14, z= mean_scale2.2_log2_t2_s3, sigma_y=sm_prior_pois8[c(1,3,4,5,6)], a=-1,b=20)

#calculate models in parallel
#https://discourse.mc-stan.org/t/run-multiple-stan-models-in-parallel/15885/4

#samplingfunction<-function(x){
#  if (x==1) res<-rstan::sampling(model1,data=standata,cores=4,thin = 1, iter = 10000, chains = 1, control = list(adapt_delta=0.9))
#  else if (x==2) res<-rstan::sampling(model2,data=standata,cores=4,thin = 1, iter = 10000, chains = 1, control = list(adapt_delta=0.9))
#  else if (x==3) res<-rstan::sampling(model3,data=standata,cores=4,thin = 1, iter = 10000, chains = 1, control = list(adapt_delta=0.9))
#  else if (x==4) res<-rstan::sampling(model4,data=standata,cores=4,thin = 1, iter = 10000, chains = 1, control = list(adapt_delta=0.9))
#  else if (x==5) res<-rstan::sampling(model5,data=standata,cores=4,thin = 1, iter = 10000, chains = 1, control = list(adapt_delta=0.9))
#}

#samplingfunction<-function(x){
#  if (x==1) res<-rstan::sampling(model_va5_3,data=log2_data_mean2.6.2.3,cores=4,thin = 1, iter = 10000, chains = 1, control = list(adapt_delta=0.9))
#  else if (x==2) res<-rstan::sampling(model_va5_3,data=log2_data_mean2.6.2.3,cores=4,thin = 1, iter = 10000, chains = 1, control = list(adapt_delta=0.9))
#  else if (x==3) res<-rstan::sampling(model_va5_3,data=log2_data_mean2.6.2.3,cores=4,thin = 1, iter = 10000, chains = 1, control = list(adapt_delta=0.9))
#  else if (x==4) res<-rstan::sampling(model_va5_3,data=log2_data_mean2.6.2.3,cores=4,thin = 1, iter = 10000, chains = 1, control = list(adapt_delta=0.9))
#  else if (x==5) res<-rstan::sampling(model_va5_3,data=log2_data_mean2.6.2.3,cores=4,thin = 1, iter = 10000, chains = 1, control = list(adapt_delta=0.9))
#}

#cl <- parallel::makeCluster(20)
#parallel::clusterExport(cl,c('model1','model2','model3','model4','model5','standata'))
#out2 <- parallel::parLapply(cl, c(1:5),samplingfunction)

#model1 <- rstan::stan_model(model_va5_3)
#model2 <- rstan::stan_model(model_va5_3)
#model3 <- rstan::stan_model(model_va5_3)
#model4 <- rstan::stan_model(model_va5_3)
#model5 <- rstan::stan_model(model_va5_3)
#standata <- log2_data_mean2.6.2.3
```

```{r,eval=FALSE,include=TRUE}
png(file ="./figures/figure4-23.png",width = 1440,height = 960 )
par(mfrow=c(2,3))

out_means1 <- apply(as.matrix(out2[[1]]), 2, median)
out_means2 <- apply(as.matrix(out2[[2]]), 2, median)
out_means3 <- apply(as.matrix(out2[[3]]), 2, median)
out_means4 <- apply(as.matrix(out2[[4]]), 2, median)
out_means5 <- apply(as.matrix(out2[[5]]), 2, median)

l1 <- paste('l[1,',1:14,']',sep='')
l2 <- paste('l[2,',1:14,']',sep='')
l3 <- paste('l[3,',1:14,']',sep='')
l4 <- paste('l[4,',1:14,']',sep='')
l5 <- paste('l[5,',1:14,']',sep='')

l1.m1 <- out_means1[l1];l1.m1
l2.m1 <- out_means1[l2];l2.m1
l3.m1 <- out_means1[l3];l3.m1
l4.m1 <- out_means1[l4];l4.m1
l5.m1 <- out_means1[l5];l5.m1

l1.m2 <- out_means2[l1];l1.m2
l2.m2 <- out_means2[l2];l2.m2
l3.m2 <- out_means2[l3];l3.m2
l4.m2 <- out_means2[l4];l4.m2
l5.m2 <- out_means2[l5];l5.m2

l1.m3 <- out_means3[l1];l1.m3
l2.m3 <- out_means3[l2];l2.m3
l3.m3 <- out_means3[l3];l3.m3
l4.m3 <- out_means3[l4];l4.m3
l5.m3 <- out_means3[l5];l5.m3

l1.m4 <- out_means4[l1];l1.m4
l2.m4 <- out_means4[l2];l2.m4
l3.m4 <- out_means4[l3];l3.m4
l4.m4 <- out_means4[l4];l4.m4
l5.m4 <- out_means4[l5];l5.m4

l1.m5 <- out_means5[l1];l1.m5
l2.m5 <- out_means5[l2];l2.m5
l3.m5 <- out_means5[l3];l3.m5
l4.m5 <- out_means5[l4];l4.m5
l5.m5 <- out_means5[l5];l5.m5

five_run_summary_l1 <- data.frame(l1.m1,l2.m1,l3.m1,l4.m1,l5.m1,l1.m2,l2.m2,l3.m2,l4.m2,l5.m2,l1.m3,l2.m3,l3.m3,l4.m3,l5.m3,l1.m4,l2.m4,l3.m4,l4.m4,l5.m4,l1.m5,l2.m5,l3.m5,l4.m5,l5.m5)
#ts.plot((five_run_summary_l1))
l1_order <- order(five_run_summary_l1[1,])

theta <- paste('theta[',1:5,']',sep='')

run_summary_l1 <- data.frame(l1.m1,l2.m1,l3.m1,l4.m1,l5.m1)
run_summary_l1_order <- order(run_summary_l1[1,])
theta1 <- paste('theta[',run_summary_l1_order,']',sep='')

run_summary_l2 <- data.frame(l1.m2,l2.m2,l3.m2,l4.m2,l5.m2)
run_summary_l2_order <- order(run_summary_l2[1,])
theta2 <- paste('theta[',run_summary_l2_order,']',sep='')

run_summary_l3 <- data.frame(l1.m3,l2.m3,l3.m3,l4.m3,l5.m3)
run_summary_l3_order <- order(run_summary_l3[1,])
theta3 <- paste('theta[',run_summary_l3_order,']',sep='')

run_summary_l4 <- data.frame(l1.m4,l2.m4,l3.m4,l4.m4,l5.m4)
run_summary_l4_order <- order(run_summary_l4[1,])
theta4 <- paste('theta[',run_summary_l4_order,']',sep='')

run_summary_l5 <- data.frame(l1.m5,l2.m5,l3.m5,l4.m5,l5.m5)
run_summary_l5_order <- order(run_summary_l5[1,])
theta5 <- paste('theta[',run_summary_l5_order,']',sep='')


five_run_summary_theta_ordered <- data.frame(out_means1[theta1],out_means2[theta2],out_means3[theta3],out_means4[theta4],out_means5[theta5])

ts.plot(five_run_summary_theta_ordered,main="Theta",xlab="Component")

ts.plot(five_run_summary_l1[l1_order[1:5]],main="Center 1")
ts.plot(five_run_summary_l1[l1_order[6:10]],main="Center 2")
ts.plot(five_run_summary_l1[l1_order[11:15]],main="Center 3")
ts.plot(five_run_summary_l1[l1_order[16:20]],main="Center 4")
ts.plot(five_run_summary_l1[l1_order[21:25]],main="Center 5")

dev.off()
```

## Model examples: fast and slow implementations

```{stan, output.var="ex1"}
data {
  int<lower=0> K; 
  int<lower=0> T; 
  matrix[K, T] z; 
  real<lower=0> sigma_y[5]; 
  real a;
  real b;
}
parameters {
  array[2] real<lower=0, upper=20> epsilon; 
  simplex[2] theta; 
  array[2] vector[T] l; 
  simplex[3] cht;
}
transformed parameters {
  vector[2] log_theta;
  ordered[2] l_init;
  
  log_theta = log(theta);
  l_init = a + head(cumulative_sum(cht), 2) * (b - a); //https://groups.google.com/g/stan-users/c/04GSu-ql3vM
}
model {
   array[K] vector[2] ps; 
  l_init ~ normal(10,6);
  
  for (h in 1:2){
    epsilon[h] ~ inv_gamma(1,1);
  }
  
  for (h in 1:2){
    l[h,1] ~ normal(l_init[h],sigma_y[h]);
    for (t in 2:T){
      l[h,t] ~ normal(l[h,(t-1)],sigma_y[h]);
    }
  }
  
  for (k in 1:K) {
    for (h in 1:2){
      ps[k][h] = normal_lpdf(z[k,:] | l[h,:],epsilon[h]); 
    }
  }
  target += log_mix(theta,ps);
}
generated quantities {
  real logModel;
  vector[2] log_theta2 = log_theta;
  
  for (k in 1 : K) {
    for (h in 1 : 2) 
      log_theta2[h] = log_theta2[h] + normal_lpdf(z[ k , :] | l[h,  : ], epsilon[h]);
   } 
 logModel = log_sum_exp(log_theta2);   

for (h in 1 : 2){ 
logModel += inv_gamma_lpdf(epsilon[h] | 1, 1)
                      + normal_lpdf(l_init[h] | 10, 6)
                      + normal_lpdf(l[h, 1] | l_init[h], sigma_y[h])
                      + normal_lpdf(l[h, 2 : T] | l[h, 1 : (T - 1)], sigma_y[h]);
    
  }
}
```

```{stan, output.var="ex1"}
data {
  int<lower=0> K; 
  int<lower=0> T; 
  matrix[K, T] z; 
  real<lower=0> sigma_y[5];  
  real a;
  real b;
}
parameters {
  array[2] real<lower=0, upper=20> epsilon; 
  simplex[2] theta; 
  array[2] vector[T] l; 
  simplex[3] cht;
}
transformed parameters {
  vector[2] log_theta;
  ordered[2] l_init;
  
  log_theta = log(theta);
  l_init = a + head(cumulative_sum(cht), 2) * (b - a); //https://groups.google.com/g/stan-users/c/04GSu-ql3vM
}
model {
  vector[2] lp; 
  for (k in 1 : K) {
    lp = log_theta;
    for (h in 1 : 2) 
      lp[h] += normal_lpdf(z[k,  : ] | l[h,  : ], epsilon[h]);
    target += log_sum_exp(lp);
    for (h in 1 : 2) 
      target += inv_gamma_lpdf(epsilon[h] | 1, 1)
                + normal_lpdf(l_init[h] | 10, 6)
                + normal_lpdf(l[h, 1] | l_init[h], sigma_y[h])
                + normal_lpdf(l[h, 2 : T] | l[h, 1 : (T - 1)], sigma_y[h]);
  }
}
generated quantities {
  real logModel;
  vector[2] log_theta2 = log_theta;
  
  for (k in 1 : K) {
    for (h in 1 : 2) 
      log_theta2[h] = log_theta2[h] + normal_lpdf(z[ k , :] | l[h,  : ], epsilon[h]);
   } 
 logModel = log_sum_exp(log_theta2);   

for (h in 1 : 2){ 
logModel += inv_gamma_lpdf(epsilon[h] | 1, 1)
                      + normal_lpdf(l_init[h] | 10, 6)
                      + normal_lpdf(l[h, 1] | l_init[h], sigma_y[h])
                      + normal_lpdf(l[h, 2 : T] | l[h, 1 : (T - 1)], sigma_y[h]);
    
  }
}
```



